{"version":3,"file":"link_animations.js","sources":["../src/effects/link-effects.ts","../src/utils/geometry.ts","../src/extensions/link-animations.ts"],"sourcesContent":["/**\n * Link animation effects for flow visualization.\n * These create visual flow indicators along link paths.\n *\n * @module effects/link-effects\n */\n\nimport type { Point, Color } from '@/core/types';\nimport { PHI, SACRED } from '@/core/config';\nimport { withAlpha, hexToRgb } from '@/utils/colors';\n\n// =============================================================================\n// Helpers\n// =============================================================================\n\ntype RgbColor = { r: number; g: number; b: number };\n\nfunction getRgb(color: Color): RgbColor | null {\n    if (typeof color === 'string' && color.startsWith('#')) {\n        return hexToRgb(color);\n    }\n    return null;\n}\n\nfunction fastAlpha(rgb: RgbColor | null, color: Color, alpha: number): string {\n    if (rgb) {\n        return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${Math.max(0, Math.min(1, alpha))})`;\n    }\n    return withAlpha(color, alpha);\n}\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/** Parameters for link animation rendering */\nexport interface LinkAnimationParams {\n    /** Current animation phase */\n    phase: number;\n    /** Animation quality (1-3) */\n    quality: number;\n    /** Glow intensity (0-1) */\n    glowIntensity: number;\n    /** Particle density (0-2) */\n    particleDensity: number;\n    /** Animation direction (1 or -1) */\n    direction: number;\n    /** Whether in static mode */\n    isStatic: boolean;\n}\n\n/** Link point with additional animation data */\nexport interface AnimatedLinkPoint {\n    x: number;\n    y: number;\n    t: number;\n    alpha: number;\n}\n\n// =============================================================================\n// Flow Effect Calculations\n// =============================================================================\n\n/**\n * Calculate flow positions along a link.\n *\n * @param linkLength - Total length of the link\n * @param phase - Current animation phase\n * @param density - Marker density\n * @param direction - Flow direction\n * @returns Array of t values (0-1) for marker positions\n */\nexport function calculateFlowPositions(\n    linkLength: number,\n    phase: number,\n    density: number,\n    direction: number\n): number[] {\n    const spacing = Math.max(30, 60 - density * 20);\n    const markerCount = Math.max(1, Math.floor(linkLength / spacing));\n    const positions: number[] = [];\n\n    for (let i = 0; i < markerCount; i++) {\n        const baseT = i / markerCount;\n        const animOffset = (phase * direction * 0.1) % 1;\n        let t = (baseT + animOffset) % 1;\n        if (t < 0) t += 1;\n        positions.push(t);\n    }\n\n    return positions;\n}\n\n/**\n * Calculate wave offset for organic flow movement.\n */\nexport function calculateWaveOffset(\n    t: number,\n    phase: number,\n    intensity: number,\n    isStatic: boolean\n): number {\n    if (isStatic) return 0;\n    return Math.sin(t * Math.PI * SACRED.TRINITY + phase) * intensity;\n}\n\n/**\n * Calculate pulse effect for markers.\n */\nexport function calculatePulseEffect(\n    t: number,\n    phase: number,\n    quality: number\n): number {\n    const pulseSpeed = 2 + quality * 0.5;\n    return 0.8 + 0.2 * Math.sin(t * Math.PI * 2 + phase * pulseSpeed);\n}\n\n// =============================================================================\n// Drawing Functions\n// =============================================================================\n\n/**\n * Draw a flow marker at a position.\n */\nexport function drawFlowMarker(\n    ctx: CanvasRenderingContext2D,\n    x: number,\n    y: number,\n    angle: number,\n    size: number,\n    color: Color,\n    alpha: number,\n    glowIntensity: number,\n    rgb?: RgbColor | null\n): void {\n    ctx.save();\n    ctx.translate(x, y);\n    ctx.rotate(angle);\n\n    // Glow effect\n    if (glowIntensity > 0) {\n        ctx.shadowColor = color;\n        ctx.shadowBlur = 5 * glowIntensity;\n    }\n\n    // Draw arrow marker\n    ctx.beginPath();\n    ctx.moveTo(size, 0);\n    ctx.lineTo(-size, size * 0.7);\n    ctx.lineTo(-size * 0.4, 0);\n    ctx.lineTo(-size, -size * 0.7);\n    ctx.closePath();\n\n    ctx.fillStyle = fastAlpha(rgb || null, color, alpha);\n    ctx.fill();\n\n    ctx.restore();\n}\n\n/**\n * Draw energy particles along a link.\n */\nexport function drawEnergyParticles(\n    ctx: CanvasRenderingContext2D,\n    getPoint: (t: number) => Point,\n    params: LinkAnimationParams,\n    primaryColor: Color,\n    secondaryColor: Color\n): void {\n    const { phase, quality, particleDensity, direction, isStatic } = params;\n    const particleCount = Math.floor(3 + quality * 2 * particleDensity);\n\n    const primaryRgb = getRgb(primaryColor);\n    const secondaryRgb = getRgb(secondaryColor);\n\n    for (let i = 0; i < particleCount; i++) {\n        const baseT = i / particleCount;\n        const offset = isStatic ? 0 : (phase * direction * 0.15 + i * 0.1) % 1;\n        let t = (baseT + offset) % 1;\n        if (t < 0) t += 1;\n\n        const point = getPoint(t);\n        const size = 2 + quality + Math.sin(phase * 2 + i) * 1;\n        const alpha = 0.6 + 0.4 * Math.sin(phase * 3 + i * PHI);\n\n        // Particle gradient\n        const gradient = ctx.createRadialGradient(\n            point[0],\n            point[1],\n            0,\n            point[0],\n            point[1],\n            size * 2\n        );\n        gradient.addColorStop(0, fastAlpha(primaryRgb, primaryColor, alpha));\n        gradient.addColorStop(0.5, fastAlpha(secondaryRgb, secondaryColor, alpha * 0.5));\n        gradient.addColorStop(1, fastAlpha(secondaryRgb, secondaryColor, 0));\n\n        ctx.beginPath();\n        ctx.arc(point[0], point[1], size * 2, 0, Math.PI * 2);\n        ctx.fillStyle = gradient;\n        ctx.fill();\n\n        // Core\n        ctx.beginPath();\n        ctx.arc(point[0], point[1], size * 0.5, 0, Math.PI * 2);\n        ctx.fillStyle = fastAlpha(primaryRgb, primaryColor, Math.min(alpha * 1.5, 1));\n        ctx.fill();\n    }\n}\n\n/**\n * Draw a glowing trail effect along a link.\n */\nexport function drawGlowTrail(\n    ctx: CanvasRenderingContext2D,\n    getPoint: (t: number) => Point,\n    params: LinkAnimationParams,\n    color: Color,\n    thickness: number\n): void {\n    const { phase, glowIntensity, direction, isStatic } = params;\n    const segments = 20;\n    const trailLength = 0.3;\n    const trailStart = isStatic ? 0.35 : ((phase * direction * 0.1) % 1);\n\n    ctx.save();\n    ctx.shadowColor = color;\n    ctx.shadowBlur = 8 * glowIntensity;\n\n    ctx.beginPath();\n    for (let i = 0; i <= segments; i++) {\n        const segmentT = i / segments;\n        let t = trailStart + segmentT * trailLength;\n        if (t > 1) t -= 1;\n\n        const point = getPoint(t);\n\n        if (i === 0) {\n            ctx.moveTo(point[0], point[1]);\n        } else {\n            ctx.lineTo(point[0], point[1]);\n        }\n    }\n\n    ctx.strokeStyle = withAlpha(color, 0.7);\n    ctx.lineWidth = thickness;\n    ctx.stroke();\n    ctx.restore();\n}\n\n// =============================================================================\n// Animation Style Functions\n// =============================================================================\n\n/**\n * Classic Flow animation - smooth flowing markers.\n */\nexport function classicFlowAnimation(\n    ctx: CanvasRenderingContext2D,\n    getPoint: (t: number) => Point,\n    getAngle: (t: number) => number,\n    linkLength: number,\n    params: LinkAnimationParams,\n    color: Color,\n    markerSize: number\n): void {\n    const positions = calculateFlowPositions(\n        linkLength,\n        params.phase,\n        params.particleDensity,\n        params.direction\n    );\n\n    const rgb = getRgb(color);\n\n    for (const t of positions) {\n        const point = getPoint(t);\n        const angle = getAngle(t);\n        const pulse = calculatePulseEffect(t, params.phase, params.quality);\n        const alpha = 0.7 + 0.3 * pulse;\n\n        drawFlowMarker(\n            ctx,\n            point[0],\n            point[1],\n            angle,\n            markerSize * pulse,\n            color,\n            alpha,\n            params.glowIntensity,\n            rgb\n        );\n    }\n}\n\n/**\n * Energy Surge animation - pulsing energy particles.\n */\nexport function energySurgeAnimation(\n    ctx: CanvasRenderingContext2D,\n    getPoint: (t: number) => Point,\n    params: LinkAnimationParams,\n    primaryColor: Color,\n    secondaryColor: Color\n): void {\n    drawEnergyParticles(ctx, getPoint, params, primaryColor, secondaryColor);\n}\n\n/**\n * Quantum Flow animation - abstract quantum-inspired visuals.\n */\nexport function quantumFlowAnimation(\n    ctx: CanvasRenderingContext2D,\n    getPoint: (t: number) => Point,\n    params: LinkAnimationParams,\n    color: Color,\n    thickness: number\n): void {\n    drawGlowTrail(ctx, getPoint, params, color, thickness);\n    drawEnergyParticles(ctx, getPoint, params, color, color);\n}\n\n// =============================================================================\n// Exports\n// =============================================================================\n\nexport const LinkEffects = {\n    classicFlow: classicFlowAnimation,\n    energySurge: energySurgeAnimation,\n    quantumFlow: quantumFlowAnimation,\n};\n","import type { Point } from '@/core/types';\n\n/**\n * Computes a point on a cubic Bezier curve at t.\n * Writes to the provided buffer or returns a new array if none provided.\n *\n * @param t Interpolation factor (0-1)\n * @param x1 Start X\n * @param y1 Start Y\n * @param cp1x Control Point 1 X\n * @param cp1y Control Point 1 Y\n * @param cp2x Control Point 2 X\n * @param cp2y Control Point 2 Y\n * @param x2 End X\n * @param y2 End Y\n * @param out Optional buffer to write result to\n */\nexport function computeBezierPoint(\n    t: number,\n    x1: number, y1: number,\n    cp1x: number, cp1y: number,\n    cp2x: number, cp2y: number,\n    x2: number, y2: number,\n    out?: Point\n): Point {\n    const invT = 1 - t;\n    const invT2 = invT * invT;\n    const invT3 = invT2 * invT;\n    const t2 = t * t;\n    const t3 = t2 * t;\n\n    const x = invT3 * x1 + 3 * invT2 * t * cp1x + 3 * invT * t2 * cp2x + t3 * x2;\n    const y = invT3 * y1 + 3 * invT2 * t * cp1y + 3 * invT * t2 * cp2y + t3 * y2;\n\n    if (out) {\n        out[0] = x;\n        out[1] = y;\n        return out;\n    }\n    return [x, y];\n}\n\n/**\n * Computes the angle (tangent) of a cubic Bezier curve at t.\n * Uses analytical derivative for performance and precision.\n */\nexport function computeBezierAngle(\n    t: number,\n    x1: number, y1: number,\n    cp1x: number, cp1y: number,\n    cp2x: number, cp2y: number,\n    x2: number, y2: number\n): number {\n    // Cubic Bezier Derivative:\n    // P'(t) = 3(1-t)^2(P1-P0) + 6(1-t)t(P2-P1) + 3t^2(P3-P2)\n\n    const invT = 1 - t;\n    const A = 3 * invT * invT;\n    const B = 6 * invT * t;\n    const C = 3 * t * t;\n\n    const dx = A * (cp1x - x1) + B * (cp2x - cp1x) + C * (x2 - cp2x);\n    const dy = A * (cp1y - y1) + B * (cp2y - cp1y) + C * (y2 - cp2y);\n\n    return Math.atan2(dy, dx);\n}\n","/// <reference path=\"../comfy.d.ts\" />\n/**\n * ComfyUI Enhanced Link Animations Extension\n *\n * This extension enhances the visual representation of links (connections) between nodes\n * by adding configurable animations such as flowing particles, energy pulses, and glow effects.\n *\n * @module extensions/link-animations\n */\n\nimport { app } from '/scripts/app.js';\nimport {\n    createLinkState,\n    createTimingManager,\n    LINK_DEFAULTS,\n    type LinkState,\n    type ComfyExtension,\n    type ComfyApp,\n    type LinkAnimationParams,\n    type Color,\n    type Point,\n} from '@/core';\nimport { LinkEffects } from '@/effects/link-effects';\nimport { createPatternDesignerWindow, computeBezierPoint, computeBezierAngle } from '@/utils';\n\n// =============================================================================\n// Shared Resources\n// =============================================================================\n\n// Shared buffer to avoid allocation during Bezier curve calculations\n// This avoids creating thousands of small arrays per frame in the render loop\nconst SHARED_POINT_BUFFER: Point = [0, 0];\n\n// =============================================================================\n// Settings Management\n// =============================================================================\n\nconst SETTINGS_UPDATE_INTERVAL = 500;\n\n/**\n * Cache for extension settings to avoid repeated costly lookups during the render loop.\n * The cache is updated throttled in the render loop.\n */\ninterface CachedSettings {\n    // Animation Control\n    animate: number;\n    speed: number;\n    direction: number;\n    pauseDuringRender: boolean;\n\n    // Visual Style\n    intensity: number;\n    quality: number;\n    particleDensity: number;\n    isStatic: boolean;\n\n    // Markers\n    markerEnabled: boolean;\n    markerSize: number;\n\n    // Cache State\n    lastUpdate: number;\n}\n\n// Initialize with defaults.\n// lastUpdate is set to a negative value to force an immediate update on first frame.\nconst settingsCache: CachedSettings = {\n    animate: LINK_DEFAULTS['ðŸ”— Enhanced Links.Animate'],\n    speed: LINK_DEFAULTS['ðŸ”— Enhanced Links.Animation.Speed'],\n    direction: LINK_DEFAULTS['ðŸ”— Enhanced Links.Direction'],\n    pauseDuringRender: LINK_DEFAULTS['ðŸ”— Enhanced Links.Pause.During.Render'],\n    intensity: LINK_DEFAULTS['ðŸ”— Enhanced Links.Glow.Intensity'],\n    quality: LINK_DEFAULTS['ðŸ”— Enhanced Links.Quality'],\n    particleDensity: LINK_DEFAULTS['ðŸ”— Enhanced Links.Particle.Density'],\n    isStatic: LINK_DEFAULTS['ðŸ”— Enhanced Links.Static.Mode'],\n    markerEnabled: LINK_DEFAULTS['ðŸ”— Enhanced Links.Marker.Enabled'],\n    markerSize: LINK_DEFAULTS['ðŸ”— Enhanced Links.Marker.Size'],\n    lastUpdate: -SETTINGS_UPDATE_INTERVAL // Start ready to update\n};\n\n/**\n * Retrieves a setting value with a fallback to the default.\n */\nfunction getSetting<T>(name: string): T {\n    const defaultValue = LINK_DEFAULTS[name as keyof typeof LINK_DEFAULTS];\n    return app.ui.settings.getSettingValue(name, defaultValue) as T;\n}\n\n/**\n * Updates the settings cache from the app settings.\n * This should be called periodically (e.g. every 500ms).\n */\nfunction updateSettingsCache(timestamp: number) {\n    // Update throttle\n    if (timestamp - settingsCache.lastUpdate < SETTINGS_UPDATE_INTERVAL) return;\n\n    settingsCache.animate = getSetting<number>('ðŸ”— Enhanced Links.Animate');\n    settingsCache.speed = getSetting<number>('ðŸ”— Enhanced Links.Animation.Speed');\n    settingsCache.direction = getSetting<number>('ðŸ”— Enhanced Links.Direction');\n    settingsCache.pauseDuringRender = getSetting<boolean>('ðŸ”— Enhanced Links.Pause.During.Render');\n\n    settingsCache.intensity = getSetting<number>('ðŸ”— Enhanced Links.Glow.Intensity');\n    settingsCache.quality = getSetting<number>('ðŸ”— Enhanced Links.Quality');\n    settingsCache.particleDensity = getSetting<number>('ðŸ”— Enhanced Links.Particle.Density');\n    settingsCache.isStatic = getSetting<boolean>('ðŸ”— Enhanced Links.Static.Mode');\n    settingsCache.markerEnabled = getSetting<boolean>('ðŸ”— Enhanced Links.Marker.Enabled');\n    settingsCache.markerSize = getSetting<number>('ðŸ”— Enhanced Links.Marker.Size');\n\n    settingsCache.lastUpdate = timestamp;\n}\n\n// =============================================================================\n// Extension Implementation\n// =============================================================================\n\nconst ext: ComfyExtension = {\n    name: 'enhanced.link.animations',\n\n    async setup(app: ComfyApp) {\n        // Initialize State\n        const state: LinkState = createLinkState();\n        const timing = createTimingManager();\n\n        /**\n         * Main render loop for animations.\n         * Driven by the timing manager's RAF loop.\n         */\n        function renderLoop(timestamp: number) {\n            // Update timing\n            timing.update(timestamp);\n\n            // Update settings cache (throttled)\n            updateSettingsCache(timestamp);\n\n            // Check if animations should be active\n            const isEnabled = settingsCache.animate > 0;\n            const pauseDuringRender = settingsCache.pauseDuringRender;\n            const isRendering = app.graph && (app.graph as any).is_rendering; // Accessing internal property\n\n            if (!isEnabled || (isRendering && pauseDuringRender)) {\n                if (state.isRunning) {\n                    state.isRunning = false;\n                    // Force one last redraw to clear/reset state if needed\n                    app.graph?.setDirtyCanvas(true, true);\n                }\n                requestAnimationFrame(renderLoop);\n                return;\n            }\n\n            state.isRunning = true;\n\n            // Calculate delta time and phase\n            const speed = settingsCache.speed;\n            const direction = settingsCache.direction;\n            const dt = (timestamp - state.lastFrame) / 1000;\n            state.lastFrame = timestamp;\n\n            // Update phase\n            state.phase += dt * speed * direction;\n\n            // Force redraw of canvas to trigger drawLink overrides\n            // We use setDirtyCanvas(true, false) to redraw canvas but not recompute execution order\n            app.graph?.setDirtyCanvas(true, false);\n\n            requestAnimationFrame(renderLoop);\n        }\n\n        // Start the loop\n        requestAnimationFrame(renderLoop);\n\n        /**\n         * Overridden drawLink method to inject our custom rendering.\n         * This wraps the original LiteGraph execution.\n         */\n        const originalDrawLink = LGraphCanvas.prototype.drawLink;\n\n        LGraphCanvas.prototype.drawLink = function (\n            link_id: number,\n            ctx: CanvasRenderingContext2D,\n            x1: number,\n            y1: number,\n            x2: number,\n            y2: number,\n            link_index: number,\n            skip_border: boolean,\n            fillStyle: string,\n            strokeStyle: string,\n            lineWidth: number\n        ) {\n            // Call original to draw the base wire\n            // We might want to customize this later to hide the base wire if needed,\n            // but for now, we draw on top of it.\n            originalDrawLink.call(\n                this,\n                link_id,\n                ctx,\n                x1,\n                y1,\n                x2,\n                y2,\n                link_index,\n                skip_border,\n                fillStyle,\n                strokeStyle,\n                lineWidth\n            );\n\n            // Skip if animations disabled\n            const animStyle = settingsCache.animate;\n            if (animStyle === 0) return;\n\n            // Get Settings from Cache\n            const intensity = settingsCache.intensity;\n            const quality = settingsCache.quality;\n            const particleDensity = settingsCache.particleDensity;\n            const direction = settingsCache.direction;\n            const isStatic = settingsCache.isStatic;\n            const markerEnabled = settingsCache.markerEnabled;\n            const markerSize = settingsCache.markerSize;\n\n            // Colors\n            // In a real implementation we would parse the strokeStyle or use our palette settings\n            // For now, let's derive from strokeStyle if possible, or use a default\n            // This is a simplification; the full version parses the hex/canvas color\n            const color: Color = strokeStyle as any || '#ffffff'; // Fallback\n\n            // Prepare animation params\n            const params: LinkAnimationParams = {\n                phase: state.phase,\n                quality,\n                glowIntensity: intensity / 10,\n                particleDensity,\n                direction,\n                isStatic\n            };\n\n            // Calculate Path (Simplified for now - assumes Bezier as LiteGraph default)\n            // Ideally we should use the same path calculation as LiteGraph\n            // LiteGraph typically uses bezier curves for links\n\n            // Helper to sample the bezier curve\n            // P(t) = (1-t)^3 P0 + 3(1-t)^2 t P1 + 3(1-t) t^2 P2 + t^3 P3\n            const dist = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));\n\n            // LiteGraph uses this heuristic for control points\n            const cp_dist = dist * 0.25;\n            const cp1x = x1 + cp_dist;\n            const cp1y = y1;\n            const cp2x = x2 - cp_dist;\n            const cp2y = y2;\n\n            const getPoint = (t: number) => {\n                // WARNING: Returns shared buffer, do not store reference!\n                return computeBezierPoint(t, x1, y1, cp1x, cp1y, cp2x, cp2y, x2, y2, SHARED_POINT_BUFFER);\n            };\n\n            const getAngle = (t: number) => {\n                return computeBezierAngle(t, x1, y1, cp1x, cp1y, cp2x, cp2y, x2, y2);\n            };\n\n            // Render based on selected animation style\n            // 9 = Classic Flow (default map)\n            // This mapping should ideally come from a config/enum\n\n            ctx.save();\n\n            // Ensure we're drawing on top\n            // ctx.globalCompositeOperation = 'screen'; // Optional: for glowy look\n\n            if (animStyle === 9) { // Classic Flow\n                LinkEffects.classicFlow(\n                    ctx,\n                    getPoint,\n                    getAngle,\n                    dist,\n                    params,\n                    color,\n                    markerEnabled ? markerSize : 0\n                );\n            } else if (animStyle === 8) { // Energy Surge\n                LinkEffects.energySurge(\n                    ctx,\n                    getPoint,\n                    params,\n                    color,\n                    '#ffffff' // Secondary color placeholder\n                );\n            } else if (animStyle === 7) { // Quantum Flow\n                LinkEffects.quantumFlow(\n                    ctx,\n                    getPoint,\n                    params,\n                    color,\n                    lineWidth\n                );\n            }\n\n            ctx.restore();\n        };\n\n        // UI & Ã†motion Studio About\n        app.ui.settings.addSetting({\n            id: 'ðŸ”— Enhanced Links.UI & Ã†motion Studio About',\n            name: 'ðŸ”½ Info Panel',\n            type: 'combo',\n            options: [\n                { value: 0, text: 'Closed Panel' },\n                { value: 1, text: 'Open Panel' }\n            ],\n            defaultValue: LINK_DEFAULTS['ðŸ”— Enhanced Links.UI & Ã†motion Studio About'],\n            onChange: (value: number) => {\n                if (value === 1) {\n                    document.body.appendChild(createPatternDesignerWindow());\n                    // Reset setting back to 0 (Closed) after opening\n                    setTimeout(() => app.ui.settings.setSettingValue('ðŸ”— Enhanced Links.UI & Ã†motion Studio About', 0), 100);\n                }\n            }\n        });\n\n        console.log('[EnhancedLinks] Extension registered and ready.');\n    },\n};\n\napp.registerExtension(ext);\n"],"names":["app"],"mappings":"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"}