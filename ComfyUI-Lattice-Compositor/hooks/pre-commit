#!/usr/bin/env bash
set -euo pipefail

# Straylight Protocol Enforcement - Pre-commit Hook
# This hook validates code against Straylight Protocol rules before allowing commits

echo "üîç Running Straylight Protocol validation..."

# Find project root (where scripts/validate-file.js exists)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Find validate-file.js script (could be in scripts/ or straylight-core/scripts/)
VALIDATE_SCRIPT=""
if [ -f "scripts/validate-file.js" ]; then
    VALIDATE_SCRIPT="scripts/validate-file.js"
elif [ -f "straylight-core/scripts/validate-file.js" ]; then
    VALIDATE_SCRIPT="straylight-core/scripts/validate-file.js"
else
    echo "‚ö†Ô∏è  validate-file.js not found, skipping validation"
    exit 0
fi

# Run Nix lint if available (from project root)
if command -v nix &> /dev/null; then
    echo "Running nix lint..."
    nix flake check 2>/dev/null || nix run .#lint 2>/dev/null || echo "‚ö†Ô∏è  Nix lint not available, skipping"
fi

# Run file validation script
if command -v node &> /dev/null; then
    echo "Validating changed files..."
    
    # Get list of changed files (all Straylight Protocol file types)
    CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(nix|hs|purs|lean|sh|bash|lit|mdx|lit\.hs|lit\.cpp|lit\.purs|cpp|hpp|cc|h|cu|cuh|dhall|bzl|rs|py)$' || true)
    
    if [ -n "$CHANGED_FILES" ]; then
        for file in $CHANGED_FILES; do
            # Resolve file path relative to project root
            if [ -f "$file" ]; then
                echo "Validating $file..."
                node "$VALIDATE_SCRIPT" "$file" || {
                    echo "‚ùå Validation failed for $file"
                    echo "Fix errors before committing"
                    exit 1
                }
            fi
        done
    fi
else
    echo "‚ö†Ô∏è  Node.js not found, skipping validation"
fi

echo "‚úÖ Pre-commit validation passed"
