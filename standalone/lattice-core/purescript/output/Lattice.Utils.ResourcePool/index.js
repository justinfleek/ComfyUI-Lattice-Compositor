// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Generic_Rep from "../Data.Generic.Rep/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show_Generic from "../Data.Show.Generic/index.js";
var AcquireFoundIsSymbol = {
    reflectSymbol: function () {
        return "AcquireFound";
    }
};
var AcquireCreatedIsSymbol = {
    reflectSymbol: function () {
        return "AcquireCreated";
    }
};
var AcquirePoolFullIsSymbol = {
    reflectSymbol: function () {
        return "AcquirePoolFull";
    }
};
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var AcquireFound = /* #__PURE__ */ (function () {
    function AcquireFound(value0) {
        this.value0 = value0;
    };
    AcquireFound.create = function (value0) {
        return new AcquireFound(value0);
    };
    return AcquireFound;
})();
var AcquireCreated = /* #__PURE__ */ (function () {
    function AcquireCreated(value0) {
        this.value0 = value0;
    };
    AcquireCreated.create = function (value0) {
        return new AcquireCreated(value0);
    };
    return AcquireCreated;
})();
var AcquirePoolFull = /* #__PURE__ */ (function () {
    function AcquirePoolFull(value0) {
        this.value0 = value0;
    };
    AcquirePoolFull.create = function (value0) {
        return new AcquirePoolFull(value0);
    };
    return AcquirePoolFull;
})();
var genericAcquireResult_ = {
    to: function (x) {
        if (x instanceof Data_Generic_Rep.Inl) {
            return new AcquireFound(x.value0);
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inl) {
            return new AcquireCreated(x.value0.value0);
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inr) {
            return new AcquirePoolFull(x.value0.value0);
        };
        throw new Error("Failed pattern match at Lattice.Utils.ResourcePool (line 71, column 1 - line 71, column 44): " + [ x.constructor.name ]);
    },
    from: function (x) {
        if (x instanceof AcquireFound) {
            return new Data_Generic_Rep.Inl(x.value0);
        };
        if (x instanceof AcquireCreated) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inl(x.value0));
        };
        if (x instanceof AcquirePoolFull) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inr(x.value0));
        };
        throw new Error("Failed pattern match at Lattice.Utils.ResourcePool (line 71, column 1 - line 71, column 44): " + [ x.constructor.name ]);
    }
};
var genericShow = /* #__PURE__ */ Data_Show_Generic.genericShow(genericAcquireResult_);
var showAcquireResult = function (dictShow) {
    var genericShowConstructor = Data_Show_Generic.genericShowConstructor(Data_Show_Generic.genericShowArgsArgument(dictShow));
    return {
        show: genericShow(Data_Show_Generic.genericShowSum(genericShowConstructor(AcquireFoundIsSymbol))(Data_Show_Generic.genericShowSum(genericShowConstructor(AcquireCreatedIsSymbol))(genericShowConstructor(AcquirePoolFullIsSymbol))))
    };
};
var release = function (dictEq) {
    var eq1 = Data_Eq.eq(dictEq);
    return function (pool) {
        return function (resource) {
            return function (now) {
                var updateEntry = function (entry) {
                    if (eq1(entry.resource)(resource)) {
                        return {
                            resource: entry.resource,
                            height: entry.height,
                            width: entry.width,
                            inUse: false,
                            lastUsed: now
                        };
                    };
                    if (Data_Boolean.otherwise) {
                        return entry;
                    };
                    throw new Error("Failed pattern match at Lattice.Utils.ResourcePool (line 159, column 5 - line 162, column 26): " + [ entry.constructor.name ]);
                };
                return {
                    config: pool.config,
                    entries: map(updateEntry)(pool.entries)
                };
            };
        };
    };
};
var poolWithConfig = function (config) {
    return {
        entries: [  ],
        config: config
    };
};
var markInUse = function (dictEq) {
    var eq1 = Data_Eq.eq(dictEq);
    return function (pool) {
        return function (resource) {
            return function (now) {
                var updateEntry = function (entry) {
                    if (eq1(entry.resource)(resource)) {
                        return {
                            resource: entry.resource,
                            height: entry.height,
                            width: entry.width,
                            inUse: true,
                            lastUsed: now
                        };
                    };
                    if (Data_Boolean.otherwise) {
                        return entry;
                    };
                    throw new Error("Failed pattern match at Lattice.Utils.ResourcePool (line 116, column 5 - line 119, column 26): " + [ entry.constructor.name ]);
                };
                return {
                    config: pool.config,
                    entries: map(updateEntry)(pool.entries)
                };
            };
        };
    };
};
var getStats = function (pool) {
    var inUseCount = Data_Array.length(Data_Array.filter(function (v) {
        return v.inUse;
    })(pool.entries));
    return {
        total: Data_Array.length(pool.entries),
        inUse: inUseCount,
        available: Data_Array.length(pool.entries) - inUseCount | 0
    };
};
var findAvailable = function (pool) {
    return function (width) {
        return function (height) {
            var matchEntry = function (entry) {
                return !entry.inUse && (entry.width === width && entry.height === height);
            };
            return Data_Array.find(matchEntry)(pool.entries);
        };
    };
};
var defaultPoolConfig = {
    maxSize: 20,
    maxAgeMs: 60000
};
var emptyPool = {
    entries: [  ],
    config: defaultPoolConfig
};
var clearPool = function (pool) {
    return {
        config: pool.config,
        entries: [  ]
    };
};
var cleanup = function (pool) {
    return function (now) {
        var keepEntry = function (entry) {
            return entry.inUse || (now - entry.lastUsed | 0) <= pool.config.maxAgeMs;
        };
        return {
            config: pool.config,
            entries: Data_Array.filter(keepEntry)(pool.entries)
        };
    };
};
var acquire = function (dictEq) {
    var markInUse1 = markInUse(dictEq);
    return function (pool) {
        return function (width) {
            return function (height) {
                return function (now) {
                    return function (createResource) {
                        var v = findAvailable(pool)(width)(height);
                        if (v instanceof Data_Maybe.Just) {
                            var updatedPool = markInUse1(pool)(v.value0.resource)(now);
                            return {
                                pool: updatedPool,
                                result: new AcquireFound(v.value0.resource)
                            };
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            var newResource = createResource(width)(height);
                            var currentSize = Data_Array.length(pool.entries);
                            var $58 = currentSize < pool.config.maxSize;
                            if ($58) {
                                var newEntry = {
                                    resource: newResource,
                                    width: width,
                                    height: height,
                                    inUse: true,
                                    lastUsed: now
                                };
                                var updatedPool = {
                                    config: pool.config,
                                    entries: Data_Array.snoc(pool.entries)(newEntry)
                                };
                                return {
                                    pool: updatedPool,
                                    result: new AcquireCreated(newResource)
                                };
                            };
                            return {
                                pool: pool,
                                result: new AcquirePoolFull(newResource)
                            };
                        };
                        throw new Error("Failed pattern match at Lattice.Utils.ResourcePool (line 133, column 3 - line 152, column 63): " + [ v.constructor.name ]);
                    };
                };
            };
        };
    };
};
export {
    defaultPoolConfig,
    AcquireFound,
    AcquireCreated,
    AcquirePoolFull,
    emptyPool,
    poolWithConfig,
    findAvailable,
    acquire,
    release,
    cleanup,
    clearPool,
    getStats,
    genericAcquireResult_,
    showAcquireResult
};
//# sourceMappingURL=index.js.map
