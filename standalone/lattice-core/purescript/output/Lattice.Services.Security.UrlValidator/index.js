// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Generic_Rep from "../Data.Generic.Rep/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Show_Generic from "../Data.Show.Generic/index.js";
import * as Data_String_CodePoints from "../Data.String.CodePoints/index.js";
import * as Data_String_CodeUnits from "../Data.String.CodeUnits/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_String_Regex from "../Data.String.Regex/index.js";
import * as Data_String_Regex_Flags from "../Data.String.Regex.Flags/index.js";
var genericShowConstructor = /* #__PURE__ */ Data_Show_Generic.genericShowConstructor(Data_Show_Generic.genericShowArgsNoArguments);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var RiskSafe = /* #__PURE__ */ (function () {
    function RiskSafe() {

    };
    RiskSafe.value = new RiskSafe();
    return RiskSafe;
})();
var RiskWarning = /* #__PURE__ */ (function () {
    function RiskWarning() {

    };
    RiskWarning.value = new RiskWarning();
    return RiskWarning;
})();
var RiskBlocked = /* #__PURE__ */ (function () {
    function RiskBlocked() {

    };
    RiskBlocked.value = new RiskBlocked();
    return RiskBlocked;
})();
var CtxAsset = /* #__PURE__ */ (function () {
    function CtxAsset() {

    };
    CtxAsset.value = new CtxAsset();
    return CtxAsset;
})();
var CtxFetch = /* #__PURE__ */ (function () {
    function CtxFetch() {

    };
    CtxFetch.value = new CtxFetch();
    return CtxFetch;
})();
var CtxEmbed = /* #__PURE__ */ (function () {
    function CtxEmbed() {

    };
    CtxEmbed.value = new CtxEmbed();
    return CtxEmbed;
})();
var genericURLRiskLevel_ = {
    to: function (x) {
        if (x instanceof Data_Generic_Rep.Inl) {
            return RiskSafe.value;
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inl) {
            return RiskWarning.value;
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inr) {
            return RiskBlocked.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 60, column 1 - line 60, column 39): " + [ x.constructor.name ]);
    },
    from: function (x) {
        if (x instanceof RiskSafe) {
            return new Data_Generic_Rep.Inl(Data_Generic_Rep.NoArguments.value);
        };
        if (x instanceof RiskWarning) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inl(Data_Generic_Rep.NoArguments.value));
        };
        if (x instanceof RiskBlocked) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inr(Data_Generic_Rep.NoArguments.value));
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 60, column 1 - line 60, column 39): " + [ x.constructor.name ]);
    }
};
var showURLRiskLevel = {
    show: /* #__PURE__ */ Data_Show_Generic.genericShow(genericURLRiskLevel_)(/* #__PURE__ */ Data_Show_Generic.genericShowSum(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "RiskSafe";
        }
    }))(/* #__PURE__ */ Data_Show_Generic.genericShowSum(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "RiskWarning";
        }
    }))(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "RiskBlocked";
        }
    }))))
};
var genericURLContext_ = {
    to: function (x) {
        if (x instanceof Data_Generic_Rep.Inl) {
            return CtxAsset.value;
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inl) {
            return CtxFetch.value;
        };
        if (x instanceof Data_Generic_Rep.Inr && x.value0 instanceof Data_Generic_Rep.Inr) {
            return CtxEmbed.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 53, column 1 - line 53, column 37): " + [ x.constructor.name ]);
    },
    from: function (x) {
        if (x instanceof CtxAsset) {
            return new Data_Generic_Rep.Inl(Data_Generic_Rep.NoArguments.value);
        };
        if (x instanceof CtxFetch) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inl(Data_Generic_Rep.NoArguments.value));
        };
        if (x instanceof CtxEmbed) {
            return new Data_Generic_Rep.Inr(new Data_Generic_Rep.Inr(Data_Generic_Rep.NoArguments.value));
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 53, column 1 - line 53, column 37): " + [ x.constructor.name ]);
    }
};
var showURLContext = {
    show: /* #__PURE__ */ Data_Show_Generic.genericShow(genericURLContext_)(/* #__PURE__ */ Data_Show_Generic.genericShowSum(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "CtxAsset";
        }
    }))(/* #__PURE__ */ Data_Show_Generic.genericShowSum(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "CtxFetch";
        }
    }))(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "CtxEmbed";
        }
    }))))
};
var eqURLRiskLevel = {
    eq: function (x) {
        return function (y) {
            if (x instanceof RiskSafe && y instanceof RiskSafe) {
                return true;
            };
            if (x instanceof RiskWarning && y instanceof RiskWarning) {
                return true;
            };
            if (x instanceof RiskBlocked && y instanceof RiskBlocked) {
                return true;
            };
            return false;
        };
    }
};
var eqURLContext = {
    eq: function (x) {
        return function (y) {
            if (x instanceof CtxAsset && y instanceof CtxAsset) {
                return true;
            };
            if (x instanceof CtxFetch && y instanceof CtxFetch) {
                return true;
            };
            if (x instanceof CtxEmbed && y instanceof CtxEmbed) {
                return true;
            };
            return false;
        };
    }
};
var urlExtractRegex = /* #__PURE__ */ (function () {
    var v = Data_String_Regex.regex("https?://[^\\s<>\"{}|\\\\^`\\[\\]]+|data:[^\\s<>\"{}|\\\\^`\\[\\]]+|")(Data_String_Regex_Flags.ignoreCase);
    if (v instanceof Data_Either.Right) {
        return new Data_Maybe.Just(v.value0);
    };
    if (v instanceof Data_Either.Left) {
        return Data_Maybe.Nothing.value;
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 111, column 19 - line 113, column 20): " + [ v.constructor.name ]);
})();
var startsWith = function (prefix) {
    return function (str) {
        return Data_String_CodePoints.take(Data_String_CodePoints.length(prefix))(str) === prefix;
    };
};
var safeDataPatterns = /* #__PURE__ */ (function () {
    var mkRegex = function (pat) {
        var v = Data_String_Regex.regex(pat)(Data_String_Regex_Flags.ignoreCase);
        if (v instanceof Data_Either.Right) {
            return new Data_Maybe.Just(v.value0);
        };
        if (v instanceof Data_Either.Left) {
            return Data_Maybe.Nothing.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 148, column 19 - line 150, column 24): " + [ v.constructor.name ]);
    };
    return Data_Array.mapMaybe(mkRegex)([ "^data:image/(png|jpeg|jpg|gif|webp|bmp|ico|avif)", "^data:image/svg\\+xml(?!.*<script)", "^data:audio/(mp3|wav|ogg|webm|aac|flac)", "^data:video/(mp4|webm|ogg)", "^data:font/(woff|woff2|ttf|otf)", "^data:application/octet-stream", "^data:application/json", "^data:text/plain", "^data:text/csv" ]);
})();
var protocolRegex = /* #__PURE__ */ (function () {
    var v = Data_String_Regex.regex("^([a-zA-Z][a-zA-Z0-9+.-]*):")(Data_String_Regex_Flags.ignoreCase);
    if (v instanceof Data_Either.Right) {
        return new Data_Maybe.Just(v.value0);
    };
    if (v instanceof Data_Either.Left) {
        return Data_Maybe.Nothing.value;
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 105, column 17 - line 107, column 20): " + [ v.constructor.name ]);
})();
var parseHostname = function (url) {
    var v = Data_String_CodeUnits.indexOf("://")(url);
    if (v instanceof Data_Maybe.Nothing) {
        return Data_Maybe.Nothing.value;
    };
    if (v instanceof Data_Maybe.Just) {
        var afterProto = Data_String_CodePoints.drop(v.value0 + 3 | 0)(url);
        var endIdx = (function () {
            var v1 = Data_String_CodeUnits.indexOf("/")(afterProto);
            if (v1 instanceof Data_Maybe.Just) {
                return v1.value0;
            };
            if (v1 instanceof Data_Maybe.Nothing) {
                var v2 = Data_String_CodeUnits.indexOf(":")(afterProto);
                if (v2 instanceof Data_Maybe.Just) {
                    return v2.value0;
                };
                if (v2 instanceof Data_Maybe.Nothing) {
                    return Data_String_CodePoints.length(afterProto);
                };
                throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 345, column 24 - line 347, column 43): " + [ v2.constructor.name ]);
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 343, column 20 - line 347, column 43): " + [ v1.constructor.name ]);
        })();
        return new Data_Maybe.Just(Data_String_CodePoints.take(endIdx)(afterProto));
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 338, column 3 - line 348, column 43): " + [ v.constructor.name ]);
};
var mkWarning = function (url) {
    return function (proto) {
        return function (warn) {
            return {
                valid: true,
                sanitized: new Data_Maybe.Just(url),
                error: Data_Maybe.Nothing.value,
                warning: new Data_Maybe.Just(warn),
                protocol: proto,
                riskLevel: RiskWarning.value
            };
        };
    };
};
var mkSafe = function (url) {
    return function (proto) {
        return {
            valid: true,
            sanitized: new Data_Maybe.Just(url),
            error: Data_Maybe.Nothing.value,
            warning: Data_Maybe.Nothing.value,
            protocol: proto,
            riskLevel: RiskSafe.value
        };
    };
};
var mkBlocked = function (err) {
    return function (proto) {
        return {
            valid: false,
            sanitized: Data_Maybe.Nothing.value,
            error: new Data_Maybe.Just(err),
            warning: Data_Maybe.Nothing.value,
            protocol: proto,
            riskLevel: RiskBlocked.value
        };
    };
};
var maxURLLength = 2000000;
var isTrustedDomain = function (url) {
    return function (trustedDomains) {
        var v = parseHostname(url);
        if (v instanceof Data_Maybe.Nothing) {
            return false;
        };
        if (v instanceof Data_Maybe.Just) {
            var normalizedHost = Data_String_Common.toLower(v.value0);
            return Data_Array.any(function (domain) {
                var normalizedDomain = Data_String_Common.toLower(domain);
                return normalizedHost === normalizedDomain || Data_String_CodeUnits.contains("." + normalizedDomain)(normalizedHost);
            })(trustedDomains);
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 245, column 3 - line 253, column 23): " + [ v.constructor.name ]);
    };
};
var isRelativeURL = function (url) {
    return function (protocol) {
        return protocol === "relative" || (startsWith("/")(url) || (startsWith("./")(url) || startsWith("../")(url)));
    };
};
var extractURLsFromText = function (text) {
    var words = Data_String_Common.split(" ")(text);
    var isURLLike = function (w) {
        return startsWith("http://")(Data_String_Common.toLower(w)) || (startsWith("https://")(Data_String_Common.toLower(w)) || startsWith("data:")(Data_String_Common.toLower(w)));
    };
    return Data_Array.filter(isURLLike)(words);
};
var extractProtocol = function (url) {
    var v = Data_String_CodeUnits.indexOf(":")(url);
    if (v instanceof Data_Maybe.Just) {
        var proto = Data_String_CodePoints.take(v.value0 + 1 | 0)(url);
        return Data_String_Common.toLower(proto);
    };
    if (v instanceof Data_Maybe.Nothing) {
        return "relative";
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 309, column 3 - line 313, column 26): " + [ v.constructor.name ]);
};
var extractMimeFromDataURL = function (url) {
    var afterData = Data_String_CodePoints.drop(5)(url);
    var v = Data_String_CodeUnits.indexOf(";")(afterData);
    if (v instanceof Data_Maybe.Just) {
        return Data_String_CodePoints.take(v.value0)(afterData);
    };
    if (v instanceof Data_Maybe.Nothing) {
        var v1 = Data_String_CodeUnits.indexOf(",")(afterData);
        if (v1 instanceof Data_Maybe.Just) {
            return Data_String_CodePoints.take(v1.value0)(afterData);
        };
        if (v1 instanceof Data_Maybe.Nothing) {
            return "unknown";
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 330, column 16 - line 332, column 27): " + [ v1.constructor.name ]);
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 328, column 6 - line 332, column 27): " + [ v.constructor.name ]);
};
var escapeHTML = function (s) {
    return Data_String_Common.replaceAll("'")("&#x27;")(Data_String_Common.replaceAll("\"")("&quot;")(Data_String_Common.replaceAll(">")("&gt;")(Data_String_Common.replaceAll("<")("&lt;")(Data_String_Common.replaceAll("&")("&amp;")(s)))));
};
var blockedProtocols = [ "javascript:", "vbscript:", "file:", "ftp:", "gopher:", "ws:", "wss:", "chrome:", "chrome-extension:", "moz-extension:", "about:", "view-source:" ];
var findBlockedProtocol = function (url) {
    var lowUrl = Data_String_Common.toLower(url);
    var matched = Data_Array.filter(function (p) {
        return startsWith(p)(lowUrl);
    })(blockedProtocols);
    return Data_Array.head(matched);
};
var blockedDataPatterns = /* #__PURE__ */ (function () {
    var mkRegex = function (pat) {
        var v = Data_String_Regex.regex(pat)(Data_String_Regex_Flags.ignoreCase);
        if (v instanceof Data_Either.Right) {
            return new Data_Maybe.Just(v.value0);
        };
        if (v instanceof Data_Either.Left) {
            return Data_Maybe.Nothing.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 129, column 19 - line 131, column 24): " + [ v.constructor.name ]);
    };
    return Data_Array.mapMaybe(mkRegex)([ "^data:text/html", "^data:application/javascript", "^data:application/x-javascript", "^data:text/javascript", "^data:application/ecmascript", "^data:text/ecmascript", "^data:application/xhtml\\+xml", "^data:image/svg\\+xml.*<script" ]);
})();
var validateDataURL = function (url) {
    var $102 = Data_Array.any(function (pat) {
        return Data_String_Regex.test(pat)(url);
    })(blockedDataPatterns);
    if ($102) {
        return mkBlocked("Data URL contains blocked content type (possible script injection)")("data:");
    };
    var $103 = Data_Array.any(function (pat) {
        return Data_String_Regex.test(pat)(url);
    })(safeDataPatterns);
    if ($103) {
        return mkSafe(url)("data:");
    };
    var mime = extractMimeFromDataURL(url);
    return mkBlocked("Data URL with unrecognized MIME type: " + mime)("data:");
};
var validateURL = function (url) {
    return function (_context) {
        var trimmedUrl = Data_String_Common.trim(url);
        var $104 = Data_String_CodePoints.length(trimmedUrl) === 0;
        if ($104) {
            return mkBlocked("URL is empty")("none");
        };
        var $105 = Data_String_CodePoints.length(trimmedUrl) > maxURLLength;
        if ($105) {
            return mkBlocked("URL exceeds maximum length (2MB)")("unknown");
        };
        var v = findBlockedProtocol(trimmedUrl);
        if (v instanceof Data_Maybe.Just) {
            return mkBlocked("Blocked protocol: " + (v.value0 + " - security risk"))(v.value0);
        };
        if (v instanceof Data_Maybe.Nothing) {
            var protocol = extractProtocol(trimmedUrl);
            var $108 = protocol === "data:";
            if ($108) {
                return validateDataURL(trimmedUrl);
            };
            var $109 = protocol === "blob:";
            if ($109) {
                return mkSafe(trimmedUrl)("blob:");
            };
            var $110 = protocol === "https:";
            if ($110) {
                return mkSafe(trimmedUrl)("https:");
            };
            var $111 = protocol === "http:";
            if ($111) {
                return mkWarning(trimmedUrl)("http:")("Unencrypted HTTP connection - data may be intercepted");
            };
            var $112 = isRelativeURL(trimmedUrl)(protocol);
            if ($112) {
                return mkSafe(trimmedUrl)("relative");
            };
            return mkBlocked("Unknown protocol: " + (protocol + " - blocked for security"))(protocol);
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 169, column 8 - line 190, column 94): " + [ v.constructor.name ]);
    };
};
var extractAndValidateURLs = function (text) {
    var urls = extractURLsFromText(text);
    return map(function (u) {
        return validateURL(u)(CtxAsset.value);
    })(urls);
};
var sanitizeURLForHTML = function (url) {
    var result = validateURL(url)(CtxAsset.value);
    if (result.valid) {
        if (result.sanitized instanceof Data_Maybe.Just) {
            return new Data_Either.Right(escapeHTML(result.sanitized.value0));
        };
        if (result.sanitized instanceof Data_Maybe.Nothing) {
            return new Data_Either.Left("URL validation passed but no sanitized URL returned");
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 222, column 10 - line 224, column 76): " + [ result.sanitized.constructor.name ]);
    };
    return new Data_Either.Left((function () {
        if (result.error instanceof Data_Maybe.Just) {
            return result.error.value0;
        };
        if (result.error instanceof Data_Maybe.Nothing) {
            return "URL validation failed";
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.UrlValidator (line 225, column 16 - line 227, column 41): " + [ result.error.constructor.name ]);
    })());
};
var validateURLs = function (urls) {
    return foldl(function (m) {
        return function (url) {
            return insert(url)(validateURL(url)(CtxAsset.value))(m);
        };
    })(Data_Map_Internal.empty)(urls);
};
export {
    CtxAsset,
    CtxFetch,
    CtxEmbed,
    RiskSafe,
    RiskWarning,
    RiskBlocked,
    validateURL,
    validateDataURL,
    validateURLs,
    sanitizeURLForHTML,
    isTrustedDomain,
    extractAndValidateURLs,
    blockedProtocols,
    maxURLLength,
    eqURLContext,
    genericURLContext_,
    showURLContext,
    eqURLRiskLevel,
    genericURLRiskLevel_,
    showURLRiskLevel
};
//# sourceMappingURL=index.js.map
