// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_EuclideanRing from "../Data.EuclideanRing/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Lattice_Services_ShapeOperations_Generators from "../Lattice.Services.ShapeOperations.Generators/index.js";
import * as Lattice_Services_ShapeOperations_Point2D from "../Lattice.Services.ShapeOperations.Point2D/index.js";
import * as $$Math from "../Math/index.js";
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var mod = /* #__PURE__ */ Data_EuclideanRing.mod(Data_EuclideanRing.euclideanRingInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var triangleArea = function (p1) {
    return function (p2) {
        return function (p3) {
            return $$Math.abs(p1.x * (p2.y - p3.y) + p2.x * (p3.y - p1.y) + p3.x * (p1.y - p2.y)) / 2.0;
        };
    };
};
var visvalingamWhyatt = function ($copy_points) {
    return function ($copy_minArea) {
        var $tco_var_points = $copy_points;
        var $tco_done = false;
        var $tco_result;
        function $tco_loop(points, minArea) {
            if (Data_Array.length(points) <= 2) {
                $tco_done = true;
                return points;
            };
            if (Data_Boolean.otherwise) {
                var safeGet = function (i) {
                    return Data_Maybe.fromMaybe(Lattice_Services_ShapeOperations_Point2D.origin)(Data_Array.index(points)(i));
                };
                var findMinArea = function ($copy_i) {
                    return function ($copy_minA) {
                        return function ($copy_minIdx) {
                            var $tco_var_i = $copy_i;
                            var $tco_var_minA = $copy_minA;
                            var $tco_done1 = false;
                            var $tco_result;
                            function $tco_loop(i, minA, minIdx) {
                                if (i >= (Data_Array.length(points) - 1 | 0)) {
                                    $tco_done1 = true;
                                    return {
                                        minA: minA,
                                        minIdx: minIdx
                                    };
                                };
                                if (Data_Boolean.otherwise) {
                                    var area = triangleArea(safeGet(i - 1 | 0))(safeGet(i))(safeGet(i + 1 | 0));
                                    var $27 = area < minA;
                                    if ($27) {
                                        $tco_var_i = i + 1 | 0;
                                        $tco_var_minA = area;
                                        $copy_minIdx = i;
                                        return;
                                    };
                                    $tco_var_i = i + 1 | 0;
                                    $tco_var_minA = minA;
                                    $copy_minIdx = minIdx;
                                    return;
                                };
                                throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 223, column 11 - line 229, column 56): " + [ i.constructor.name, minA.constructor.name, minIdx.constructor.name ]);
                            };
                            while (!$tco_done1) {
                                $tco_result = $tco_loop($tco_var_i, $tco_var_minA, $copy_minIdx);
                            };
                            return $tco_result;
                        };
                    };
                };
                var result = findMinArea(1)(1.0e10)(1);
                var $28 = result.minA < minArea;
                if ($28) {
                    var newPoints = append(Data_Array.take(result.minIdx)(points))(Data_Array.drop(result.minIdx + 1 | 0)(points));
                    $tco_var_points = newPoints;
                    $copy_minArea = minArea;
                    return;
                };
                $tco_done = true;
                return points;
            };
            throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 216, column 1 - line 216, column 70): " + [ points.constructor.name, minArea.constructor.name ]);
        };
        while (!$tco_done) {
            $tco_result = $tco_loop($tco_var_points, $copy_minArea);
        };
        return $tco_result;
    };
};
var smoothPath = function (path) {
    return function (amount) {
        if (Data_Array.length(path.vertices) < 2) {
            return path;
        };
        if (Data_Boolean.otherwise) {
            var safeGet = function (i) {
                return Data_Maybe.fromMaybe({
                    point: Lattice_Services_ShapeOperations_Point2D.origin,
                    inHandle: Lattice_Services_ShapeOperations_Point2D.origin,
                    outHandle: Lattice_Services_ShapeOperations_Point2D.origin
                })(Data_Array.index(path.vertices)(i));
            };
            var n = Data_Array.length(path.vertices);
            var factor = amount / 100.0;
            var mkVertex = function (i) {
                var v = safeGet(i);
                var prev = safeGet(mod((i + n | 0) - 1 | 0)(n));
                var toPrev = Lattice_Services_ShapeOperations_Point2D.sub(prev.point)(v.point);
                var next = safeGet(mod(i + 1 | 0)(n));
                var toNext = Lattice_Services_ShapeOperations_Point2D.sub(next.point)(v.point);
                var idealHandleLength = (Lattice_Services_ShapeOperations_Point2D.distance(v.point)(prev.point) + Lattice_Services_ShapeOperations_Point2D.distance(v.point)(next.point)) / 6.0;
                var avgDir = Lattice_Services_ShapeOperations_Point2D.normalize(Lattice_Services_ShapeOperations_Point2D.sub(toNext)(toPrev));
                var idealIn = Lattice_Services_ShapeOperations_Point2D.scale(avgDir)(-idealHandleLength);
                var idealOut = Lattice_Services_ShapeOperations_Point2D.scale(avgDir)(idealHandleLength);
                return {
                    point: v.point,
                    inHandle: Lattice_Services_ShapeOperations_Point2D.lerp(v.inHandle)(idealIn)(factor),
                    outHandle: Lattice_Services_ShapeOperations_Point2D.lerp(v.outHandle)(idealOut)(factor)
                };
            };
            var vertices = Data_Array.mapWithIndex(function (i) {
                return function (v) {
                    return mkVertex(i);
                };
            })(path.vertices);
            return {
                vertices: vertices,
                closed: path.closed
            };
        };
        throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 172, column 1 - line 172, column 49): " + [ path.constructor.name, amount.constructor.name ]);
    };
};
var perpendicularDistance = function (point) {
    return function (lineStart) {
        return function (lineEnd) {
            var dy = lineEnd.y - lineStart.y;
            var dx = lineEnd.x - lineStart.x;
            var lineLengthSq = dx * dx + dy * dy;
            var $31 = lineLengthSq === 0.0;
            if ($31) {
                return Lattice_Services_ShapeOperations_Point2D.distance(point)(lineStart);
            };
            var t = ((point.x - lineStart.x) * dx + (point.y - lineStart.y) * dy) / lineLengthSq;
            var tClamped = $$Math.max(0.0)($$Math.min(1.0)(t));
            var projection = {
                x: lineStart.x + tClamped * dx,
                y: lineStart.y + tClamped * dy
            };
            return Lattice_Services_ShapeOperations_Point2D.distance(point)(projection);
        };
    };
};
var fitBezierToPolygon = function (points) {
    return function (closed) {
        if (Data_Array.length(points) < 2) {
            return {
                vertices: [  ],
                closed: closed
            };
        };
        if (Data_Array.length(points) === 2) {
            return {
                vertices: map(Lattice_Services_ShapeOperations_Generators.cornerVertex)(points),
                closed: closed
            };
        };
        if (Data_Boolean.otherwise) {
            var safeGet = function (i) {
                return Data_Maybe.fromMaybe(Lattice_Services_ShapeOperations_Point2D.origin)(Data_Array.index(points)(i));
            };
            var n = Data_Array.length(points);
            var mkVertex = function (i) {
                var prev = safeGet(mod((i + n | 0) - 1 | 0)(n));
                var next = safeGet(mod(i + 1 | 0)(n));
                var curr = safeGet(i);
                var distNext = Lattice_Services_ShapeOperations_Point2D.distance(curr)(next);
                var distPrev = Lattice_Services_ShapeOperations_Point2D.distance(curr)(prev);
                var toNext = Lattice_Services_ShapeOperations_Point2D.sub(next)(curr);
                var toPrev = Lattice_Services_ShapeOperations_Point2D.sub(prev)(curr);
                var $34 = !closed && i === 0;
                if ($34) {
                    return {
                        point: curr,
                        inHandle: Lattice_Services_ShapeOperations_Point2D.origin,
                        outHandle: Lattice_Services_ShapeOperations_Point2D.scale(Lattice_Services_ShapeOperations_Point2D.normalize(toNext))(distNext * 0.25)
                    };
                };
                var $35 = !closed && i === (n - 1 | 0);
                if ($35) {
                    return {
                        point: curr,
                        inHandle: Lattice_Services_ShapeOperations_Point2D.scale(Lattice_Services_ShapeOperations_Point2D.normalize(toPrev))(distPrev * 0.25),
                        outHandle: Lattice_Services_ShapeOperations_Point2D.origin
                    };
                };
                var tangent = Lattice_Services_ShapeOperations_Point2D.normalize(Lattice_Services_ShapeOperations_Point2D.sub(toNext)(toPrev));
                return {
                    point: curr,
                    inHandle: Lattice_Services_ShapeOperations_Point2D.scale(tangent)(-distPrev * 0.25),
                    outHandle: Lattice_Services_ShapeOperations_Point2D.scale(tangent)(distNext * 0.25)
                };
            };
            var vertices = Data_Array.mapWithIndex(function (i) {
                return function (v) {
                    return mkVertex(i);
                };
            })(points);
            return {
                vertices: vertices,
                closed: closed
            };
        };
        throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 110, column 1 - line 110, column 65): " + [ points.constructor.name, closed.constructor.name ]);
    };
};
var douglasPeucker = function (points) {
    return function (tolerance) {
        if (Data_Array.length(points) <= 2) {
            return points;
        };
        if (Data_Boolean.otherwise) {
            var $38 = {
                first: Data_Array.head(points),
                last: Data_Array.last(points)
            };
            if ($38.first instanceof Data_Maybe.Just && $38.last instanceof Data_Maybe.Just) {
                var findMax = function ($copy_i) {
                    return function ($copy_maxDist) {
                        return function ($copy_maxIdx) {
                            var $tco_var_i = $copy_i;
                            var $tco_var_maxDist = $copy_maxDist;
                            var $tco_done = false;
                            var $tco_result;
                            function $tco_loop(i, maxDist, maxIdx) {
                                if (i >= (Data_Array.length(points) - 1 | 0)) {
                                    $tco_done = true;
                                    return {
                                        maxDist: maxDist,
                                        maxIdx: maxIdx
                                    };
                                };
                                if (Data_Boolean.otherwise) {
                                    var v = Data_Array.index(points)(i);
                                    if (v instanceof Data_Maybe.Nothing) {
                                        $tco_var_i = i + 1 | 0;
                                        $tco_var_maxDist = maxDist;
                                        $copy_maxIdx = maxIdx;
                                        return;
                                    };
                                    if (v instanceof Data_Maybe.Just) {
                                        var d = perpendicularDistance(v.value0)($38.first.value0)($38.last.value0);
                                        var $43 = d > maxDist;
                                        if ($43) {
                                            $tco_var_i = i + 1 | 0;
                                            $tco_var_maxDist = d;
                                            $copy_maxIdx = i;
                                            return;
                                        };
                                        $tco_var_i = i + 1 | 0;
                                        $tco_var_maxDist = maxDist;
                                        $copy_maxIdx = maxIdx;
                                        return;
                                    };
                                    throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 70, column 21 - line 76, column 63): " + [ v.constructor.name ]);
                                };
                                throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 67, column 15 - line 76, column 63): " + [ i.constructor.name, maxDist.constructor.name, maxIdx.constructor.name ]);
                            };
                            while (!$tco_done) {
                                $tco_result = $tco_loop($tco_var_i, $tco_var_maxDist, $copy_maxIdx);
                            };
                            return $tco_result;
                        };
                    };
                };
                var result = findMax(1)(0.0)(0);
                var $45 = result.maxDist > tolerance;
                if ($45) {
                    var rightPoints = Data_Array.drop(result.maxIdx)(points);
                    var rightSimplified = douglasPeucker(rightPoints)(tolerance);
                    var leftPoints = Data_Array.take(result.maxIdx + 1 | 0)(points);
                    var leftSimplified = douglasPeucker(leftPoints)(tolerance);
                    var leftWithoutLast = Data_Array.take(Data_Array.length(leftSimplified) - 1 | 0)(leftSimplified);
                    return append(leftWithoutLast)(rightSimplified);
                };
                return [ $38.first.value0, $38.last.value0 ];
            };
            return points;
        };
        throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 60, column 1 - line 60, column 67): " + [ points.constructor.name, tolerance.constructor.name ]);
    };
};
var rdpSimplify = douglasPeucker;
var simplifyPath = function (path) {
    return function (tolerance) {
        return function (straightLines) {
            if (Data_Array.length(path.vertices) <= 2) {
                return path;
            };
            if (Data_Boolean.otherwise) {
                var points = map(function (v) {
                    return v.point;
                })(path.vertices);
                var simplified = douglasPeucker(points)(tolerance);
                if (straightLines) {
                    return {
                        vertices: map(Lattice_Services_ShapeOperations_Generators.cornerVertex)(simplified),
                        closed: path.closed
                    };
                };
                return fitBezierToPolygon(simplified)(path.closed);
            };
            throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 157, column 1 - line 157, column 62): " + [ path.constructor.name, tolerance.constructor.name, straightLines.constructor.name ]);
        };
    };
};
var simplifyPolygon = function (points) {
    return function (tolerance) {
        if (Data_Array.length(points) <= 3) {
            return points;
        };
        if (Data_Boolean.otherwise) {
            return douglasPeucker(points)(tolerance);
        };
        throw new Error("Failed pattern match at Lattice.Services.ShapeOperations.Simplify (line 100, column 1 - line 100, column 68): " + [ points.constructor.name, tolerance.constructor.name ]);
    };
};
export {
    perpendicularDistance,
    douglasPeucker,
    rdpSimplify,
    simplifyPolygon,
    fitBezierToPolygon,
    simplifyPath,
    smoothPath,
    triangleArea,
    visvalingamWhyatt
};
//# sourceMappingURL=index.js.map
