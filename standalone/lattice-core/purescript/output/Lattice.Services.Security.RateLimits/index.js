// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Argonaut_Decode_Class from "../Data.Argonaut.Decode.Class/index.js";
import * as Data_Argonaut_Encode_Class from "../Data.Argonaut.Encode.Class/index.js";
import * as Data_Argonaut_Parser from "../Data.Argonaut.Parser/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Generic_Rep from "../Data.Generic.Rep/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Map from "../Data.Map/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Show_Generic from "../Data.Show.Generic/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unfoldable from "../Data.Unfoldable/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Effect_Unsafe from "../Effect.Unsafe/index.js";
var genericShowConstructor = /* #__PURE__ */ Data_Show_Generic.genericShowConstructor(Data_Show_Generic.genericShowArgsNoArguments);
var encodeJson = /* #__PURE__ */ Data_Argonaut_Encode_Class.encodeJson(/* #__PURE__ */ Data_Argonaut_Encode_Class.encodeMap(Data_Ord.ordString)(Data_Argonaut_Encode_Class.encodeJsonJString)(Data_Argonaut_Encode_Class.encodeJsonInt));
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var map = /* #__PURE__ */ Data_Functor.map(Effect.functorEffect);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var decodeJson = /* #__PURE__ */ Data_Argonaut_Decode_Class.decodeJson(/* #__PURE__ */ Data_Argonaut_Decode_Class.decodeMap(Data_Ord.ordString)(Data_Argonaut_Decode_Class.decodeJsonString)(Data_Argonaut_Decode_Class.decodeJsonInt));
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var union = /* #__PURE__ */ Data_Set.union(Data_Ord.ordString);
var fromFoldable = /* #__PURE__ */ Data_Set.fromFoldable(Data_Set.foldableSet)(Data_Ord.ordString);
var toUnfoldable = /* #__PURE__ */ Data_Set.toUnfoldable(Data_Unfoldable.unfoldableArray);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Control_Bind.bindArray);
var SevWarning = /* #__PURE__ */ (function () {
    function SevWarning() {

    };
    SevWarning.value = new SevWarning();
    return SevWarning;
})();
var SevCritical = /* #__PURE__ */ (function () {
    function SevCritical() {

    };
    SevCritical.value = new SevCritical();
    return SevCritical;
})();
var genericWarningSeverity_ = {
    to: function (x) {
        if (x instanceof Data_Generic_Rep.Inl) {
            return SevWarning.value;
        };
        if (x instanceof Data_Generic_Rep.Inr) {
            return SevCritical.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 92, column 1 - line 92, column 42): " + [ x.constructor.name ]);
    },
    from: function (x) {
        if (x instanceof SevWarning) {
            return new Data_Generic_Rep.Inl(Data_Generic_Rep.NoArguments.value);
        };
        if (x instanceof SevCritical) {
            return new Data_Generic_Rep.Inr(Data_Generic_Rep.NoArguments.value);
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 92, column 1 - line 92, column 42): " + [ x.constructor.name ]);
    }
};
var showWarningSeverity = {
    show: /* #__PURE__ */ Data_Show_Generic.genericShow(genericWarningSeverity_)(/* #__PURE__ */ Data_Show_Generic.genericShowSum(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "SevWarning";
        }
    }))(/* #__PURE__ */ genericShowConstructor({
        reflectSymbol: function () {
            return "SevCritical";
        }
    })))
};
var eqWarningSeverity = {
    eq: function (x) {
        return function (y) {
            if (x instanceof SevWarning && y instanceof SevWarning) {
                return true;
            };
            if (x instanceof SevCritical && y instanceof SevCritical) {
                return true;
            };
            return false;
        };
    }
};
var stringifyCountsJson = function (m) {
    return Data_Argonaut_Core.stringify(encodeJson(m));
};
var stringifyStoredLimits = function (limits) {
    return "{\"date\":\"" + (limits.date + ("\",\"counts\":" + (stringifyCountsJson(limits.counts) + (",\"lastReset\":\"" + (limits.lastReset + "\"}")))));
};
var storageKey = "lattice_rate_limits";
var sessionStorageRef = /* #__PURE__ */ Effect_Unsafe.unsafePerformEffect(/* #__PURE__ */ Effect_Ref["new"](Data_Map_Internal.empty));
var sessionStorageSetItem = function (key) {
    return function (value) {
        return Effect_Ref.modify_(insert(key)(value))(sessionStorageRef);
    };
};
var sessionStorageGetItem = function (key) {
    return map(lookup(key))(Effect_Ref.read(sessionStorageRef));
};
var sessionKey = "lattice_session_counts";
var sessionCountsRef = /* #__PURE__ */ Effect_Unsafe.unsafePerformEffect(/* #__PURE__ */ Effect_Ref["new"](Data_Map_Internal.empty));
var saveSessionCounts = function (counts) {
    return sessionStorageSetItem(sessionKey)(stringifyCountsJson(counts));
};
var resetSessionLimit = function (toolName) {
    return function __do() {
        var sessionCounts = Effect_Ref.read(sessionCountsRef)();
        var oldCount = Data_Maybe.fromMaybe(0)(lookup(toolName)(sessionCounts));
        var newCounts = insert(toolName)(0)(sessionCounts);
        Effect_Ref.write(newCounts)(sessionCountsRef)();
        saveSessionCounts(newCounts)();
        return Effect_Console.log("[SECURITY] Session limit reset for " + (toolName + (" (was: " + (show(oldCount) + ")"))))();
    };
};
var resetAllSessionLimits = function (confirmationCode) {
    var $62 = confirmationCode !== "RESET_SESSION_LIMITS";
    if ($62) {
        return function __do() {
            Effect_Console.warn("[SECURITY] Reset rejected: invalid confirmation code")();
            return false;
        };
    };
    return function __do() {
        Effect_Ref.write(Data_Map_Internal.empty)(sessionCountsRef)();
        saveSessionCounts(Data_Map_Internal.empty)();
        Effect_Console.log("[SECURITY] All session limits reset")();
        return true;
    };
};
var parseCountsJson = function (json) {
    var v = Data_Argonaut_Parser.jsonParser(json);
    if (v instanceof Data_Either.Left) {
        return Data_Maybe.Nothing.value;
    };
    if (v instanceof Data_Either.Right) {
        return Data_Either.hush(decodeJson(v.value0));
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 134, column 3 - line 136, column 35): " + [ v.constructor.name ]);
};
var max = function (a) {
    return function (b) {
        var $66 = a > b;
        if ($66) {
            return a;
        };
        return b;
    };
};
var localStorageRef = /* #__PURE__ */ Effect_Unsafe.unsafePerformEffect(/* #__PURE__ */ Effect_Ref["new"](Data_Map_Internal.empty));
var localStorageSetItem = function (key) {
    return function (value) {
        return Effect_Ref.modify_(insert(key)(value))(localStorageRef);
    };
};
var saveStoredLimits = function (limits) {
    var json = stringifyStoredLimits(limits);
    return localStorageSetItem(storageKey)(json);
};
var localStorageGetItem = function (key) {
    return map(lookup(key))(Effect_Ref.read(localStorageRef));
};
var loadSessionCounts = function __do() {
    var maybeStored = sessionStorageGetItem(sessionKey)();
    if (maybeStored instanceof Data_Maybe.Nothing) {
        return Data_Map_Internal.empty;
    };
    if (maybeStored instanceof Data_Maybe.Just) {
        return Data_Maybe.fromMaybe(Data_Map_Internal.empty)(parseCountsJson(maybeStored.value0));
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 272, column 3 - line 274, column 71): " + [ maybeStored.constructor.name ]);
};
var getTomorrowMidnightUTC = /* #__PURE__ */ pure("2026-02-20T00:00:00Z");
var getTimeUntilReset = /* #__PURE__ */ pure("~24 hours");
var getCurrentISOTimestamp = /* #__PURE__ */ pure("2026-02-19T12:00:00Z");
var getCurrentDateUTC = /* #__PURE__ */ pure("2026-02-19");
var $$for = function (arr) {
    return function (f) {
        var len = Data_Array.length(arr);
        var go = function (idx) {
            return function (acc) {
                if (idx >= len) {
                    return pure(acc);
                };
                if (Data_Boolean.otherwise) {
                    var v = Data_Array.index(arr)(idx);
                    if (v instanceof Data_Maybe.Nothing) {
                        return pure(acc);
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return function __do() {
                            var b = f(v.value0)();
                            return go(idx + 1 | 0)(append1(acc)([ b ]))();
                        };
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 485, column 21 - line 489, column 38): " + [ v.constructor.name ]);
                };
                throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 483, column 5 - line 489, column 38): " + [ idx.constructor.name, acc.constructor.name ]);
            };
        };
        return go(0)([  ]);
    };
};
var extractLastResetFromJson = function (v) {
    return "2026-02-19T00:00:00Z";
};
var extractDateFromJson = function (v) {
    return "2026-02-19";
};
var parseStoredLimits = function (json) {
    return bind1(parseCountsJson(json))(function (counts) {
        return new Data_Maybe.Just({
            date: extractDateFromJson(json),
            counts: counts,
            lastReset: extractLastResetFromJson(json)
        });
    });
};
var loadStoredLimits = function __do() {
    var today = getCurrentDateUTC();
    var timestamp = getCurrentISOTimestamp();
    var maybeStored = localStorageGetItem(storageKey)();
    if (maybeStored instanceof Data_Maybe.Nothing) {
        return {
            date: today,
            counts: Data_Map_Internal.empty,
            lastReset: timestamp
        };
    };
    if (maybeStored instanceof Data_Maybe.Just) {
        var v = parseStoredLimits(maybeStored.value0);
        if (v instanceof Data_Maybe.Nothing) {
            return {
                date: today,
                counts: Data_Map_Internal.empty,
                lastReset: timestamp
            };
        };
        if (v instanceof Data_Maybe.Just) {
            var $75 = v.value0.date !== today;
            if ($75) {
                Effect_Console.log("[SECURITY] Daily rate limits reset (new day)")();
                return {
                    date: today,
                    counts: Data_Map_Internal.empty,
                    lastReset: timestamp
                };
            };
            return v.value0;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 225, column 20 - line 233, column 26): " + [ v.constructor.name ]);
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 223, column 3 - line 233, column 26): " + [ maybeStored.constructor.name ]);
};
var defaultLimits = /* #__PURE__ */ (function () {
    return Data_Map_Internal.fromFoldable(Data_Ord.ordString)(Data_Foldable.foldableArray)([ new Data_Tuple.Tuple("decomposeImage", {
        toolName: "decomposeImage",
        maxPerDay: 10,
        maxPerSession: new Data_Maybe.Just(3),
        vramCostMB: new Data_Maybe.Just(28800)
    }), new Data_Tuple.Tuple("vectorizeImage", {
        toolName: "vectorizeImage",
        maxPerDay: 20,
        maxPerSession: new Data_Maybe.Just(5),
        vramCostMB: new Data_Maybe.Just(4000)
    }) ]);
})();
var customLimitsRef = /* #__PURE__ */ Effect_Unsafe.unsafePerformEffect(/* #__PURE__ */ Effect_Ref["new"](Data_Map_Internal.empty));
var setRateLimitConfig = function (config) {
    return function __do() {
        var customLimits = Effect_Ref.read(customLimitsRef)();
        Effect_Ref.write(insert(config.toolName)(config)(customLimits))(customLimitsRef)();
        return Effect_Console.log("[SECURITY] Rate limit configured for " + config.toolName)();
    };
};
var checkRateLimit = function (toolName) {
    return function __do() {
        var customLimits = Effect_Ref.read(customLimitsRef)();
        var sessionCounts = Effect_Ref.read(sessionCountsRef)();
        var maybeConfig = (function () {
            var v = lookup(toolName)(customLimits);
            if (v instanceof Data_Maybe.Just) {
                return new Data_Maybe.Just(v.value0);
            };
            if (v instanceof Data_Maybe.Nothing) {
                return lookup(toolName)(defaultLimits);
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 291, column 21 - line 293, column 53): " + [ v.constructor.name ]);
        })();
        var resetsAt = getTomorrowMidnightUTC();
        var resetsIn = getTimeUntilReset();
        if (maybeConfig instanceof Data_Maybe.Nothing) {
            var sessionCount = Data_Maybe.fromMaybe(0)(lookup(toolName)(sessionCounts));
            return {
                toolName: toolName,
                callsToday: 0,
                maxPerDay: 999999,
                callsThisSession: sessionCount,
                maxPerSession: Data_Maybe.Nothing.value,
                canCall: true,
                blockedReason: Data_Maybe.Nothing.value,
                resetsAt: resetsAt,
                resetsIn: resetsIn
            };
        };
        if (maybeConfig instanceof Data_Maybe.Just) {
            var stored = loadStoredLimits();
            var callsToday = Data_Maybe.fromMaybe(0)(lookup(toolName)(stored.counts));
            var callsThisSession = Data_Maybe.fromMaybe(0)(lookup(toolName)(sessionCounts));
            var $81 = callsToday >= maybeConfig.value0.maxPerDay;
            if ($81) {
                return {
                    toolName: toolName,
                    callsToday: callsToday,
                    maxPerDay: maybeConfig.value0.maxPerDay,
                    callsThisSession: callsThisSession,
                    maxPerSession: maybeConfig.value0.maxPerSession,
                    canCall: false,
                    blockedReason: new Data_Maybe.Just("Daily limit reached (" + (show(callsToday) + ("/" + (show(maybeConfig.value0.maxPerDay) + ("). Resets in " + (resetsIn + ".")))))),
                    resetsAt: resetsAt,
                    resetsIn: resetsIn
                };
            };
            if (maybeConfig.value0.maxPerSession instanceof Data_Maybe.Just && callsThisSession >= maybeConfig.value0.maxPerSession.value0) {
                return {
                    toolName: toolName,
                    callsToday: callsToday,
                    maxPerDay: maybeConfig.value0.maxPerDay,
                    callsThisSession: callsThisSession,
                    maxPerSession: maybeConfig.value0.maxPerSession,
                    canCall: false,
                    blockedReason: new Data_Maybe.Just("Session limit reached (" + (show(callsThisSession) + ("/" + (show(maybeConfig.value0.maxPerSession.value0) + ("). Use resetSessionLimit('" + (toolName + "') to continue.")))))),
                    resetsAt: resetsAt,
                    resetsIn: resetsIn
                };
            };
            return {
                toolName: toolName,
                callsToday: callsToday,
                maxPerDay: maybeConfig.value0.maxPerDay,
                callsThisSession: callsThisSession,
                maxPerSession: maybeConfig.value0.maxPerSession,
                canCall: true,
                blockedReason: Data_Maybe.Nothing.value,
                resetsAt: resetsAt,
                resetsIn: resetsIn
            };
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 298, column 3 - line 357, column 16): " + [ maybeConfig.constructor.name ]);
    };
};
var getAllRateLimitStatus = function __do() {
    var customLimits = Effect_Ref.read(customLimitsRef)();
    var defaultToolNames = Data_Map.keys(defaultLimits);
    var customToolNames = Data_Map.keys(customLimits);
    var allTools = union(fromFoldable(defaultToolNames))(fromFoldable(customToolNames));
    var statuses = $$for(toUnfoldable(allTools))(checkRateLimit)();
    return statuses;
};
var checkRateLimitWarnings = /* #__PURE__ */ (function () {
    var collectWarnings = function (customLimits) {
        return function (status) {
            var maybeConfig = (function () {
                var v = lookup(status.toolName)(customLimits);
                if (v instanceof Data_Maybe.Just) {
                    return new Data_Maybe.Just(v.value0);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return lookup(status.toolName)(defaultLimits);
                };
                throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 445, column 25 - line 447, column 64): " + [ v.constructor.name ]);
            })();
            if (maybeConfig instanceof Data_Maybe.Nothing) {
                return [  ];
            };
            if (maybeConfig instanceof Data_Maybe.Just) {
                var sessionWarnings = (function () {
                    if (status.maxPerSession instanceof Data_Maybe.Just && status.callsThisSession >= status.maxPerSession.value0) {
                        return [ {
                            toolName: status.toolName,
                            message: "Session limit reached for " + (status.toolName + ". Manual reset required."),
                            severity: SevCritical.value
                        } ];
                    };
                    return [  ];
                })();
                var dailyPercent = Data_Int.toNumber(status.callsToday) / Data_Int.toNumber(status.maxPerDay);
                var dailyWarnings = (function () {
                    var $90 = dailyPercent >= 1.0;
                    if ($90) {
                        return [ {
                            toolName: status.toolName,
                            message: "Daily limit reached for " + (status.toolName + (". Resets in " + (status.resetsIn + "."))),
                            severity: SevCritical.value
                        } ];
                    };
                    var $91 = dailyPercent >= 0.8;
                    if ($91) {
                        return [ {
                            toolName: status.toolName,
                            message: status.toolName + (": " + (show(status.callsToday) + ("/" + (show(status.maxPerDay) + " daily calls used.")))),
                            severity: SevWarning.value
                        } ];
                    };
                    return [  ];
                })();
                return append1(dailyWarnings)(sessionWarnings);
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 448, column 10 - line 472, column 46): " + [ maybeConfig.constructor.name ]);
        };
    };
    return function __do() {
        var statuses = getAllRateLimitStatus();
        var customLimits = Effect_Ref.read(customLimitsRef)();
        return bind2(statuses)(collectWarnings(customLimits));
    };
})();
var getRemainingCalls = function (toolName) {
    return function __do() {
        var status = checkRateLimit(toolName)();
        return {
            remainingToday: max(0)(status.maxPerDay - status.callsToday | 0),
            remainingSession: (function () {
                if (status.maxPerSession instanceof Data_Maybe.Just) {
                    return max(0)(status.maxPerSession.value0 - status.callsThisSession | 0);
                };
                if (status.maxPerSession instanceof Data_Maybe.Nothing) {
                    return 999999;
                };
                throw new Error("Failed pattern match at Lattice.Services.Security.RateLimits (line 429, column 25 - line 431, column 26): " + [ status.maxPerSession.constructor.name ]);
            })()
        };
    };
};
var recordToolCall = function (toolName) {
    return function __do() {
        var stored = loadStoredLimits();
        var currentDaily = Data_Maybe.fromMaybe(0)(lookup(toolName)(stored.counts));
        var newCounts = insert(toolName)(currentDaily + 1 | 0)(stored.counts);
        saveStoredLimits({
            date: stored.date,
            lastReset: stored.lastReset,
            counts: newCounts
        })();
        var sessionCounts = Effect_Ref.read(sessionCountsRef)();
        var currentSession = Data_Maybe.fromMaybe(0)(lookup(toolName)(sessionCounts));
        var newSessionCounts = insert(toolName)(currentSession + 1 | 0)(sessionCounts);
        Effect_Ref.write(newSessionCounts)(sessionCountsRef)();
        saveSessionCounts(newSessionCounts)();
        var status = checkRateLimit(toolName)();
        return Effect_Console.log("[SECURITY] Rate limit recorded: " + (toolName + (" (today: " + (show(status.callsToday) + ("/" + (show(status.maxPerDay) + (", session: " + (show(status.callsThisSession) + ")"))))))))();
    };
};
export {
    SevWarning,
    SevCritical,
    checkRateLimit,
    recordToolCall,
    resetSessionLimit,
    resetAllSessionLimits,
    getAllRateLimitStatus,
    setRateLimitConfig,
    getRemainingCalls,
    checkRateLimitWarnings,
    defaultLimits,
    eqWarningSeverity,
    genericWarningSeverity_,
    showWarningSeverity
};
//# sourceMappingURL=index.js.map
