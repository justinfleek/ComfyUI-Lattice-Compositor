// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Common from "../Lattice.Services.Export.CameraExport.Formats.Common/index.js";
import * as Lattice_Services_Export_CameraExport_Matrix from "../Lattice.Services.Export.CameraExport.Matrix/index.js";
import * as Lattice_Services_Export_CameraExport_MotionAnalysis from "../Lattice.Services.Export.CameraExport.MotionAnalysis/index.js";
import * as Lattice_Services_Export_CameraExport_Types from "../Lattice.Services.Export.CameraExport.Types/index.js";
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var exportAsCameraCtrlPoses = function (camera) {
    return function (keyframes) {
        return function (frameCount) {
            return function (width) {
                return function (height) {
                    var widthN = Data_Int.toNumber(width);
                    var heightN = Data_Int.toNumber(height);
                    return Data_Array.mapWithIndex(function (frame) {
                        return function (v) {
                            var cam = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(camera)(keyframes)(frame);
                            var focalLengthMM = cam.focalLength * cam.zoom;
                            var fx = (focalLengthMM * widthN) / camera.filmSize;
                            var w2cFlat = Lattice_Services_Export_CameraExport_Matrix.computeW2CMatrixFlat(cam);
                            var aspect = widthN / heightN;
                            return append([ Data_Int.toNumber(frame), fx, fx, 0.5, 0.5, aspect, 0.0, 0.0 ])(w2cFlat);
                        };
                    })(Data_Array.range(0)(frameCount - 1 | 0));
                };
            };
        };
    };
};
var exportAsCameraCtrlPosesText = function (camera) {
    return function (keyframes) {
        return function (frameCount) {
            return function (width) {
                return function (height) {
                    var poses = exportAsCameraCtrlPoses(camera)(keyframes)(frameCount)(width)(height);
                    return Data_String_Common.joinWith("\x0a")(map(function (pose) {
                        return Data_String_Common.joinWith(" ")(map(show)(pose));
                    })(poses));
                };
            };
        };
    };
};
var detectRotationMotion = function (keyframes) {
    var $11 = {
        first: Data_Array.index(keyframes)(0),
        last: Data_Array.index(keyframes)(Data_Array.length(keyframes) - 1 | 0)
    };
    if ($11.first instanceof Data_Maybe.Just && $11.last instanceof Data_Maybe.Just) {
        var defaultVec = {
            x: 0.0,
            y: 0.0,
            z: 0.0
        };
        var firstOri = Data_Maybe.fromMaybe(defaultVec)($11.first.value0.orientation);
        var lastOri = Data_Maybe.fromMaybe(defaultVec)($11.last.value0.orientation);
        var deltaRx = lastOri.x - firstOri.x;
        var deltaRy = lastOri.y - firstOri.y;
        var deltaRz = lastOri.z - firstOri.z;
        var $12 = Data_Number.abs(deltaRy) > Data_Number.abs(deltaRx) && Data_Number.abs(deltaRy) > Data_Number.abs(deltaRz);
        if ($12) {
            var $13 = deltaRy > 0.0;
            if ($13) {
                return Lattice_Services_Export_CameraExport_Types.CameraCtrlRotateRight.value;
            };
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlRotateLeft.value;
        };
        var $14 = Data_Number.abs(deltaRx) > Data_Number.abs(deltaRz);
        if ($14) {
            var $15 = deltaRx > 0.0;
            if ($15) {
                return Lattice_Services_Export_CameraExport_Types.CameraCtrlRotateDown.value;
            };
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlRotateUp.value;
        };
        var $16 = deltaRz > 0.0;
        if ($16) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlRollRight.value;
        };
        return Lattice_Services_Export_CameraExport_Types.CameraCtrlRollLeft.value;
    };
    return Lattice_Services_Export_CameraExport_Types.CameraCtrlStatic.value;
};
var analyzeCameraMotionKF = function (keyframes) {
    var toMotionKeyframe = function (kf) {
        return {
            frame: kf.frame,
            position: kf.position,
            orientation: kf.orientation
        };
    };
    return Lattice_Services_Export_CameraExport_MotionAnalysis.analyzeCameraMotion(map(toMotionKeyframe)(keyframes));
};
var detectCameraCtrlMotionType = function (keyframes) {
    var motion = analyzeCameraMotionKF(keyframes);
    var $21 = !motion.hasPan && (!motion.hasZoom && !motion.hasRotation);
    if ($21) {
        return Lattice_Services_Export_CameraExport_Types.CameraCtrlStatic.value;
    };
    if (motion.hasZoom) {
        if (motion.zoomDirection instanceof Data_Maybe.Just && motion.zoomDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.ZoomIn) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveForward.value;
        };
        if (motion.zoomDirection instanceof Data_Maybe.Just && motion.zoomDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.ZoomOut) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveBackward.value;
        };
        if (motion.zoomDirection instanceof Data_Maybe.Nothing) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlStatic.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Export.CameraExport.Formats.CameraCtrl (line 52, column 7 - line 55, column 36): " + [ motion.zoomDirection.constructor.name ]);
    };
    if (motion.hasPan) {
        if (motion.panDirection instanceof Data_Maybe.Just && motion.panDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.PanLeft) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveLeft.value;
        };
        if (motion.panDirection instanceof Data_Maybe.Just && motion.panDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.PanRight) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveRight.value;
        };
        if (motion.panDirection instanceof Data_Maybe.Just && motion.panDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.PanUp) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveUp.value;
        };
        if (motion.panDirection instanceof Data_Maybe.Just && motion.panDirection.value0 instanceof Lattice_Services_Export_CameraExport_Types.PanDown) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlMoveDown.value;
        };
        if (motion.panDirection instanceof Data_Maybe.Nothing) {
            return Lattice_Services_Export_CameraExport_Types.CameraCtrlStatic.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Export.CameraExport.Formats.CameraCtrl (line 57, column 7 - line 62, column 36): " + [ motion.panDirection.constructor.name ]);
    };
    if (motion.hasRotation) {
        return detectRotationMotion(keyframes);
    };
    return Lattice_Services_Export_CameraExport_Types.CameraCtrlStatic.value;
};
var exportToCameraCtrl = function (keyframes) {
    return function (frameCount) {
        var motionType = detectCameraCtrlMotionType(keyframes);
        var motion = analyzeCameraMotionKF(keyframes);
        var speed = (function () {
            if (motion.hasZoom) {
                return Lattice_Services_Export_CameraExport_Formats_Common.min(100)(Lattice_Services_Export_CameraExport_Formats_Common.round(motion.zoomMagnitude / 5.0));
            };
            if (motion.hasPan) {
                return Lattice_Services_Export_CameraExport_Formats_Common.min(100)(Lattice_Services_Export_CameraExport_Formats_Common.round(motion.panMagnitude / 3.0));
            };
            if (motion.hasRotation) {
                return Lattice_Services_Export_CameraExport_Formats_Common.min(100)(Lattice_Services_Export_CameraExport_Formats_Common.round(motion.rotationMagnitude * 2.0));
            };
            return 0;
        })();
        return {
            motionType: motionType,
            speed: speed,
            frameLength: frameCount
        };
    };
};
export {
    detectCameraCtrlMotionType,
    exportToCameraCtrl,
    exportAsCameraCtrlPoses,
    exportAsCameraCtrlPosesText
};
//# sourceMappingURL=index.js.map
