// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as $$Math from "../Math/index.js";
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var ModSize = /* #__PURE__ */ (function () {
    function ModSize() {

    };
    ModSize.value = new ModSize();
    return ModSize;
})();
var ModOpacity = /* #__PURE__ */ (function () {
    function ModOpacity() {

    };
    ModOpacity.value = new ModOpacity();
    return ModOpacity;
})();
var ModColorR = /* #__PURE__ */ (function () {
    function ModColorR() {

    };
    ModColorR.value = new ModColorR();
    return ModColorR;
})();
var ModColorG = /* #__PURE__ */ (function () {
    function ModColorG() {

    };
    ModColorG.value = new ModColorG();
    return ModColorG;
})();
var ModColorB = /* #__PURE__ */ (function () {
    function ModColorB() {

    };
    ModColorB.value = new ModColorB();
    return ModColorB;
})();
var ModVelocity = /* #__PURE__ */ (function () {
    function ModVelocity() {

    };
    ModVelocity.value = new ModVelocity();
    return ModVelocity;
})();
var showModulationType = {
    show: function (v) {
        if (v instanceof ModSize) {
            return "ModSize";
        };
        if (v instanceof ModOpacity) {
            return "ModOpacity";
        };
        if (v instanceof ModColorR) {
            return "ModColorR";
        };
        if (v instanceof ModColorG) {
            return "ModColorG";
        };
        if (v instanceof ModColorB) {
            return "ModColorB";
        };
        if (v instanceof ModVelocity) {
            return "ModVelocity";
        };
        throw new Error("Failed pattern match at Lattice.Services.Particles.Modulation (line 51, column 1 - line 57, column 35): " + [ v.constructor.name ]);
    }
};
var pulseWave = [ {
    t: 0.0,
    value: 0.0
}, {
    t: 0.25,
    value: 1.0
}, {
    t: 0.75,
    value: 1.0
}, {
    t: 1.0,
    value: 0.0
} ];
var linearFadeOut = [ {
    t: 0.0,
    value: 1.0
}, {
    t: 1.0,
    value: 0.0
} ];
var linearFadeIn = [ {
    t: 0.0,
    value: 0.0
}, {
    t: 1.0,
    value: 1.0
} ];
var lerp = function (a) {
    return function (b) {
        return function (t) {
            return a + (b - a) * t;
        };
    };
};
var findSegmentIndex = function (points) {
    return function (t) {
        var n = Data_Array.length(points);
        var go = function ($copy_i) {
            var $tco_done = false;
            var $tco_result;
            function $tco_loop(i) {
                if ((i + 1 | 0) >= n) {
                    $tco_done = true;
                    return i;
                };
                if (Data_Boolean.otherwise) {
                    var v = Data_Array.index(points)(i + 1 | 0);
                    if (v instanceof Data_Maybe.Just && v.value0.t > t) {
                        $tco_done = true;
                        return i;
                    };
                    $copy_i = i + 1 | 0;
                    return;
                };
                throw new Error("Failed pattern match at Lattice.Services.Particles.Modulation (line 103, column 5 - line 108, column 28): " + [ i.constructor.name ]);
            };
            while (!$tco_done) {
                $tco_result = $tco_loop($copy_i);
            };
            return $tco_result;
        };
        return go(0);
    };
};
var filter = function (pred) {
    return function (arr) {
        return Data_Array.foldl(function (acc) {
            return function (x) {
                var $29 = pred(x);
                if ($29) {
                    return append(acc)([ x ]);
                };
                return acc;
            };
        })([  ])(arr);
    };
};
var eqModulationType = {
    eq: function (x) {
        return function (y) {
            if (x instanceof ModSize && y instanceof ModSize) {
                return true;
            };
            if (x instanceof ModOpacity && y instanceof ModOpacity) {
                return true;
            };
            if (x instanceof ModColorR && y instanceof ModColorR) {
                return true;
            };
            if (x instanceof ModColorG && y instanceof ModColorG) {
                return true;
            };
            if (x instanceof ModColorB && y instanceof ModColorB) {
                return true;
            };
            if (x instanceof ModVelocity && y instanceof ModVelocity) {
                return true;
            };
            return false;
        };
    }
};
var defaultModulationResult = /* #__PURE__ */ (function () {
    return {
        sizeMult: 1.0,
        opacityMult: 1.0,
        colorMult: new Data_Tuple.Tuple(1.0, new Data_Tuple.Tuple(1.0, 1.0)),
        velocityMult: 1.0
    };
})();
var clamp01 = function (x) {
    return $$Math.max(0.0)($$Math.min(1.0)(x));
};
var evaluateLinear = function (points) {
    return function (t) {
        var v = Data_Array.length(points);
        if (v === 0) {
            return 1.0;
        };
        if (v === 1) {
            return Data_Maybe.fromMaybe(1.0)(map(function (v1) {
                return v1.value;
            })(Data_Array.index(points)(0)));
        };
        var clampedT = clamp01(t);
        var segIdx = findSegmentIndex(points)(clampedT);
        var v1 = new Data_Tuple.Tuple(Data_Array.index(points)(segIdx), Data_Array.index(points)(segIdx + 1 | 0));
        if (v1.value0 instanceof Data_Maybe.Just && v1.value1 instanceof Data_Maybe.Just) {
            var range = v1.value1.value0.t - v1.value0.value0.t;
            var localT = (function () {
                var $34 = range > 1.0e-4;
                if ($34) {
                    return (clampedT - v1.value0.value0.t) / range;
                };
                return 0.0;
            })();
            return lerp(v1.value0.value0.value)(v1.value1.value0.value)(clamp01(localT));
        };
        if (v1.value0 instanceof Data_Maybe.Just && v1.value1 instanceof Data_Maybe.Nothing) {
            return v1.value0.value0.value;
        };
        return 1.0;
    };
};
var modulateSize = function (curve) {
    return function (lifeRatio) {
        return $$Math.max(0.0)(evaluateLinear(curve)(lifeRatio));
    };
};
var modulateVelocity = function (curve) {
    return function (lifeRatio) {
        return $$Math.max(0.0)(evaluateLinear(curve)(lifeRatio));
    };
};
var modulateColor = function (curve) {
    return function (lifeRatio) {
        return clamp01(evaluateLinear(curve)(lifeRatio));
    };
};
var modulateOpacity = function (curve) {
    return function (lifeRatio) {
        return clamp01(evaluateLinear(curve)(lifeRatio));
    };
};
var applyModulations = function (mods) {
    return function (emitterId) {
        return function (lifeRatio) {
            var filterRelevant = function (ms) {
                return function (eid) {
                    return filter(function (m) {
                        return m.enabled && (m.emitterId === "*" || m.emitterId === eid);
                    })(ms);
                };
            };
            var relevantMods = filterRelevant(mods)(emitterId);
            var combineModulation = function (lr) {
                return function (result) {
                    return function (mod) {
                        if (mod.target instanceof ModSize) {
                            return {
                                opacityMult: result.opacityMult,
                                colorMult: result.colorMult,
                                velocityMult: result.velocityMult,
                                sizeMult: result.sizeMult * modulateSize(mod.curve)(lr)
                            };
                        };
                        if (mod.target instanceof ModOpacity) {
                            return {
                                sizeMult: result.sizeMult,
                                colorMult: result.colorMult,
                                velocityMult: result.velocityMult,
                                opacityMult: result.opacityMult * modulateOpacity(mod.curve)(lr)
                            };
                        };
                        if (mod.target instanceof ModColorR) {
                            var newR = result.colorMult.value0 * modulateColor(mod.curve)(lr);
                            return {
                                sizeMult: result.sizeMult,
                                opacityMult: result.opacityMult,
                                velocityMult: result.velocityMult,
                                colorMult: new Data_Tuple.Tuple(newR, new Data_Tuple.Tuple(result.colorMult.value1.value0, result.colorMult.value1.value1))
                            };
                        };
                        if (mod.target instanceof ModColorG) {
                            var newG = result.colorMult.value1.value0 * modulateColor(mod.curve)(lr);
                            return {
                                sizeMult: result.sizeMult,
                                opacityMult: result.opacityMult,
                                velocityMult: result.velocityMult,
                                colorMult: new Data_Tuple.Tuple(result.colorMult.value0, new Data_Tuple.Tuple(newG, result.colorMult.value1.value1))
                            };
                        };
                        if (mod.target instanceof ModColorB) {
                            var newB = result.colorMult.value1.value1 * modulateColor(mod.curve)(lr);
                            return {
                                sizeMult: result.sizeMult,
                                opacityMult: result.opacityMult,
                                velocityMult: result.velocityMult,
                                colorMult: new Data_Tuple.Tuple(result.colorMult.value0, new Data_Tuple.Tuple(result.colorMult.value1.value0, newB))
                            };
                        };
                        if (mod.target instanceof ModVelocity) {
                            return {
                                sizeMult: result.sizeMult,
                                opacityMult: result.opacityMult,
                                colorMult: result.colorMult,
                                velocityMult: result.velocityMult * modulateVelocity(mod.curve)(lr)
                            };
                        };
                        throw new Error("Failed pattern match at Lattice.Services.Particles.Modulation (line 173, column 7 - line 191, column 88): " + [ mod.target.constructor.name ]);
                    };
                };
            };
            return Data_Array.foldl(combineModulation(lifeRatio))(defaultModulationResult)(relevantMods);
        };
    };
};
export {
    ModSize,
    ModOpacity,
    ModColorR,
    ModColorG,
    ModColorB,
    ModVelocity,
    defaultModulationResult,
    evaluateLinear,
    modulateSize,
    modulateOpacity,
    modulateColor,
    modulateVelocity,
    applyModulations,
    linearFadeOut,
    linearFadeIn,
    pulseWave,
    eqModulationType,
    showModulationType
};
//# sourceMappingURL=index.js.map
