// Generated by purs version 0.15.15
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Common from "../Lattice.Services.Export.CameraExport.Formats.Common/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Full from "../Lattice.Services.Export.CameraExport.Formats.Full/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Uni3C from "../Lattice.Services.Export.CameraExport.Formats.Uni3C/index.js";
import * as Lattice_Services_Export_CameraExport_Matrix from "../Lattice.Services.Export.CameraExport.Matrix/index.js";
import * as Lattice_Services_Export_CameraExport_MotionAnalysis from "../Lattice.Services.Export.CameraExport.MotionAnalysis/index.js";
import * as Lattice_Services_Export_CameraExport_Types from "../Lattice.Services.Export.CameraExport.Types/index.js";
import * as Test_Lattice_TestHelpers from "../Test.Lattice.TestHelpers/index.js";
import * as Test_Spec from "../Test.Spec/index.js";
import * as Test_Spec_Assertions from "../Test.Spec.Assertions/index.js";
var describe = /* #__PURE__ */ Test_Spec.describe(Data_Identity.monadIdentity);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(/* #__PURE__ */ Test_Spec.bindSpecT(Data_Identity.bindIdentity));
var it = /* #__PURE__ */ Test_Spec.it(Data_Identity.monadIdentity)(Test_Spec.exampleMUnit);
var shouldEqual = /* #__PURE__ */ Test_Spec_Assertions.shouldEqual(Effect_Aff.monadThrowAff);
var shouldEqual1 = /* #__PURE__ */ shouldEqual(Data_Show.showInt)(Data_Eq.eqInt);
var discard2 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var shouldEqual2 = /* #__PURE__ */ shouldEqual(Data_Show.showBoolean)(Data_Eq.eqBoolean);
var eq = /* #__PURE__ */ Data_Eq.eq(Lattice_Services_Export_CameraExport_Types.eqUni3CTrajType);
var fail = /* #__PURE__ */ Test_Spec_Assertions.fail(Effect_Aff.monadThrowAff);
var mkMotionKF = function (frame) {
    return function (pos) {
        return function (ori) {
            return {
                frame: frame,
                position: pos,
                orientation: ori
            };
        };
    };
};
var mkKeyframe = function (frame) {
    return function (pos) {
        return function (ori) {
            return {
                frame: frame,
                position: pos,
                orientation: ori,
                focalLength: Data_Maybe.Nothing.value,
                zoom: Data_Maybe.Nothing.value,
                focusDistance: Data_Maybe.Nothing.value
            };
        };
    };
};
var defaultCamera = {
    position: {
        x: 0.0,
        y: 0.0,
        z: 0.0
    },
    orientation: {
        x: 0.0,
        y: 0.0,
        z: 0.0
    },
    focalLength: 50.0,
    filmSize: 36.0,
    zoom: 1.0,
    focusDistance: 1000.0,
    cameraType: "perspective"
};
var fullExportTests = /* #__PURE__ */ describe("exportCameraMatrices")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("produces correct number of frames")(/* #__PURE__ */ (function () {
    var kf0 = mkKeyframe(0)(new Data_Maybe.Just({
        x: 0.0,
        y: 0.0,
        z: 0.0
    }))(Data_Maybe.Nothing.value);
    var result = Lattice_Services_Export_CameraExport_Formats_Full.exportCameraMatrices(defaultCamera)([ kf0 ])({
        frameCount: 10,
        width: 512,
        height: 512,
        fps: 24.0
    });
    return shouldEqual1(Data_Array.length(result.frames))(10);
})()))(function () {
    return it("metadata matches input")((function () {
        var kf0 = mkKeyframe(0)(new Data_Maybe.Just({
            x: 0.0,
            y: 0.0,
            z: 0.0
        }))(Data_Maybe.Nothing.value);
        var result = Lattice_Services_Export_CameraExport_Formats_Full.exportCameraMatrices(defaultCamera)([ kf0 ])({
            frameCount: 10,
            width: 1024,
            height: 768,
            fps: 30.0
        });
        return discard2(shouldEqual1(result.metadata.width)(1024))(function () {
            return discard2(shouldEqual1(result.metadata.height)(768))(function () {
                return discard2(Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(30.0)(result.metadata.fps))(function () {
                    return shouldEqual1(result.metadata.totalFrames)(10);
                });
            });
        });
    })());
}));
var interpolateCameraAtFrameTests = /* #__PURE__ */ describe("interpolateCameraAtFrame")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("returns camera defaults when no keyframes")(/* #__PURE__ */ (function () {
    var cam = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(defaultCamera)([  ])(0);
    return discard2(Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(cam.position.x))(function () {
        return discard2(Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(cam.position.y))(function () {
            return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(50.0)(cam.focalLength);
        });
    });
})()))(function () {
    return discard1(it("interpolates position between keyframes")((function () {
        var kf0 = mkKeyframe(0)(new Data_Maybe.Just({
            x: 0.0,
            y: 0.0,
            z: 0.0
        }))(Data_Maybe.Nothing.value);
        var kf10 = mkKeyframe(10)(new Data_Maybe.Just({
            x: 100.0,
            y: 200.0,
            z: 0.0
        }))(Data_Maybe.Nothing.value);
        var cam = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(defaultCamera)([ kf0, kf10 ])(5);
        return discard2(Test_Lattice_TestHelpers.assertCloseTo(1.0)(50.0)(cam.position.x))(function () {
            return Test_Lattice_TestHelpers.assertCloseTo(1.0)(100.0)(cam.position.y);
        });
    })()))(function () {
        return it("returns exact keyframe values at keyframe frame")((function () {
            var kf = mkKeyframe(5)(new Data_Maybe.Just({
                x: 42.0,
                y: 84.0,
                z: 0.0
            }))(Data_Maybe.Nothing.value);
            var cam = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(defaultCamera)([ kf ])(5);
            return discard2(Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(42.0)(cam.position.x))(function () {
                return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(84.0)(cam.position.y);
            });
        })());
    });
}));
var uni3CTests = /* #__PURE__ */ (function () {
    return describe("Uni3C export")(discard1(it("detectUni3CTrajectoryType returns free1 for no motion")(shouldEqual(Lattice_Services_Export_CameraExport_Types.showUni3CTrajType)(Lattice_Services_Export_CameraExport_Types.eqUni3CTrajType)(Lattice_Services_Export_CameraExport_Formats_Uni3C.detectUni3CTrajectoryType([  ]))(Lattice_Services_Export_CameraExport_Types.Uni3CFree1.value)))(function () {
        return it("exportToUni3C produces trajectory data")((function () {
            var kf0 = mkKeyframe(0)(new Data_Maybe.Just({
                x: 0.0,
                y: 0.0,
                z: 0.0
            }))(Data_Maybe.Nothing.value);
            var kf10 = mkKeyframe(10)(new Data_Maybe.Just({
                x: 100.0,
                y: 50.0,
                z: -200.0
            }))(new Data_Maybe.Just({
                x: 30.0,
                y: 45.0,
                z: 0.0
            }));
            var result = Lattice_Services_Export_CameraExport_Formats_Uni3C.exportToUni3C(defaultCamera)([ kf0, kf10 ])(11)(512)(512);
            return shouldEqual2(eq(result.trajType)(Lattice_Services_Export_CameraExport_Types.Uni3CFree1.value) || (eq(result.trajType)(Lattice_Services_Export_CameraExport_Types.Uni3COrbit.value) || eq(result.trajType)(Lattice_Services_Export_CameraExport_Types.Uni3CCustom.value)))(true);
        })());
    }));
})();
var computeProjectionMatrixTests = /* #__PURE__ */ describe("computeProjectionMatrix")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("returns a 4x4 matrix")(/* #__PURE__ */ (function () {
    var m = Lattice_Services_Export_CameraExport_Matrix.computeProjectionMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera)(1.5)(0.1)(1000.0);
    return discard2(shouldEqual1(Data_Array.length(m))(4))(function () {
        var v = Data_Array.index(m)(0);
        if (v instanceof Data_Maybe.Just) {
            return shouldEqual1(Data_Array.length(v.value0))(4);
        };
        if (v instanceof Data_Maybe.Nothing) {
            return fail("Expected row 0");
        };
        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 166, column 7 - line 168, column 41): " + [ v.constructor.name ]);
    });
})()))(function () {
    return discard1(it("perspective divide element at [3][2] is -1")((function () {
        var m = Lattice_Services_Export_CameraExport_Matrix.computeProjectionMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera)(1.5)(0.1)(1000.0);
        var v = Data_Array.index(m)(3);
        if (v instanceof Data_Maybe.Just) {
            var v1 = Data_Array.index(v.value0)(2);
            if (v1 instanceof Data_Maybe.Just) {
                return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(-1.0)(v1.value0);
            };
            if (v1 instanceof Data_Maybe.Nothing) {
                return fail("Expected element");
            };
            throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 173, column 21 - line 175, column 45): " + [ v1.constructor.name ]);
        };
        if (v instanceof Data_Maybe.Nothing) {
            return fail("Expected row 3");
        };
        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 172, column 7 - line 176, column 41): " + [ v.constructor.name ]);
    })()))(function () {
        return it("[3][3] is zero")((function () {
            var m = Lattice_Services_Export_CameraExport_Matrix.computeProjectionMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera)(1.5)(0.1)(1000.0);
            var v = Data_Array.index(m)(3);
            if (v instanceof Data_Maybe.Just) {
                var v1 = Data_Array.index(v.value0)(3);
                if (v1 instanceof Data_Maybe.Just) {
                    return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(v1.value0);
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return fail("Expected element");
                };
                throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 181, column 21 - line 183, column 45): " + [ v1.constructor.name ]);
            };
            if (v instanceof Data_Maybe.Nothing) {
                return fail("Expected row 3");
            };
            throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 180, column 7 - line 184, column 41): " + [ v.constructor.name ]);
        })());
    });
}));
var analyzeCameraMotionTests = /* #__PURE__ */ describe("analyzeCameraMotion")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("returns no motion for empty keyframes")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Export_CameraExport_MotionAnalysis.analyzeCameraMotion([  ]);
    return discard2(shouldEqual2(result.hasPan)(false))(function () {
        return shouldEqual2(result.hasZoom)(false);
    });
})()))(function () {
    return discard1(it("returns no motion for single keyframe")((function () {
        var kf = mkMotionKF(0)(new Data_Maybe.Just({
            x: 0.0,
            y: 0.0,
            z: 0.0
        }))(Data_Maybe.Nothing.value);
        var result = Lattice_Services_Export_CameraExport_MotionAnalysis.analyzeCameraMotion([ kf ]);
        return discard2(shouldEqual2(result.hasPan)(false))(function () {
            return shouldEqual2(result.hasZoom)(false);
        });
    })()))(function () {
        return it("magnitudes are non-negative")((function () {
            var kf0 = mkMotionKF(0)(new Data_Maybe.Just({
                x: 0.0,
                y: 0.0,
                z: 0.0
            }))(Data_Maybe.Nothing.value);
            var kf10 = mkMotionKF(10)(new Data_Maybe.Just({
                x: 100.0,
                y: 0.0,
                z: -50.0
            }))(Data_Maybe.Nothing.value);
            var result = Lattice_Services_Export_CameraExport_MotionAnalysis.analyzeCameraMotion([ kf0, kf10 ]);
            return discard2(shouldEqual2(result.panMagnitude >= 0.0)(true))(function () {
                return shouldEqual2(result.zoomMagnitude >= 0.0)(true);
            });
        })());
    });
}));
var allOfImpl = function ($copy_f) {
    return function ($copy_arr) {
        return function ($copy_i) {
            var $tco_var_f = $copy_f;
            var $tco_var_arr = $copy_arr;
            var $tco_done = false;
            var $tco_result;
            function $tco_loop(f, arr, i) {
                var $49 = i >= Data_Array.length(arr);
                if ($49) {
                    $tco_done = true;
                    return true;
                };
                var v = Data_Array.index(arr)(i);
                if (v instanceof Data_Maybe.Nothing) {
                    $tco_done = true;
                    return true;
                };
                if (v instanceof Data_Maybe.Just) {
                    var $51 = f(v.value0);
                    if ($51) {
                        $tco_var_f = f;
                        $tco_var_arr = arr;
                        $copy_i = i + 1 | 0;
                        return;
                    };
                    $tco_done = true;
                    return false;
                };
                throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 292, column 8 - line 294, column 61): " + [ v.constructor.name ]);
            };
            while (!$tco_done) {
                $tco_result = $tco_loop($tco_var_f, $tco_var_arr, $copy_i);
            };
            return $tco_result;
        };
    };
};
var allOf = function (f) {
    return function (arr) {
        return allOfImpl(f)(arr)(0);
    };
};
var allMatrixFinite = function (rows) {
    return allOf(function (row) {
        return allOf(Data_Number["isFinite"])(row);
    })(rows);
};
var computeViewMatrixTests = /* #__PURE__ */ describe("computeViewMatrix")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("returns a 4x4 matrix")(/* #__PURE__ */ (function () {
    var m = Lattice_Services_Export_CameraExport_Matrix.computeViewMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera);
    return discard2(shouldEqual1(Data_Array.length(m))(4))(function () {
        var v = Data_Array.index(m)(0);
        if (v instanceof Data_Maybe.Just) {
            return shouldEqual1(Data_Array.length(v.value0))(4);
        };
        if (v instanceof Data_Maybe.Nothing) {
            return fail("Expected row 0");
        };
        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 109, column 7 - line 111, column 41): " + [ v.constructor.name ]);
    });
})()))(function () {
    return discard1(it("last row is [0,0,0,1]")((function () {
        var m = Lattice_Services_Export_CameraExport_Matrix.computeViewMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera);
        var v = Data_Array.index(m)(3);
        if (v instanceof Data_Maybe.Just) {
            return discard2((function () {
                var v1 = Data_Array.index(v.value0)(0);
                if (v1 instanceof Data_Maybe.Just) {
                    return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(v1.value0);
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return fail("Expected element");
                };
                throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 117, column 11 - line 119, column 47): " + [ v1.constructor.name ]);
            })())(function () {
                return discard2((function () {
                    var v1 = Data_Array.index(v.value0)(1);
                    if (v1 instanceof Data_Maybe.Just) {
                        return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(v1.value0);
                    };
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return fail("Expected element");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 120, column 11 - line 122, column 47): " + [ v1.constructor.name ]);
                })())(function () {
                    return discard2((function () {
                        var v1 = Data_Array.index(v.value0)(2);
                        if (v1 instanceof Data_Maybe.Just) {
                            return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(0.0)(v1.value0);
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected element");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 123, column 11 - line 125, column 47): " + [ v1.constructor.name ]);
                    })())(function () {
                        var v1 = Data_Array.index(v.value0)(3);
                        if (v1 instanceof Data_Maybe.Just) {
                            return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(1.0)(v1.value0);
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected element");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 126, column 11 - line 128, column 47): " + [ v1.constructor.name ]);
                    });
                });
            });
        };
        if (v instanceof Data_Maybe.Nothing) {
            return fail("Expected row 3");
        };
        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 115, column 7 - line 129, column 41): " + [ v.constructor.name ]);
    })()))(function () {
        return discard1(it("identity rotation at zero angles")((function () {
            var m = Lattice_Services_Export_CameraExport_Matrix.computeViewMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera);
            return discard2((function () {
                var v = Data_Array.index(m)(0);
                if (v instanceof Data_Maybe.Just) {
                    var v1 = Data_Array.index(v.value0)(0);
                    if (v1 instanceof Data_Maybe.Just) {
                        return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(1.0)(v1.value0);
                    };
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return fail("Expected element");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 135, column 21 - line 137, column 45): " + [ v1.constructor.name ]);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return fail("Expected row");
                };
                throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 134, column 7 - line 138, column 39): " + [ v.constructor.name ]);
            })())(function () {
                return discard2((function () {
                    var v = Data_Array.index(m)(1);
                    if (v instanceof Data_Maybe.Just) {
                        var v1 = Data_Array.index(v.value0)(1);
                        if (v1 instanceof Data_Maybe.Just) {
                            return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(1.0)(v1.value0);
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected element");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 140, column 21 - line 142, column 45): " + [ v1.constructor.name ]);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected row");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 139, column 7 - line 143, column 39): " + [ v.constructor.name ]);
                })())(function () {
                    var v = Data_Array.index(m)(2);
                    if (v instanceof Data_Maybe.Just) {
                        var v1 = Data_Array.index(v.value0)(2);
                        if (v1 instanceof Data_Maybe.Just) {
                            return Test_Lattice_TestHelpers.assertCloseTo(1.0e-10)(1.0)(v1.value0);
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected element");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 145, column 21 - line 147, column 45): " + [ v1.constructor.name ]);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected row");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Export.CameraExportAdv (line 144, column 7 - line 148, column 39): " + [ v.constructor.name ]);
                });
            });
        })()))(function () {
            return it("all values are finite")((function () {
                var m = Lattice_Services_Export_CameraExport_Matrix.computeViewMatrix(Lattice_Services_Export_CameraExport_Types.defaultInterpolatedCamera);
                var allFinite = allMatrixFinite(m);
                return shouldEqual2(allFinite)(true);
            })());
        });
    });
}));
var spec = /* #__PURE__ */ describe("CameraExportAdv")(/* #__PURE__ */ discard1(computeViewMatrixTests)(function () {
    return discard1(computeProjectionMatrixTests)(function () {
        return discard1(interpolateCameraAtFrameTests)(function () {
            return discard1(analyzeCameraMotionTests)(function () {
                return discard1(uni3CTests)(function () {
                    return fullExportTests;
                });
            });
        });
    });
}));
export {
    spec
};
//# sourceMappingURL=index.js.map
