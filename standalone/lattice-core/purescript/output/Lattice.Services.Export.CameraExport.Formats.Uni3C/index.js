// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Common from "../Lattice.Services.Export.CameraExport.Formats.Common/index.js";
import * as Lattice_Services_Export_CameraExport_MotionAnalysis from "../Lattice.Services.Export.CameraExport.MotionAnalysis/index.js";
import * as Lattice_Services_Export_CameraExport_Types from "../Lattice.Services.Export.CameraExport.Types/index.js";
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var notEq = /* #__PURE__ */ Data_Eq.notEq(Lattice_Services_Export_CameraExport_Types.eqUni3CTrajType);
var analyzeCameraMotionKF = function (keyframes) {
    var toMotionKeyframe = function (kf) {
        return {
            frame: kf.frame,
            position: kf.position,
            orientation: kf.orientation
        };
    };
    return Lattice_Services_Export_CameraExport_MotionAnalysis.analyzeCameraMotion(map(toMotionKeyframe)(keyframes));
};
var detectUni3CTrajectoryType = function (keyframes) {
    var motion = analyzeCameraMotionKF(keyframes);
    var $9 = motion.hasOrbit && motion.orbitMagnitude > 45.0;
    if ($9) {
        return Lattice_Services_Export_CameraExport_Types.Uni3COrbit.value;
    };
    var $10 = motion.hasPan && motion.hasZoom;
    if ($10) {
        return Lattice_Services_Export_CameraExport_Types.Uni3CCustom.value;
    };
    var $11 = !motion.hasPan && (!motion.hasZoom && !motion.hasOrbit);
    if ($11) {
        return Lattice_Services_Export_CameraExport_Types.Uni3CFree1.value;
    };
    return Lattice_Services_Export_CameraExport_Types.Uni3CCustom.value;
};
var exportToUni3C = function (camera) {
    return function (keyframes) {
        return function (frameCount) {
            return function (compWidth) {
                return function (compHeight) {
                    var detectedType = detectUni3CTrajectoryType(keyframes);
                    var $12 = notEq(detectedType)(Lattice_Services_Export_CameraExport_Types.Uni3CCustom.value);
                    if ($12) {
                        return {
                            trajType: detectedType,
                            customTrajectory: Data_Maybe.Nothing.value
                        };
                    };
                    var baseCamera = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(camera)(keyframes)(0);
                    var trajectory = Data_Array.mapWithIndex(function (frame) {
                        return function (v) {
                            var cam = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(camera)(keyframes)(frame);
                            return {
                                zoom: cam.zoom / baseCamera.zoom,
                                xOffset: (cam.position.x - baseCamera.position.x) / Data_Int.toNumber(compWidth),
                                yOffset: (cam.position.y - baseCamera.position.y) / Data_Int.toNumber(compHeight),
                                zOffset: (cam.position.z - baseCamera.position.z) / 1000.0,
                                pitch: cam.rotation.x,
                                yaw: cam.rotation.y,
                                roll: cam.rotation.z
                            };
                        };
                    })(Data_Array.range(0)(frameCount - 1 | 0));
                    return {
                        trajType: Lattice_Services_Export_CameraExport_Types.Uni3CCustom.value,
                        customTrajectory: new Data_Maybe.Just(trajectory)
                    };
                };
            };
        };
    };
};
export {
    detectUni3CTrajectoryType,
    exportToUni3C
};
//# sourceMappingURL=index.js.map
