// Generated by purs version 0.15.15
import * as Control_Category from "../Control.Category/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Argonaut_Parser from "../Data.Argonaut.Parser/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_CodePoints from "../Data.String.CodePoints/index.js";
import * as Data_String_CodeUnits from "../Data.String.CodeUnits/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_String_Regex from "../Data.String.Regex/index.js";
import * as Data_String_Regex_Flags from "../Data.String.Regex.Flags/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unfoldable from "../Data.Unfoldable/index.js";
import * as Foreign_Object from "../Foreign.Object/index.js";
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var elem = /* #__PURE__ */ Data_Array.elem(Data_Eq.eqString);
var toUnfoldable = /* #__PURE__ */ Foreign_Object.toUnfoldable(Data_Unfoldable.unfoldableArray);
var toLower = Data_String_Common.toLower;
var take = function (n) {
    return function (str) {
        return Data_String_CodeUnits.take(n)(str);
    };
};
var removeNullBytes = function (str) {
    var chars = Data_String_CodeUnits.toCharArray(str);
    var filtered = Data_Array.filter(function (c) {
        return c !== "\x00";
    })(chars);
    return foldl(function (acc) {
        return function (c) {
            return acc + Data_String_CodeUnits.singleton(c);
        };
    })("")(filtered);
};
var sanitizeString = function (str) {
    return function (opts) {
        return function (state) {
            var $51 = Data_String_CodePoints.length(str) > opts.maxStringLength;
            if ($51) {
                return new Data_Either.Left("String exceeds maximum length: " + (show(Data_String_CodePoints.length(str)) + (" bytes (max: " + (show(opts.maxStringLength) + ")"))));
            };
            var state1 = {
                warnings: state.warnings,
                stats: {
                    depth: state.stats.depth,
                    prototypeKeysRemoved: state.stats.prototypeKeysRemoved,
                    totalArrayElements: state.stats.totalArrayElements,
                    totalKeys: state.stats.totalKeys,
                    maxStringLength: max(state.stats.maxStringLength)(Data_String_CodePoints.length(str))
                }
            };
            var v = (function () {
                var $52 = opts.removeNullBytes && Data_String_CodeUnits.contains("\x00")(str);
                if ($52) {
                    return new Data_Tuple.Tuple(removeNullBytes(str), {
                        stats: state1.stats,
                        warnings: append1(state1.warnings)([ "Null bytes removed from string" ])
                    });
                };
                return new Data_Tuple.Tuple(str, state1);
            })();
            return new Data_Either.Right(new Data_Tuple.Tuple(Data_Argonaut_Core.fromString(v.value0), v.value1));
        };
    };
};
var prototypeKeys = [ "__proto__", "constructor", "prototype", "__defineGetter__", "__defineSetter__", "__lookupGetter__", "__lookupSetter__" ];
var mkError = function (err) {
    return function (stats) {
        return function (warnings) {
            return {
                valid: false,
                dat: Data_Maybe.Nothing.value,
                err: new Data_Maybe.Just(err),
                warnings: warnings,
                stats: stats
            };
        };
    };
};
var maxBracketDepth = function (str) {
    var countBrackets = function (acc) {
        return function (c) {
            if (c === "{" || c === "[") {
                var newCurrent = acc.current + 1 | 0;
                return {
                    max: max(acc.max)(newCurrent),
                    current: newCurrent
                };
            };
            if (c === "}" || c === "]") {
                return {
                    max: acc.max,
                    current: acc.current - 1 | 0
                };
            };
            if (Data_Boolean.otherwise) {
                return acc;
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 342, column 5 - line 348, column 24): " + [ acc.constructor.name, c.constructor.name ]);
        };
    };
    var chars = Data_String_CodeUnits.toCharArray(str);
    return (function (v) {
        return v.max;
    })(foldl(countBrackets)({
        max: 0,
        current: 0
    })(chars));
};
var map = function (f) {
    return function (arr) {
        return map1(f)(arr);
    };
};
var $$isFinite = function (n) {
    var infinity = 1.0 / 0.0;
    return n === n && (n !== infinity && n !== -infinity);
};
var sanitizeValue = function (json) {
    return function (opts) {
        return function (state) {
            return function (depth) {
                var state1 = {
                    warnings: state.warnings,
                    stats: {
                        maxStringLength: state.stats.maxStringLength,
                        prototypeKeysRemoved: state.stats.prototypeKeysRemoved,
                        totalArrayElements: state.stats.totalArrayElements,
                        totalKeys: state.stats.totalKeys,
                        depth: max(state.stats.depth)(depth)
                    }
                };
                var $58 = depth > opts.maxDepth;
                if ($58) {
                    return new Data_Either.Left("Maximum nesting depth exceeded: " + (show(opts.maxDepth) + " levels"));
                };
                var $59 = Data_Argonaut_Core.isNull(json);
                if ($59) {
                    return new Data_Either.Right(new Data_Tuple.Tuple(json, state1));
                };
                var $60 = Data_Argonaut_Core.isBoolean(json);
                if ($60) {
                    return new Data_Either.Right(new Data_Tuple.Tuple(json, state1));
                };
                var $61 = Data_Argonaut_Core.isNumber(json);
                if ($61) {
                    var v = Data_Argonaut_Core.toNumber(json);
                    if (v instanceof Data_Maybe.Just) {
                        var $63 = $$isFinite(v.value0);
                        if ($63) {
                            return new Data_Either.Right(new Data_Tuple.Tuple(json, state1));
                        };
                        return new Data_Either.Left("Non-finite number is not valid JSON: " + show1(v.value0));
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return new Data_Either.Left("Failed to extract number from JSON");
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 189, column 10 - line 194, column 59): " + [ v.constructor.name ]);
                };
                var $65 = Data_Argonaut_Core.isString(json);
                if ($65) {
                    var v = Data_Argonaut_Core.toString(json);
                    if (v instanceof Data_Maybe.Just) {
                        return sanitizeString(v.value0)(opts)(state1);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return new Data_Either.Left("Failed to extract string from JSON");
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 197, column 10 - line 199, column 59): " + [ v.constructor.name ]);
                };
                var $68 = Data_Argonaut_Core.isArray(json);
                if ($68) {
                    var v = Data_Argonaut_Core.toArray(json);
                    if (v instanceof Data_Maybe.Just) {
                        return sanitizeArray(v.value0)(opts)(state1)(depth);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return new Data_Either.Left("Failed to extract array from JSON");
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 202, column 10 - line 204, column 58): " + [ v.constructor.name ]);
                };
                var $71 = Data_Argonaut_Core.isObject(json);
                if ($71) {
                    var v = Data_Argonaut_Core.toObject(json);
                    if (v instanceof Data_Maybe.Just) {
                        return sanitizeObject(v.value0)(opts)(state1)(depth);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return new Data_Either.Left("Failed to extract object from JSON");
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 207, column 10 - line 209, column 59): " + [ v.constructor.name ]);
                };
                return new Data_Either.Left("Unknown JSON value type");
            };
        };
    };
};
var sanitizeObjectKeys = function ($copy_pairs) {
    return function ($copy_opts) {
        return function ($copy_state) {
            return function ($copy_depth) {
                return function ($copy_acc) {
                    var $tco_var_pairs = $copy_pairs;
                    var $tco_var_opts = $copy_opts;
                    var $tco_var_state = $copy_state;
                    var $tco_var_depth = $copy_depth;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(pairs, opts, state, depth, acc) {
                        var v = Data_Array.uncons(pairs);
                        if (v instanceof Data_Maybe.Nothing) {
                            $tco_done = true;
                            return new Data_Either.Right(new Data_Tuple.Tuple(Data_Argonaut_Core.fromObject(acc), state));
                        };
                        if (v instanceof Data_Maybe.Just) {
                            var $75 = Data_String_CodePoints.length(v.value0.head.value0) > opts.maxKeyLength;
                            if ($75) {
                                var state1 = {
                                    stats: state.stats,
                                    warnings: append1(state.warnings)([ "Key truncated: " + (take(50)(v.value0.head.value0) + ("... (exceeded " + (show(opts.maxKeyLength) + " chars)"))) ])
                                };
                                $tco_var_pairs = v.value0.tail;
                                $tco_var_opts = opts;
                                $tco_var_state = state1;
                                $tco_var_depth = depth;
                                $copy_acc = acc;
                                return;
                            };
                            var $76 = opts.removePrototypeKeys && elem(v.value0.head.value0)(prototypeKeys);
                            if ($76) {
                                var state1 = {
                                    stats: {
                                        depth: state.stats.depth,
                                        maxStringLength: state.stats.maxStringLength,
                                        totalArrayElements: state.stats.totalArrayElements,
                                        totalKeys: state.stats.totalKeys,
                                        prototypeKeysRemoved: state.stats.prototypeKeysRemoved + 1 | 0
                                    },
                                    warnings: append1(state.warnings)([ "Prototype pollution key removed: " + v.value0.head.value0 ])
                                };
                                $tco_var_pairs = v.value0.tail;
                                $tco_var_opts = opts;
                                $tco_var_state = state1;
                                $tco_var_depth = depth;
                                $copy_acc = acc;
                                return;
                            };
                            var $77 = opts.removePrototypeKeys && elem(toLower(v.value0.head.value0))(map(toLower)(prototypeKeys));
                            if ($77) {
                                var state1 = {
                                    stats: {
                                        depth: state.stats.depth,
                                        maxStringLength: state.stats.maxStringLength,
                                        totalArrayElements: state.stats.totalArrayElements,
                                        totalKeys: state.stats.totalKeys,
                                        prototypeKeysRemoved: state.stats.prototypeKeysRemoved + 1 | 0
                                    },
                                    warnings: append1(state.warnings)([ "Prototype pollution key removed (case variant): " + v.value0.head.value0 ])
                                };
                                $tco_var_pairs = v.value0.tail;
                                $tco_var_opts = opts;
                                $tco_var_state = state1;
                                $tco_var_depth = depth;
                                $copy_acc = acc;
                                return;
                            };
                            var v1 = sanitizeValue(v.value0.head.value1)(opts)(state)(depth + 1 | 0);
                            if (v1 instanceof Data_Either.Left) {
                                $tco_done = true;
                                return new Data_Either.Left(v1.value0);
                            };
                            if (v1 instanceof Data_Either.Right) {
                                $tco_var_pairs = v.value0.tail;
                                $tco_var_opts = opts;
                                $tco_var_state = v1.value0.value1;
                                $tco_var_depth = depth;
                                $copy_acc = Foreign_Object.insert(v.value0.head.value0)(v1.value0.value0)(acc);
                                return;
                            };
                            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 312, column 12 - line 315, column 85): " + [ v1.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 287, column 3 - line 315, column 85): " + [ v.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_pairs, $tco_var_opts, $tco_var_state, $tco_var_depth, $copy_acc);
                    };
                    return $tco_result;
                };
            };
        };
    };
};
var sanitizeObject = function (obj) {
    return function (opts) {
        return function (state) {
            return function (depth) {
                var keys = Foreign_Object.keys(obj);
                var state1 = {
                    warnings: state.warnings,
                    stats: {
                        depth: state.stats.depth,
                        maxStringLength: state.stats.maxStringLength,
                        prototypeKeysRemoved: state.stats.prototypeKeysRemoved,
                        totalArrayElements: state.stats.totalArrayElements,
                        totalKeys: state.stats.totalKeys + Data_Array.length(keys) | 0
                    }
                };
                var $88 = state1.stats.totalKeys > opts.maxTotalKeys;
                if ($88) {
                    return new Data_Either.Left("Total object keys exceed limit: " + (show(state1.stats.totalKeys) + (" (max: " + (show(opts.maxTotalKeys) + ")"))));
                };
                return sanitizeObjectKeys(toUnfoldable(obj))(opts)(state1)(depth)(Foreign_Object.empty);
            };
        };
    };
};
var sanitizeArrayElements = function ($copy_arr) {
    return function ($copy_opts) {
        return function ($copy_state) {
            return function ($copy_depth) {
                return function ($copy_acc) {
                    var $tco_var_arr = $copy_arr;
                    var $tco_var_opts = $copy_opts;
                    var $tco_var_state = $copy_state;
                    var $tco_var_depth = $copy_depth;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(arr, opts, state, depth, acc) {
                        var v = Data_Array.uncons(arr);
                        if (v instanceof Data_Maybe.Nothing) {
                            $tco_done = true;
                            return new Data_Either.Right(new Data_Tuple.Tuple(Data_Argonaut_Core.fromArray(acc), state));
                        };
                        if (v instanceof Data_Maybe.Just) {
                            var v1 = sanitizeValue(v.value0.head)(opts)(state)(depth + 1 | 0);
                            if (v1 instanceof Data_Either.Left) {
                                $tco_done = true;
                                return new Data_Either.Left(v1.value0);
                            };
                            if (v1 instanceof Data_Either.Right) {
                                $tco_var_arr = v.value0.tail;
                                $tco_var_opts = opts;
                                $tco_var_state = v1.value0.value1;
                                $tco_var_depth = depth;
                                $copy_acc = append1(acc)([ v1.value0.value0 ]);
                                return;
                            };
                            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 264, column 7 - line 267, column 78): " + [ v1.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 261, column 3 - line 267, column 78): " + [ v.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_arr, $tco_var_opts, $tco_var_state, $tco_var_depth, $copy_acc);
                    };
                    return $tco_result;
                };
            };
        };
    };
};
var sanitizeArray = function (arr) {
    return function (opts) {
        return function (state) {
            return function (depth) {
                var $98 = Data_Array.length(arr) > opts.maxArrayLength;
                if ($98) {
                    return new Data_Either.Left("Array exceeds maximum length: " + (show(Data_Array.length(arr)) + (" elements (max: " + (show(opts.maxArrayLength) + ")"))));
                };
                var state1 = {
                    warnings: state.warnings,
                    stats: {
                        depth: state.stats.depth,
                        maxStringLength: state.stats.maxStringLength,
                        prototypeKeysRemoved: state.stats.prototypeKeysRemoved,
                        totalKeys: state.stats.totalKeys,
                        totalArrayElements: state.stats.totalArrayElements + Data_Array.length(arr) | 0
                    }
                };
                var $99 = state1.stats.totalArrayElements > (opts.maxArrayLength * 10 | 0);
                if ($99) {
                    return new Data_Either.Left("Total array elements exceed limit: " + show(state1.stats.totalArrayElements));
                };
                return sanitizeArrayElements(arr)(opts)(state1)(depth)([  ]);
            };
        };
    };
};
var hasPrototypeKey = function (str) {
    var protoRegex = (function () {
        var v = Data_String_Regex.regex("\"(__proto__|constructor|prototype)\"\\s*:")(Data_String_Regex_Flags.ignoreCase);
        if (v instanceof Data_Either.Right) {
            return new Data_Maybe.Just(v.value0);
        };
        if (v instanceof Data_Either.Left) {
            return Data_Maybe.Nothing.value;
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 358, column 18 - line 360, column 24): " + [ v.constructor.name ]);
    })();
    if (protoRegex instanceof Data_Maybe.Just) {
        return Data_String_Regex.test(protoRegex.value0)(str);
    };
    if (protoRegex instanceof Data_Maybe.Nothing) {
        return false;
    };
    throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 353, column 3 - line 355, column 21): " + [ protoRegex.constructor.name ]);
};
var quickValidate = function (jsonString) {
    return function (opts) {
        var $105 = Data_String_CodePoints.length(jsonString) > (opts.maxStringLength * 2 | 0);
        if ($105) {
            return false;
        };
        var $106 = maxBracketDepth(jsonString) > opts.maxDepth;
        if ($106) {
            return false;
        };
        var $107 = opts.removePrototypeKeys && hasPrototypeKey(jsonString);
        if ($107) {
            return false;
        };
        return true;
    };
};
var emptyStats = {
    depth: 0,
    totalKeys: 0,
    totalArrayElements: 0,
    maxStringLength: 0,
    prototypeKeysRemoved: 0
};
var emptyState = {
    stats: emptyStats,
    warnings: [  ]
};
var parseAndSanitize = function (jsonString) {
    return function (opts) {
        var $108 = Data_String_CodePoints.length(jsonString) === 0;
        if ($108) {
            return mkError("Input string is empty")(emptyStats)([  ]);
        };
        var $109 = Data_String_CodePoints.length(jsonString) > (opts.maxStringLength * 2 | 0);
        if ($109) {
            return mkError("JSON string too large: " + (show(Data_String_CodePoints.length(jsonString)) + (" bytes (max: " + (show(opts.maxStringLength * 2 | 0) + ")"))))(emptyStats)([  ]);
        };
        var v = Data_Argonaut_Parser.jsonParser(jsonString);
        if (v instanceof Data_Either.Left) {
            return mkError("Invalid JSON: " + v.value0)(emptyStats)([  ]);
        };
        if (v instanceof Data_Either.Right) {
            var v1 = sanitizeValue(v.value0)(opts)(emptyState)(0);
            if (v1 instanceof Data_Either.Left) {
                return mkError(v1.value0)(emptyState.stats)(emptyState.warnings);
            };
            if (v1 instanceof Data_Either.Right) {
                return {
                    valid: true,
                    dat: new Data_Maybe.Just(v1.value0.value0),
                    err: Data_Maybe.Nothing.value,
                    warnings: v1.value0.value1.warnings,
                    stats: v1.value0.value1.stats
                };
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 149, column 7 - line 157, column 12): " + [ v1.constructor.name ]);
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 145, column 8 - line 157, column 12): " + [ v.constructor.name ]);
    };
};
var safeParse = function (jsonString) {
    return function (opts) {
        var result = parseAndSanitize(jsonString)(opts);
        if (result.valid) {
            if (result.dat instanceof Data_Maybe.Just) {
                return new Data_Either.Right(result.dat.value0);
            };
            if (result.dat instanceof Data_Maybe.Nothing) {
                return new Data_Either.Left("JSON validation passed but no data returned");
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 368, column 10 - line 370, column 68): " + [ result.dat.constructor.name ]);
        };
        return new Data_Either.Left((function () {
            if (result.err instanceof Data_Maybe.Just) {
                return result.err.value0;
            };
            if (result.err instanceof Data_Maybe.Nothing) {
                return "JSON validation failed";
            };
            throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 371, column 16 - line 373, column 42): " + [ result.err.constructor.name ]);
        })());
    };
};
var sanitize = function (json) {
    return function (opts) {
        var v = sanitizeValue(json)(opts)(emptyState)(0);
        if (v instanceof Data_Either.Left) {
            return mkError(v.value0)(emptyState.stats)(emptyState.warnings);
        };
        if (v instanceof Data_Either.Right) {
            return {
                valid: true,
                dat: new Data_Maybe.Just(v.value0.value0),
                err: Data_Maybe.Nothing.value,
                warnings: v.value0.value1.warnings,
                stats: v.value0.value1.stats
            };
        };
        throw new Error("Failed pattern match at Lattice.Services.Security.JsonSanitizer (line 162, column 3 - line 170, column 8): " + [ v.constructor.name ]);
    };
};
var defaultOptions = /* #__PURE__ */ (function () {
    return {
        maxDepth: 50,
        maxArrayLength: 100000,
        maxStringLength: (10 * 1024 | 0) * 1024 | 0,
        maxTotalKeys: 1000000,
        maxKeyLength: 1000,
        removePrototypeKeys: true,
        removeNullBytes: true
    };
})();
var deepFreeze = /* #__PURE__ */ Control_Category.identity(Control_Category.categoryFn);
export {
    defaultOptions,
    parseAndSanitize,
    sanitize,
    sanitizeValue,
    quickValidate,
    safeParse,
    deepFreeze,
    prototypeKeys
};
//# sourceMappingURL=index.js.map
