// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as $$Math from "../Math/index.js";
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordNumber);
var compare1 = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var toScreenCoordinates = function (position) {
    return function (finalWidth) {
        return function (finalHeight) {
            return function (anchor) {
                return function (screenWidth) {
                    return function (screenHeight) {
                        var screenY = (position.y - finalHeight * anchor.anchorY) + screenHeight / 2.0;
                        var screenX = (position.x - finalWidth * anchor.anchorX) + screenWidth / 2.0;
                        return new Data_Tuple.Tuple(screenX, screenY);
                    };
                };
            };
        };
    };
};
var sortLayersByDepth = /* #__PURE__ */ Data_Array.sortBy(function (a) {
    return function (b) {
        return compare(a.depth)(b.depth);
    };
});
var normalizeOpacity = function (percentOpacity) {
    return $$Math.max(0.0)($$Math.min(1.0)(percentOpacity / 100.0));
};
var lerpValue = function (prev) {
    return function (next) {
        return function (t) {
            return prev + (next - prev) * t;
        };
    };
};
var getStaticDepth = function (pos) {
    return pos.z;
};
var findSurroundingKeyframes = function (keyframes) {
    return function (frame) {
        if (Data_Array.length(keyframes) === 0) {
            return Data_Maybe.Nothing.value;
        };
        if (Data_Boolean.otherwise) {
            var sorted = Data_Array.sortBy(function (a) {
                return function (b) {
                    return compare1(a.frame)(b.frame);
                };
            })(keyframes);
            var first = Data_Maybe.fromMaybe({
                frame: 0,
                values: [  ]
            })(Data_Array.head(sorted));
            var lastKf = Data_Maybe.fromMaybe(first)(Data_Array.last(sorted));
            var t = (function () {
                var $24 = first.frame === lastKf.frame;
                if ($24) {
                    return 0.0;
                };
                return Data_Int.toNumber(frame - first.frame | 0) / Data_Int.toNumber(lastKf.frame - first.frame | 0);
            })();
            var findPrev = function ($copy_kfs) {
                return function ($copy_acc) {
                    var $tco_var_kfs = $copy_kfs;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(kfs, acc) {
                        var v = Data_Array.head(kfs);
                        if (v instanceof Data_Maybe.Nothing) {
                            $tco_done = true;
                            return acc;
                        };
                        if (v instanceof Data_Maybe.Just) {
                            var $26 = v.value0.frame <= frame;
                            if ($26) {
                                $tco_var_kfs = Data_Maybe.fromMaybe([  ])(map(function (arr) {
                                    return Data_Array.filter(function (v1) {
                                        return true;
                                    })(arr);
                                })(new Data_Maybe.Just(Data_Array.sortBy(function (a) {
                                    return function (b) {
                                        return compare1(a.frame)(b.frame);
                                    };
                                })(keyframes))));
                                $copy_acc = v.value0;
                                return;
                            };
                            $tco_done = true;
                            return acc;
                        };
                        throw new Error("Failed pattern match at Lattice.Services.Depth.LayerTraversal (line 159, column 30 - line 164, column 23): " + [ v.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_kfs, $copy_acc);
                    };
                    return $tco_result;
                };
            };
            return new Data_Maybe.Just({
                prev: first,
                next: lastKf,
                t: t
            });
        };
        throw new Error("Failed pattern match at Lattice.Services.Depth.LayerTraversal (line 149, column 1 - line 150, column 96): " + [ keyframes.constructor.name, frame.constructor.name ]);
    };
};
var interpolateZFromKeyframes = function (keyframes) {
    return function (frame) {
        var v = findSurroundingKeyframes(keyframes)(frame);
        if (v instanceof Data_Maybe.Nothing) {
            return 0.0;
        };
        if (v instanceof Data_Maybe.Just) {
            var prevZ = Data_Maybe.fromMaybe(0.0)(Data_Array.index(v.value0.prev.values)(2));
            var nextZ = Data_Maybe.fromMaybe(0.0)(Data_Array.index(v.value0.next.values)(2));
            return lerpValue(prevZ)(nextZ)(v.value0.t);
        };
        throw new Error("Failed pattern match at Lattice.Services.Depth.LayerTraversal (line 179, column 3 - line 184, column 33): " + [ v.constructor.name ]);
    };
};
var getLayerDepth = function (transform) {
    return function (maybeKeyframes) {
        return function (frame) {
            if (maybeKeyframes instanceof Data_Maybe.Just && Data_Array.length(maybeKeyframes.value0) > 0) {
                return interpolateZFromKeyframes(maybeKeyframes.value0)(frame);
            };
            return transform.position.z;
        };
    };
};
var filterVisibleLayers = function (layers) {
    return function (opacityThreshold) {
        return map1(function (v) {
            return v.value0;
        })(Data_Array.filter(function (v) {
            return v.value1 >= opacityThreshold;
        })(layers));
    };
};
var defaultScale = {
    scaleX: 1.0,
    scaleY: 1.0
};
var defaultPosition = {
    x: 0.0,
    y: 0.0,
    z: 0.0
};
var defaultOpacity = 1.0;
var interpolateOpacityFromKeyframes = function (keyframes) {
    return function (frame) {
        if (Data_Array.length(keyframes) === 0) {
            return defaultOpacity;
        };
        if (Data_Boolean.otherwise) {
            var sorted = Data_Array.sortBy(function (a) {
                return function (b) {
                    return compare1(a.frame)(b.frame);
                };
            })(keyframes);
            var first = Data_Maybe.fromMaybe({
                frame: 0,
                value: 100.0
            })(Data_Array.head(sorted));
            var lastKf = Data_Maybe.fromMaybe(first)(Data_Array.last(sorted));
            var $43 = first.frame === lastKf.frame;
            if ($43) {
                return normalizeOpacity(first.value);
            };
            var t = Data_Int.toNumber(frame - first.frame | 0) / Data_Int.toNumber(lastKf.frame - first.frame | 0);
            var interpolated = lerpValue(first.value)(lastKf.value)(t);
            return normalizeOpacity(interpolated);
        };
        throw new Error("Failed pattern match at Lattice.Services.Depth.LayerTraversal (line 204, column 1 - line 204, column 67): " + [ keyframes.constructor.name, frame.constructor.name ]);
    };
};
var getLayerOpacity = function (staticOpacity) {
    return function (maybeKeyframes) {
        return function (frame) {
            if (maybeKeyframes instanceof Data_Maybe.Just && Data_Array.length(maybeKeyframes.value0) > 0) {
                return interpolateOpacityFromKeyframes(maybeKeyframes.value0)(frame);
            };
            return normalizeOpacity(staticOpacity);
        };
    };
};
var defaultAnchor = {
    anchorX: 0.5,
    anchorY: 0.5
};
var defaultTransform = {
    position: defaultPosition,
    scale: defaultScale,
    anchor: defaultAnchor
};
var clipBoundsToScreen = function (screenX) {
    return function (screenY) {
        return function (finalWidth) {
            return function (finalHeight) {
                return function (screenWidth) {
                    return function (screenHeight) {
                        var clippedY = $$Math.max(0.0)($$Math.min(screenHeight)(screenY));
                        var clippedX = $$Math.max(0.0)($$Math.min(screenWidth)(screenX));
                        var clippedWidth = $$Math.max(0.0)($$Math.min(screenWidth - clippedX)(finalWidth - (clippedX - screenX)));
                        var clippedHeight = $$Math.max(0.0)($$Math.min(screenHeight - clippedY)(finalHeight - (clippedY - screenY)));
                        var $46 = clippedWidth <= 0.0 || clippedHeight <= 0.0;
                        if ($46) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just({
                            x: clippedX,
                            y: clippedY,
                            width: clippedWidth,
                            height: clippedHeight
                        });
                    };
                };
            };
        };
    };
};
var calculateScaledDimensions = function (layerWidth) {
    return function (layerHeight) {
        return function (scale) {
            return new Data_Tuple.Tuple(layerWidth * scale.scaleX, layerHeight * scale.scaleY);
        };
    };
};
var calculateNormalizedAnchor = function (pixelAnchor) {
    return function (layerWidth) {
        return function (layerHeight) {
            return {
                anchorX: pixelAnchor.anchorX / layerWidth + 0.5,
                anchorY: pixelAnchor.anchorY / layerHeight + 0.5
            };
        };
    };
};
var getLayerScreenBounds = function (transform) {
    return function (layerWidth) {
        return function (layerHeight) {
            return function (screenWidth) {
                return function (screenHeight) {
                    var v = calculateScaledDimensions(layerWidth)(layerHeight)(transform.scale);
                    var normalizedAnchor = calculateNormalizedAnchor(transform.anchor)(layerWidth)(layerHeight);
                    var v1 = toScreenCoordinates(transform.position)(v.value0)(v.value1)(normalizedAnchor)(screenWidth)(screenHeight);
                    return clipBoundsToScreen(v1.value0)(v1.value1)(v.value0)(v.value1)(screenWidth)(screenHeight);
                };
            };
        };
    };
};
export {
    defaultPosition,
    defaultScale,
    defaultAnchor,
    defaultTransform,
    defaultOpacity,
    getStaticDepth,
    lerpValue,
    findSurroundingKeyframes,
    interpolateZFromKeyframes,
    getLayerDepth,
    normalizeOpacity,
    interpolateOpacityFromKeyframes,
    getLayerOpacity,
    calculateScaledDimensions,
    toScreenCoordinates,
    clipBoundsToScreen,
    calculateNormalizedAnchor,
    getLayerScreenBounds,
    sortLayersByDepth,
    filterVisibleLayers
};
//# sourceMappingURL=index.js.map
