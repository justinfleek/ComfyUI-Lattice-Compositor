// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_DateTime_Instant from "../Data.DateTime.Instant/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Now from "../Effect.Now/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Graphics_Canvas from "../Graphics.Canvas/index.js";
import * as Unsafe_Reference from "../Unsafe.Reference/index.js";
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var CanvasPool = function (x) {
    return x;
};
var nowMs = function __do() {
    var instant = Effect_Now.now();
    var v = Data_DateTime_Instant.unInstant(instant);
    return v;
};
var register = function (v) {
    return function (canvas) {
        return function (ctx) {
            return function (width) {
                return function (height) {
                    return function __do() {
                        var timestamp = nowMs();
                        var items = Effect_Ref.read(v.pool)();
                        return when(Data_Array.length(items) < v.config.maxSize)((function () {
                            var entry = {
                                canvas: canvas,
                                ctx: ctx,
                                width: width,
                                height: height,
                                inUse: false,
                                lastUsed: timestamp
                            };
                            return Effect_Ref.modify_(function (arr) {
                                return Data_Array.snoc(arr)(entry);
                            })(v.pool);
                        })())();
                    };
                };
            };
        };
    };
};
var release = function (v) {
    return function (canvas) {
        return function __do() {
            var timestamp = nowMs();
            return Effect_Ref.modify_(map(function (item) {
                var $38 = Unsafe_Reference.unsafeRefEq(item.canvas)(canvas);
                if ($38) {
                    return {
                        canvas: item.canvas,
                        ctx: item.ctx,
                        height: item.height,
                        width: item.width,
                        inUse: false,
                        lastUsed: timestamp
                    };
                };
                return item;
            }))(v.pool)();
        };
    };
};
var markInUseAt = function (idx) {
    return function (timestamp) {
        return function (arr) {
            var v = Data_Array.index(arr)(idx);
            if (v instanceof Data_Maybe.Nothing) {
                return arr;
            };
            if (v instanceof Data_Maybe.Just) {
                var v1 = Data_Array.updateAt(idx)({
                    canvas: v.value0.canvas,
                    ctx: v.value0.ctx,
                    height: v.value0.height,
                    width: v.value0.width,
                    inUse: true,
                    lastUsed: timestamp
                })(arr);
                if (v1 instanceof Data_Maybe.Nothing) {
                    return arr;
                };
                if (v1 instanceof Data_Maybe.Just) {
                    return v1.value0;
                };
                throw new Error("Failed pattern match at Lattice.Utils.CanvasPool (line 246, column 7 - line 248, column 32): " + [ v1.constructor.name ]);
            };
            throw new Error("Failed pattern match at Lattice.Utils.CanvasPool (line 243, column 3 - line 248, column 32): " + [ v.constructor.name ]);
        };
    };
};
var getStats = function (v) {
    return function __do() {
        var items = Effect_Ref.read(v.pool)();
        var total = Data_Array.length(items);
        var inUseCount = Data_Array.length(Data_Array.filter(function (v1) {
            return v1.inUse;
        })(items));
        return {
            total: total,
            inUse: inUseCount,
            available: total - inUseCount | 0
        };
    };
};
var findAvailableIndex = function (items) {
    return function (targetWidth) {
        return function (targetHeight) {
            var isMatch = function (item) {
                return !item.inUse && (item.width === targetWidth && item.height === targetHeight);
            };
            return Data_Array.findIndex(isMatch)(items);
        };
    };
};
var defaultConfig = {
    maxSize: 20,
    maxAge: 60000.0
};
var mkCanvasPool = function __do() {
    var poolRef = Effect_Ref["new"]([  ])();
    return {
        pool: poolRef,
        config: defaultConfig
    };
};
var clear = function (v) {
    return Effect_Ref.write([  ])(v.pool);
};
var cleanup = function (v) {
    return function __do() {
        var timestamp = nowMs();
        return Effect_Ref.modify_(Data_Array.filter(function (item) {
            return item.inUse || timestamp - item.lastUsed <= v.config.maxAge;
        }))(v.pool)();
    };
};
var acquire = function (v) {
    return function (width) {
        return function (height) {
            return function __do() {
                var timestamp = nowMs();
                var items = Effect_Ref.read(v.pool)();
                var v1 = findAvailableIndex(items)(width)(height);
                if (v1 instanceof Data_Maybe.Just) {
                    var v2 = Data_Array.index(items)(v1.value0);
                    if (v2 instanceof Data_Maybe.Just) {
                        Effect_Ref.modify_(markInUseAt(v1.value0)(timestamp))(v.pool)();
                        Graphics_Canvas.clearRect(v2.value0.ctx)({
                            x: 0.0,
                            y: 0.0,
                            width: Data_Int.toNumber(width),
                            height: Data_Int.toNumber(height)
                        })();
                        return new Data_Maybe.Just({
                            canvas: v2.value0.canvas,
                            ctx: v2.value0.ctx
                        });
                    };
                    if (v2 instanceof Data_Maybe.Nothing) {
                        return Data_Maybe.Nothing.value;
                    };
                    throw new Error("Failed pattern match at Lattice.Utils.CanvasPool (line 200, column 7 - line 210, column 23): " + [ v2.constructor.name ]);
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return Data_Maybe.Nothing.value;
                };
                throw new Error("Failed pattern match at Lattice.Utils.CanvasPool (line 197, column 3 - line 214, column 19): " + [ v1.constructor.name ]);
            };
        };
    };
};
export {
    mkCanvasPool,
    register,
    acquire,
    release,
    cleanup,
    clear,
    getStats
};
//# sourceMappingURL=index.js.map
