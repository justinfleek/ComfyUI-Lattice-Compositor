// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Lattice_Services_RenderQueue_Database from "../Lattice.Services.RenderQueue.Database/index.js";
import * as Lattice_Services_RenderQueue_Types from "../Lattice.Services.RenderQueue.Types/index.js";
var eq = /* #__PURE__ */ Data_Eq.eq(Lattice_Services_RenderQueue_Types.eqRenderJobStatus);
var fromFoldable = /* #__PURE__ */ Data_Array.fromFoldable(Data_List_Types.foldableList);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var getStats = function (mgr) {
    var countFrames = function (acc) {
        return function (job) {
            var $11 = eq(job.progress.status)(Lattice_Services_RenderQueue_Types.StatusCompleted.value);
            if ($11) {
                return acc + job.progress.totalFrames | 0;
            };
            return acc + (job.progress.currentFrame - job.startFrame | 0) | 0;
        };
    };
    return function __do() {
        var state = Effect_Ref.read(mgr.state)();
        var jobs = fromFoldable(Data_Map_Internal.values(state.jobs));
        var pendingJobs = Data_Array.filter(function (j) {
            return eq(j.progress.status)(Lattice_Services_RenderQueue_Types.StatusPending.value);
        })(jobs);
        var totalFramesRendered = Data_Array.foldl(countFrames)(0)(jobs);
        var failedJobs = Data_Array.filter(function (j) {
            return eq(j.progress.status)(Lattice_Services_RenderQueue_Types.StatusFailed.value);
        })(jobs);
        var completedJobs = Data_Array.filter(function (j) {
            return eq(j.progress.status)(Lattice_Services_RenderQueue_Types.StatusCompleted.value);
        })(jobs);
        var avgFps = (function () {
            if (state.activeJobId instanceof Data_Maybe.Nothing) {
                return 0.0;
            };
            if (state.activeJobId instanceof Data_Maybe.Just) {
                var v = lookup(state.activeJobId.value0)(state.jobs);
                if (v instanceof Data_Maybe.Nothing) {
                    return 0.0;
                };
                if (v instanceof Data_Maybe.Just) {
                    return v.value0.progress.framesPerSecond;
                };
                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Stats (line 68, column 23 - line 70, column 51): " + [ v.constructor.name ]);
            };
            throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Stats (line 66, column 16 - line 70, column 51): " + [ state.activeJobId.constructor.name ]);
        })();
        var activeJobs = Data_Array.filter(function (j) {
            return eq(j.progress.status)(Lattice_Services_RenderQueue_Types.StatusRendering.value);
        })(jobs);
        return {
            totalJobs: Data_Array.length(jobs),
            activeJobs: Data_Array.length(activeJobs),
            pendingJobs: Data_Array.length(pendingJobs),
            completedJobs: Data_Array.length(completedJobs),
            failedJobs: Data_Array.length(failedJobs),
            totalFramesRendered: totalFramesRendered,
            averageFps: avgFps
        };
    };
};
var getFrames = function (mgr) {
    return function (jobId) {
        return bind1(liftEffect(Effect_Ref.read(mgr.db)))(function (maybeDb) {
            if (maybeDb instanceof Data_Maybe.Just) {
                return Lattice_Services_RenderQueue_Database.getFrames(maybeDb.value0)(jobId);
            };
            if (maybeDb instanceof Data_Maybe.Nothing) {
                return pure1([  ]);
            };
            throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Stats (line 43, column 3 - line 45, column 23): " + [ maybeDb.constructor.name ]);
        });
    };
};
export {
    getStats,
    getFrames
};
//# sourceMappingURL=index.js.map
