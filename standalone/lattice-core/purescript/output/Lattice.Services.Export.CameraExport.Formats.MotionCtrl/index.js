// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Lattice_Services_Export_CameraExport_Formats_Common from "../Lattice.Services.Export.CameraExport.Formats.Common/index.js";
import * as Lattice_Services_Export_CameraExport_Matrix from "../Lattice.Services.Export.CameraExport.Matrix/index.js";
import * as Lattice_Services_Export_CameraExport_Types from "../Lattice.Services.Export.CameraExport.Types/index.js";
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var notEq = /* #__PURE__ */ Data_Eq.notEq(Lattice_Services_Export_CameraExport_Types.eqMotionCtrlSVDPreset);
var serializeMatrix = function (rows) {
    return "[" + (Data_String_Common.joinWith(",")(map(function (row) {
        return "[" + (Data_String_Common.joinWith(",")(map(show)(row)) + "]");
    })(rows)) + "]");
};
var serializePoses = function (poses) {
    return "[" + (Data_String_Common.joinWith(",")(map(function (p) {
        return serializeMatrix(p.rt);
    })(poses)) + "]");
};
var exportToMotionCtrl = function (camera) {
    return function (keyframes) {
        return function (frameCount) {
            var poses = Data_Array.mapWithIndex(function (frame) {
                return function (v) {
                    var interpolated = Lattice_Services_Export_CameraExport_Formats_Common.interpolateCameraAtFrame(camera)(keyframes)(frame);
                    var viewMatrix = Lattice_Services_Export_CameraExport_Matrix.computeViewMatrix(interpolated);
                    return {
                        rt: viewMatrix
                    };
                };
            })(Data_Array.range(0)(frameCount - 1 | 0));
            return {
                cameraPoses: poses
            };
        };
    };
};
var detectPresetFromPair = function (first) {
    return function (last) {
        var defaultVec = {
            x: 0.0,
            y: 0.0,
            z: 0.0
        };
        var firstOri = Data_Maybe.fromMaybe(defaultVec)(first.orientation);
        var firstPos = Data_Maybe.fromMaybe(defaultVec)(first.position);
        var lastOri = Data_Maybe.fromMaybe(defaultVec)(last.orientation);
        var deltaRy = lastOri.y - firstOri.y;
        var lastPos = Data_Maybe.fromMaybe(defaultVec)(last.position);
        var deltaX = lastPos.x - firstPos.x;
        var deltaY = lastPos.y - firstPos.y;
        var deltaZ = lastPos.z - firstPos.z;
        var $12 = Data_Number.abs(deltaZ) > 50.0;
        if ($12) {
            var distStart = Data_Number.abs(firstPos.z);
            var distEnd = Data_Number.abs(lastPos.z);
            var $13 = distEnd < distStart;
            if ($13) {
                return Lattice_Services_Export_CameraExport_Types.SVDZoomIn.value;
            };
            return Lattice_Services_Export_CameraExport_Types.SVDZoomOut.value;
        };
        var $14 = Data_Number.abs(deltaRy) > 15.0;
        if ($14) {
            var $15 = deltaRy > 0.0;
            if ($15) {
                return Lattice_Services_Export_CameraExport_Types.SVDRotateCW.value;
            };
            return Lattice_Services_Export_CameraExport_Types.SVDRotateCCW.value;
        };
        var $16 = Data_Number.abs(deltaX) > 50.0;
        if ($16) {
            var $17 = deltaX > 0.0;
            if ($17) {
                return Lattice_Services_Export_CameraExport_Types.SVDPanRight.value;
            };
            return Lattice_Services_Export_CameraExport_Types.SVDPanLeft.value;
        };
        var $18 = Data_Number.abs(deltaY) > 50.0;
        if ($18) {
            var $19 = deltaY > 0.0;
            if ($19) {
                return Lattice_Services_Export_CameraExport_Types.SVDPanDown.value;
            };
            return Lattice_Services_Export_CameraExport_Types.SVDPanUp.value;
        };
        return Lattice_Services_Export_CameraExport_Types.SVDStatic.value;
    };
};
var detectMotionCtrlSVDPreset = function (keyframes) {
    var $20 = Data_Array.length(keyframes) < 2;
    if ($20) {
        return Lattice_Services_Export_CameraExport_Types.SVDStatic.value;
    };
    var $21 = {
        first: Data_Array.index(keyframes)(0),
        last: Data_Array.index(keyframes)(Data_Array.length(keyframes) - 1 | 0)
    };
    if ($21.first instanceof Data_Maybe.Just && $21.last instanceof Data_Maybe.Just) {
        return detectPresetFromPair($21.first.value0)($21.last.value0);
    };
    return Lattice_Services_Export_CameraExport_Types.SVDStatic.value;
};
var exportToMotionCtrlSVD = function (camera) {
    return function (keyframes) {
        return function (frameCount) {
            var preset = detectMotionCtrlSVDPreset(keyframes);
            var $26 = notEq(preset)(Lattice_Services_Export_CameraExport_Types.SVDStatic.value) && Data_Array.length(keyframes) <= 2;
            if ($26) {
                return {
                    motionCamera: preset,
                    cameraPoses: Data_Maybe.Nothing.value
                };
            };
            var motionctrlData = exportToMotionCtrl(camera)(keyframes)(frameCount);
            return {
                motionCamera: preset,
                cameraPoses: new Data_Maybe.Just(serializePoses(motionctrlData.cameraPoses))
            };
        };
    };
};
export {
    exportToMotionCtrl,
    detectMotionCtrlSVDPreset,
    exportToMotionCtrlSVD,
    serializePoses
};
//# sourceMappingURL=index.js.map
