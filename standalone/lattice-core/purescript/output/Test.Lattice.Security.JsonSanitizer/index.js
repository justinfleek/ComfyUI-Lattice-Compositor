// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Foreign_Object from "../Foreign.Object/index.js";
import * as Lattice_Services_Security_JsonSanitizer from "../Lattice.Services.Security.JsonSanitizer/index.js";
import * as Test_Spec from "../Test.Spec/index.js";
import * as Test_Spec_Assertions from "../Test.Spec.Assertions/index.js";
import * as Test_Spec_Assertions_String from "../Test.Spec.Assertions.String/index.js";
var describe = /* #__PURE__ */ Test_Spec.describe(Data_Identity.monadIdentity);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(/* #__PURE__ */ Test_Spec.bindSpecT(Data_Identity.bindIdentity));
var it = /* #__PURE__ */ Test_Spec.it(Data_Identity.monadIdentity)(Test_Spec.exampleMUnit);
var discard2 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var shouldEqual = /* #__PURE__ */ Test_Spec_Assertions.shouldEqual(Effect_Aff.monadThrowAff);
var shouldEqual1 = /* #__PURE__ */ shouldEqual(Data_Show.showBoolean)(Data_Eq.eqBoolean);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var fail = /* #__PURE__ */ Test_Spec_Assertions.fail(Effect_Aff.monadThrowAff);
var shouldEqual2 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Maybe.showMaybe(Data_Show.showBoolean))(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqBoolean));
var shouldEqual3 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Maybe.showMaybe(Data_Show.showNumber))(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqNumber));
var shouldEqual4 = /* #__PURE__ */ shouldEqual(/* #__PURE__ */ Data_Maybe.showMaybe(Data_Show.showString))(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqString));
var fromFoldable = /* #__PURE__ */ Foreign_Object.fromFoldable(Data_Foldable.foldableArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var shouldEqual5 = /* #__PURE__ */ shouldEqual(Data_Show.showInt)(Data_Eq.eqInt);
var elem = /* #__PURE__ */ Data_Array.elem(Data_Eq.eqString);
var shouldContain = /* #__PURE__ */ Test_Spec_Assertions_String.shouldContain(Effect_Aff.monadThrowAff);
var shouldEqual6 = /* #__PURE__ */ shouldEqual(Data_Show.showString)(Data_Eq.eqString);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var specialValueTests = /* #__PURE__ */ describe("parseAndSanitize - Special Values")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should handle null values")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"value\": null}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    return discard2(shouldEqual1(result.valid)(true))(function () {
        if (result.dat instanceof Data_Maybe.Just) {
            var v = Data_Argonaut_Core.toObject(result.dat.value0);
            if (v instanceof Data_Maybe.Just) {
                var v1 = Foreign_Object.lookup("value")(v.value0);
                if (v1 instanceof Data_Maybe.Just) {
                    var $78 = Data_Argonaut_Core.isNull(v1.value0);
                    if ($78) {
                        return pure(Data_Unit.unit);
                    };
                    return fail("Expected null value");
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return fail("Expected 'value' key");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 318, column 13 - line 323, column 53): " + [ v1.constructor.name ]);
            };
            if (v instanceof Data_Maybe.Nothing) {
                return fail("Expected result to be an object");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 316, column 19 - line 324, column 60): " + [ v.constructor.name ]);
        };
        if (result.dat instanceof Data_Maybe.Nothing) {
            return fail("Expected data in result");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 315, column 7 - line 325, column 50): " + [ result.dat.constructor.name ]);
    });
})()))(function () {
    return discard1(it("should handle boolean values")((function () {
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"yes\": true, \"no\": false}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return discard2(shouldEqual1(result.valid)(true))(function () {
            if (result.dat instanceof Data_Maybe.Just) {
                var v = Data_Argonaut_Core.toObject(result.dat.value0);
                if (v instanceof Data_Maybe.Just) {
                    return discard2((function () {
                        var v1 = Foreign_Object.lookup("yes")(v.value0);
                        if (v1 instanceof Data_Maybe.Just) {
                            return shouldEqual2(Data_Argonaut_Core.toBoolean(v1.value0))(new Data_Maybe.Just(true));
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected 'yes' key");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 334, column 13 - line 336, column 51): " + [ v1.constructor.name ]);
                    })())(function () {
                        var v1 = Foreign_Object.lookup("no")(v.value0);
                        if (v1 instanceof Data_Maybe.Just) {
                            return shouldEqual2(Data_Argonaut_Core.toBoolean(v1.value0))(new Data_Maybe.Just(false));
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return fail("Expected 'no' key");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 337, column 13 - line 339, column 50): " + [ v1.constructor.name ]);
                    });
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return fail("Expected result to be an object");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 332, column 19 - line 340, column 60): " + [ v.constructor.name ]);
            };
            if (result.dat instanceof Data_Maybe.Nothing) {
                return fail("Expected data in result");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 331, column 7 - line 341, column 50): " + [ result.dat.constructor.name ]);
        });
    })()))(function () {
        return discard1(it("should handle number values")((function () {
            var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"int\": 42, \"float\": 3.14, \"neg\": -10}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
            return discard2(shouldEqual1(result.valid)(true))(function () {
                if (result.dat instanceof Data_Maybe.Just) {
                    var v = Data_Argonaut_Core.toObject(result.dat.value0);
                    if (v instanceof Data_Maybe.Just) {
                        return discard2((function () {
                            var v1 = Foreign_Object.lookup("int")(v.value0);
                            if (v1 instanceof Data_Maybe.Just) {
                                return shouldEqual3(Data_Argonaut_Core.toNumber(v1.value0))(new Data_Maybe.Just(42.0));
                            };
                            if (v1 instanceof Data_Maybe.Nothing) {
                                return fail("Expected 'int' key");
                            };
                            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 350, column 13 - line 352, column 51): " + [ v1.constructor.name ]);
                        })())(function () {
                            return discard2((function () {
                                var v1 = Foreign_Object.lookup("float")(v.value0);
                                if (v1 instanceof Data_Maybe.Just) {
                                    return shouldEqual3(Data_Argonaut_Core.toNumber(v1.value0))(new Data_Maybe.Just(3.14));
                                };
                                if (v1 instanceof Data_Maybe.Nothing) {
                                    return fail("Expected 'float' key");
                                };
                                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 353, column 13 - line 355, column 53): " + [ v1.constructor.name ]);
                            })())(function () {
                                var v1 = Foreign_Object.lookup("neg")(v.value0);
                                if (v1 instanceof Data_Maybe.Just) {
                                    return shouldEqual3(Data_Argonaut_Core.toNumber(v1.value0))(new Data_Maybe.Just(-10.0));
                                };
                                if (v1 instanceof Data_Maybe.Nothing) {
                                    return fail("Expected 'neg' key");
                                };
                                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 356, column 13 - line 358, column 51): " + [ v1.constructor.name ]);
                            });
                        });
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected result to be an object");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 348, column 19 - line 359, column 60): " + [ v.constructor.name ]);
                };
                if (result.dat instanceof Data_Maybe.Nothing) {
                    return fail("Expected data in result");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 347, column 7 - line 360, column 50): " + [ result.dat.constructor.name ]);
            });
        })()))(function () {
            return it("should remove null bytes from strings")((function () {
                var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"value\": \"hello\\u0000world\"}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
                return discard2(shouldEqual1(result.valid)(true))(function () {
                    return discard2((function () {
                        if (result.dat instanceof Data_Maybe.Just) {
                            var v = Data_Argonaut_Core.toObject(result.dat.value0);
                            if (v instanceof Data_Maybe.Just) {
                                var v1 = Foreign_Object.lookup("value")(v.value0);
                                if (v1 instanceof Data_Maybe.Just) {
                                    return shouldEqual4(Data_Argonaut_Core.toString(v1.value0))(new Data_Maybe.Just("helloworld"));
                                };
                                if (v1 instanceof Data_Maybe.Nothing) {
                                    return fail("Expected 'value' key");
                                };
                                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 369, column 13 - line 371, column 53): " + [ v1.constructor.name ]);
                            };
                            if (v instanceof Data_Maybe.Nothing) {
                                return fail("Expected result to be an object");
                            };
                            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 367, column 19 - line 372, column 60): " + [ v.constructor.name ]);
                        };
                        if (result.dat instanceof Data_Maybe.Nothing) {
                            return fail("Expected data in result");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 366, column 7 - line 373, column 50): " + [ result.dat.constructor.name ]);
                    })())(function () {
                        var hasWarning = Data_Array.any(function (v) {
                            return v === "Null bytes removed from string";
                        })(result.warnings);
                        return shouldEqual1(hasWarning)(true);
                    });
                });
            })());
        });
    });
}));
var sanitizePreParsedTests = /* #__PURE__ */ describe("sanitize - Pre-parsed Data")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should sanitize already-parsed objects")(/* #__PURE__ */ (function () {
    var obj = fromFoldable([ new Data_Tuple.Tuple("safe", Data_Argonaut_Core.fromString("value")), new Data_Tuple.Tuple("__proto__", Data_Argonaut_Core.fromObject(Foreign_Object.singleton("evil")(Data_Argonaut_Core.fromBoolean(true)))) ]);
    var json = Data_Argonaut_Core.fromObject(obj);
    var result = Lattice_Services_Security_JsonSanitizer.sanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    return discard2(shouldEqual1(result.valid)(true))(function () {
        if (result.dat instanceof Data_Maybe.Just) {
            var v = Data_Argonaut_Core.toObject(result.dat.value0);
            if (v instanceof Data_Maybe.Just) {
                var v1 = Foreign_Object.lookup("safe")(v.value0);
                if (v1 instanceof Data_Maybe.Just) {
                    return shouldEqual4(Data_Argonaut_Core.toString(v1.value0))(new Data_Maybe.Just("value"));
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return fail("Expected 'safe' key to be present");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 418, column 13 - line 420, column 66): " + [ v1.constructor.name ]);
            };
            if (v instanceof Data_Maybe.Nothing) {
                return fail("Expected result to be an object");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 415, column 19 - line 421, column 60): " + [ v.constructor.name ]);
        };
        if (result.dat instanceof Data_Maybe.Nothing) {
            return fail("Expected data in result");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 414, column 7 - line 422, column 50): " + [ result.dat.constructor.name ]);
    });
})()))(function () {
    return it("should handle arrays")((function () {
        var arr = Data_Argonaut_Core.fromArray([ Data_Argonaut_Core.fromNumber(1.0), Data_Argonaut_Core.fromNumber(2.0), Data_Argonaut_Core.fromObject(Foreign_Object.singleton("nested")(Data_Argonaut_Core.fromBoolean(true))) ]);
        var result = Lattice_Services_Security_JsonSanitizer.sanitize(arr)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return discard2(shouldEqual1(result.valid)(true))(function () {
            if (result.dat instanceof Data_Maybe.Just) {
                var $113 = Data_Argonaut_Core.isArray(result.dat.value0);
                if ($113) {
                    return pure(Data_Unit.unit);
                };
                return fail("Expected result to be an array");
            };
            if (result.dat instanceof Data_Maybe.Nothing) {
                return fail("Expected data in result");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 432, column 7 - line 437, column 50): " + [ result.dat.constructor.name ]);
        });
    })());
}));
var repeatStr = function (n) {
    return function (s) {
        return Data_String_Common.joinWith("")(Data_Array.replicate(n)(s));
    };
};
var safeParseTests = /* #__PURE__ */ describe("safeParse - Convenience Function")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should return parsed data for valid JSON")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Security_JsonSanitizer.safeParse("{\"value\": 42}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    if (result instanceof Data_Either.Right) {
        var v = Data_Argonaut_Core.toObject(result.value0);
        if (v instanceof Data_Maybe.Just) {
            var v1 = Foreign_Object.lookup("value")(v.value0);
            if (v1 instanceof Data_Maybe.Just) {
                return shouldEqual3(Data_Argonaut_Core.toNumber(v1.value0))(new Data_Maybe.Just(42.0));
            };
            if (v1 instanceof Data_Maybe.Nothing) {
                return fail("Expected 'value' key");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 479, column 13 - line 481, column 53): " + [ v1.constructor.name ]);
        };
        if (v instanceof Data_Maybe.Nothing) {
            return fail("Expected result to be an object");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 477, column 23 - line 482, column 60): " + [ v.constructor.name ]);
    };
    if (result instanceof Data_Either.Left) {
        return fail("Expected Right, got Left: " + result.value0);
    };
    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 476, column 7 - line 483, column 63): " + [ result.constructor.name ]);
})()))(function () {
    return discard1(it("should return Left for invalid JSON")((function () {
        var result = Lattice_Services_Security_JsonSanitizer.safeParse("{invalid}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return shouldEqual1(Data_Either.isLeft(result))(true);
    })()))(function () {
        return it("should return Left for oversized JSON")((function () {
            var opts = {
                maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
                maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
                maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
                maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
                removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
                removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
                maxStringLength: 10
            };
            var large = repeatStr(50)("a");
            var result = Lattice_Services_Security_JsonSanitizer.safeParse("{\"x\":\"" + (large + "\"}"))(opts);
            return shouldEqual1(Data_Either.isLeft(result))(true);
        })());
    });
}));
var quickValidateTests = /* #__PURE__ */ describe("quickValidate - Fast Rejection")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should quickly reject oversized JSON")(/* #__PURE__ */ (function () {
    var opts = {
        maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
        maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
        maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
        maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
        removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
        removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
        maxStringLength: 50
    };
    var large = repeatStr(200)("a");
    var json = "{\"x\":\"" + (large + "\"}");
    return shouldEqual1(Lattice_Services_Security_JsonSanitizer.quickValidate(json)(opts))(false);
})()))(function () {
    return discard1(it("should quickly reject deep nesting")((function () {
        var json = foldl(function (acc) {
            return function (v) {
                return "[" + (acc + "]");
            };
        })("1")(Data_Array.replicate(60)(Data_Unit.unit));
        return shouldEqual1(Lattice_Services_Security_JsonSanitizer.quickValidate(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions))(false);
    })()))(function () {
        return discard1(it("should quickly reject __proto__ keys")(discard2(shouldEqual1(Lattice_Services_Security_JsonSanitizer.quickValidate("{\"__proto__\": {}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions))(false))(function () {
            return shouldEqual1(Lattice_Services_Security_JsonSanitizer.quickValidate("{\"constructor\": {}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions))(false);
        })))(function () {
            return it("should pass valid JSON")(shouldEqual1(Lattice_Services_Security_JsonSanitizer.quickValidate("{\"safe\": \"value\"}")(Lattice_Services_Security_JsonSanitizer.defaultOptions))(true));
        });
    });
}));
var prototypePollutionTests = /* #__PURE__ */ describe("parseAndSanitize - Prototype Pollution Protection")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should BLOCK __proto__ keys")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"__proto__\": {\"polluted\": true}, \"safe\": 1}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    return discard2(shouldEqual1(result.valid)(true))(function () {
        return discard2(shouldEqual5(result.stats.prototypeKeysRemoved)(1))(function () {
            var hasWarning = Data_Array.any(function (v) {
                return v === "Prototype pollution key removed: __proto__";
            })(result.warnings);
            return discard2(shouldEqual1(hasWarning)(true))(function () {
                if (result.dat instanceof Data_Maybe.Just) {
                    var v = Data_Argonaut_Core.toObject(result.dat.value0);
                    if (v instanceof Data_Maybe.Just) {
                        return discard2((function () {
                            var $124 = elem("__proto__")(Foreign_Object.keys(v.value0));
                            if ($124) {
                                return fail("Expected __proto__ key to be removed");
                            };
                            return pure(Data_Unit.unit);
                        })())(function () {
                            var $125 = elem("safe")(Foreign_Object.keys(v.value0));
                            if ($125) {
                                return pure(Data_Unit.unit);
                            };
                            return fail("Expected 'safe' key to be present");
                        });
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected result to be an object");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 217, column 19 - line 227, column 60): " + [ v.constructor.name ]);
                };
                if (result.dat instanceof Data_Maybe.Nothing) {
                    return fail("Expected data in result");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 216, column 7 - line 228, column 50): " + [ result.dat.constructor.name ]);
            });
        });
    });
})()))(function () {
    return discard1(it("should BLOCK constructor keys")((function () {
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"constructor\": {\"prototype\": {\"evil\": true}}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return discard2(shouldEqual1(result.valid)(true))(function () {
            return discard2(shouldEqual5(result.stats.prototypeKeysRemoved)(1))(function () {
                if (result.dat instanceof Data_Maybe.Just) {
                    var v = Data_Argonaut_Core.toObject(result.dat.value0);
                    if (v instanceof Data_Maybe.Just) {
                        var $130 = elem("constructor")(Foreign_Object.keys(v.value0));
                        if ($130) {
                            return fail("Expected 'constructor' key to be removed");
                        };
                        return pure(Data_Unit.unit);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected result to be an object");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 236, column 19 - line 241, column 60): " + [ v.constructor.name ]);
                };
                if (result.dat instanceof Data_Maybe.Nothing) {
                    return fail("Expected data in result");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 235, column 7 - line 242, column 50): " + [ result.dat.constructor.name ]);
            });
        });
    })()))(function () {
        return discard1(it("should BLOCK prototype keys")((function () {
            var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"prototype\": {\"evil\": true}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
            return discard2(shouldEqual1(result.valid)(true))(function () {
                return shouldEqual5(result.stats.prototypeKeysRemoved)(1);
            });
        })()))(function () {
            return discard1(it("should BLOCK case variations of dangerous keys")((function () {
                var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"__PROTO__\": {\"evil\": true}, \"CONSTRUCTOR\": {\"bad\": true}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
                return discard2(shouldEqual1(result.valid)(true))(function () {
                    return shouldEqual5(result.stats.prototypeKeysRemoved)(2);
                });
            })()))(function () {
                return it("should BLOCK __defineGetter__ and similar")((function () {
                    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"__defineGetter__\": \"evil\", \"__defineSetter__\": \"bad\"}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
                    return discard2(shouldEqual1(result.valid)(true))(function () {
                        return shouldEqual5(result.stats.prototypeKeysRemoved)(2);
                    });
                })());
            });
        });
    });
}));
var objectKeyLimitTests = /* #__PURE__ */ describe("parseAndSanitize - Object Key Limits")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should BLOCK objects with too many total keys")(/* #__PURE__ */ (function () {
    var opts = {
        maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
        maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
        maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
        maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
        removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
        removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
        maxTotalKeys: 5
    };
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"a\": 1, \"b\": 2, \"c\": 3, \"d\": 4, \"e\": 5, \"f\": 6, \"g\": 7}")(opts);
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("keys exceed");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about keys exceed");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 276, column 7 - line 278, column 59): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return it("should SKIP keys that are too long")((function () {
        var longKey = repeatStr(1500)("a");
        var json = "{\"" + (longKey + "\": 1, \"normal\": 2}");
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return discard2(shouldEqual1(result.valid)(true))(function () {
            var expectedWarning = "Key truncated: " + (repeatStr(50)("a") + "... (exceeded 1000 chars)");
            var hasWarning = Data_Array.any(function (v) {
                return v === expectedWarning;
            })(result.warnings);
            return discard2(shouldEqual1(hasWarning)(true))(function () {
                if (result.dat instanceof Data_Maybe.Just) {
                    var v = Data_Argonaut_Core.toObject(result.dat.value0);
                    if (v instanceof Data_Maybe.Just) {
                        return discard2((function () {
                            var v1 = Foreign_Object.lookup("normal")(v.value0);
                            if (v1 instanceof Data_Maybe.Just) {
                                return pure(Data_Unit.unit);
                            };
                            if (v1 instanceof Data_Maybe.Nothing) {
                                return fail("Expected 'normal' key to be present");
                            };
                            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 294, column 13 - line 296, column 68): " + [ v1.constructor.name ]);
                        })())(function () {
                            var v1 = Foreign_Object.lookup(longKey)(v.value0);
                            if (v1 instanceof Data_Maybe.Nothing) {
                                return pure(Data_Unit.unit);
                            };
                            if (v1 instanceof Data_Maybe.Just) {
                                return fail("Expected long key to be removed");
                            };
                            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 297, column 13 - line 299, column 63): " + [ v1.constructor.name ]);
                        });
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return fail("Expected result to be an object");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 292, column 19 - line 300, column 60): " + [ v.constructor.name ]);
                };
                if (result.dat instanceof Data_Maybe.Nothing) {
                    return fail("Expected data in result");
                };
                throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 291, column 7 - line 301, column 50): " + [ result.dat.constructor.name ]);
            });
        });
    })());
}));
var invalidJsonTests = /* #__PURE__ */ describe("parseAndSanitize - Invalid JSON")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should return error for invalid JSON syntax")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{not valid json}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("Invalid JSON");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about invalid JSON");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 389, column 7 - line 391, column 60): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return it("should return error for empty string input")((function () {
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return shouldEqual1(result.valid)(false);
    })());
}));
var deepFreezeTests = /* #__PURE__ */ describe("deepFreeze - Immutability")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should be identity for objects (PureScript is immutable by default)")(/* #__PURE__ */ (function () {
    var obj = Data_Argonaut_Core.fromObject(fromFoldable([ new Data_Tuple.Tuple("a", Data_Argonaut_Core.fromNumber(1.0)), new Data_Tuple.Tuple("nested", Data_Argonaut_Core.fromObject(Foreign_Object.singleton("b")(Data_Argonaut_Core.fromNumber(2.0)))) ]));
    var frozen = Lattice_Services_Security_JsonSanitizer.deepFreeze(obj);
    return shouldEqual6(Data_Argonaut_Core.stringify(frozen))(Data_Argonaut_Core.stringify(obj));
})()))(function () {
    return it("should handle primitives")(discard2(shouldEqual6(Data_Argonaut_Core.stringify(Lattice_Services_Security_JsonSanitizer.deepFreeze(Data_Argonaut_Core.fromNumber(42.0))))(Data_Argonaut_Core.stringify(Data_Argonaut_Core.fromNumber(42.0))))(function () {
        return discard2(shouldEqual6(Data_Argonaut_Core.stringify(Lattice_Services_Security_JsonSanitizer.deepFreeze(Data_Argonaut_Core.fromString("string"))))(Data_Argonaut_Core.stringify(Data_Argonaut_Core.fromString("string"))))(function () {
            return shouldEqual6(Data_Argonaut_Core.stringify(Lattice_Services_Security_JsonSanitizer.deepFreeze(Data_Argonaut_Core.jsonNull)))(Data_Argonaut_Core.stringify(Data_Argonaut_Core.jsonNull));
        });
    }));
}));
var buildNestedJson = function (depth) {
    var suffix = foldl(function (acc) {
        return function (v) {
            return acc + "}";
        };
    })("")(Data_Array.replicate(depth)(Data_Unit.unit));
    var prefix = foldl(function (acc) {
        return function (v) {
            return acc + "{\"nested\": ";
        };
    })("")(Data_Array.replicate(depth)(Data_Unit.unit));
    return prefix + ("{\"value\": 1}" + suffix);
};
var depthLimitTests = /* #__PURE__ */ describe("parseAndSanitize - Depth Limits")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should BLOCK JSON exceeding max depth (default: 50)")(/* #__PURE__ */ (function () {
    var json = buildNestedJson(60);
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("depth");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about depth");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 116, column 7 - line 118, column 53): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return discard1(it("should ALLOW JSON within depth limit")((function () {
        var json = buildNestedJson(10);
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return discard2(shouldEqual1(result.valid)(true))(function () {
            var $147 = result.stats.depth <= 15;
            if ($147) {
                return pure(Data_Unit.unit);
            };
            return fail("Expected depth <= 15, got " + show(result.stats.depth));
        });
    })()))(function () {
        return it("should track actual depth in stats")((function () {
            var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"a\": {\"b\": {\"c\": {\"d\": 1}}}}")(Lattice_Services_Security_JsonSanitizer.defaultOptions);
            return discard2(shouldEqual1(result.valid)(true))(function () {
                return shouldEqual5(result.stats.depth)(4);
            });
        })());
    });
}));
var buildLongStringJson = function (n) {
    var str = Data_String_Common.joinWith("")(Data_Array.replicate(n)("a"));
    return "{\"data\": \"" + (str + "\"}");
};
var stringSizeLimitTests = /* #__PURE__ */ describe("parseAndSanitize - String Size Limits")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should BLOCK strings exceeding max length")(/* #__PURE__ */ (function () {
    var opts = {
        maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
        maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
        maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
        maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
        removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
        removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
        maxStringLength: 200
    };
    var json = buildLongStringJson(300);
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(opts);
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("String exceeds");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about string exceeds");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 187, column 7 - line 189, column 62): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return it("should ALLOW strings within limit")((function () {
        var json = buildLongStringJson(1000);
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return shouldEqual1(result.valid)(true);
    })());
}));
var buildLargeArrayJson = function (n) {
    var elements = Data_String_Common.joinWith(", ")(Data_Array.replicate(n)("1"));
    return "{\"data\": [" + (elements + "]}");
};
var customOptionsTests = /* #__PURE__ */ describe("Custom Options")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should respect custom maxDepth")(/* #__PURE__ */ (function () {
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"a\": {\"b\": {\"c\": 1}}}")({
        maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
        maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
        maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
        maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
        removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
        removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
        maxDepth: 2
    });
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("depth");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about depth");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 531, column 7 - line 533, column 53): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return discard1(it("should respect custom maxArrayLength")((function () {
        var json = buildLargeArrayJson(100);
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)({
            maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
            maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
            maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
            maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
            removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
            removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
            maxArrayLength: 50
        });
        return discard2(shouldEqual1(result.valid)(false))(function () {
            if (result.err instanceof Data_Maybe.Just) {
                return shouldContain(result.err.value0)("Array exceeds");
            };
            if (result.err instanceof Data_Maybe.Nothing) {
                return fail("Expected error about array exceeds");
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 539, column 7 - line 541, column 61): " + [ result.err.constructor.name ]);
        });
    })()))(function () {
        return discard1(it("should allow prototype keys when disabled")((function () {
            var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"__proto__\": {\"x\": 1}}")({
                maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
                maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
                maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
                maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
                maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
                removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
                removePrototypeKeys: false
            });
            return discard2(shouldEqual1(result.valid)(true))(function () {
                return shouldEqual5(result.stats.prototypeKeysRemoved)(0);
            });
        })()))(function () {
            return it("should allow null bytes when disabled")((function () {
                var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize("{\"value\": \"hello\\u0000world\"}")({
                    maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
                    maxArrayLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxArrayLength,
                    maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
                    maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
                    maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
                    removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
                    removeNullBytes: false
                });
                return discard2(shouldEqual1(result.valid)(true))(function () {
                    if (result.dat instanceof Data_Maybe.Just) {
                        var v = Data_Argonaut_Core.toObject(result.dat.value0);
                        if (v instanceof Data_Maybe.Just) {
                            var v1 = Foreign_Object.lookup("value")(v.value0);
                            if (v1 instanceof Data_Maybe.Just) {
                                return shouldEqual4(Data_Argonaut_Core.toString(v1.value0))(new Data_Maybe.Just("hello\x00world"));
                            };
                            if (v1 instanceof Data_Maybe.Nothing) {
                                return fail("Expected 'value' key");
                            };
                            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 556, column 13 - line 558, column 53): " + [ v1.constructor.name ]);
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return fail("Expected result to be an object");
                        };
                        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 554, column 19 - line 559, column 60): " + [ v.constructor.name ]);
                    };
                    if (result.dat instanceof Data_Maybe.Nothing) {
                        return fail("Expected data in result");
                    };
                    throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 553, column 7 - line 560, column 50): " + [ result.dat.constructor.name ]);
                });
            })());
        });
    });
}));
var assertInvalidWithError = function (result) {
    return function (expectedSubstr) {
        return discard2(shouldEqual1(result.valid)(false))(function () {
            if (result.err instanceof Data_Maybe.Just) {
                return shouldContain(result.err.value0)(expectedSubstr);
            };
            if (result.err instanceof Data_Maybe.Nothing) {
                return fail("Expected error containing '" + (expectedSubstr + "' but got no error"));
            };
            throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 79, column 3 - line 81, column 94): " + [ result.err.constructor.name ]);
        });
    };
};
var arraySizeLimitTests = /* #__PURE__ */ describe("parseAndSanitize - Array Size Limits")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("should BLOCK arrays exceeding max length")(/* #__PURE__ */ (function () {
    var opts = {
        maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
        maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
        maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
        maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
        removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
        removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
        maxArrayLength: 100
    };
    var json = buildLargeArrayJson(150);
    var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(opts);
    return discard2(shouldEqual1(result.valid)(false))(function () {
        if (result.err instanceof Data_Maybe.Just) {
            return shouldContain(result.err.value0)("Array exceeds");
        };
        if (result.err instanceof Data_Maybe.Nothing) {
            return fail("Expected error about array exceeds");
        };
        throw new Error("Failed pattern match at Test.Lattice.Security.JsonSanitizer (line 151, column 7 - line 153, column 61): " + [ result.err.constructor.name ]);
    });
})()))(function () {
    return discard1(it("should ALLOW arrays within limit")((function () {
        var json = buildLargeArrayJson(100);
        var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(Lattice_Services_Security_JsonSanitizer.defaultOptions);
        return shouldEqual1(result.valid)(true);
    })()))(function () {
        return it("should BLOCK cumulative array elements across many arrays")((function () {
            var opts = {
                maxDepth: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxDepth,
                maxKeyLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxKeyLength,
                maxStringLength: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxStringLength,
                maxTotalKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.maxTotalKeys,
                removeNullBytes: Lattice_Services_Security_JsonSanitizer.defaultOptions.removeNullBytes,
                removePrototypeKeys: Lattice_Services_Security_JsonSanitizer.defaultOptions.removePrototypeKeys,
                maxArrayLength: 50
            };
            var innerArray = Data_String_Common.joinWith(", ")(Data_Array.replicate(10)("1"));
            var arrays = Data_Array.replicate(60)("[" + (innerArray + "]"));
            var json = "{\"data\": [" + (Data_String_Common.joinWith(", ")(arrays) + "]}");
            var result = Lattice_Services_Security_JsonSanitizer.parseAndSanitize(json)(opts);
            return shouldEqual1(result.valid)(false);
        })());
    });
}));
var spec = /* #__PURE__ */ describe("JSON Sanitizer - Security")(/* #__PURE__ */ discard1(depthLimitTests)(function () {
    return discard1(arraySizeLimitTests)(function () {
        return discard1(stringSizeLimitTests)(function () {
            return discard1(prototypePollutionTests)(function () {
                return discard1(objectKeyLimitTests)(function () {
                    return discard1(specialValueTests)(function () {
                        return discard1(invalidJsonTests)(function () {
                            return discard1(sanitizePreParsedTests)(function () {
                                return discard1(quickValidateTests)(function () {
                                    return discard1(safeParseTests)(function () {
                                        return discard1(deepFreezeTests)(function () {
                                            return customOptionsTests;
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
}));
export {
    spec
};
//# sourceMappingURL=index.js.map
