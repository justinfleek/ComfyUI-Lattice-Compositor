// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_EuclideanRing from "../Data.EuclideanRing/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Lattice_Services_Export_ExportPipeline_Types from "../Lattice.Services.Export.ExportPipeline.Types/index.js";
import * as $$Math from "../Math/index.js";
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordInt);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var min1 = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordNumber);
var div1 = /* #__PURE__ */ Data_EuclideanRing.div(Data_EuclideanRing.euclideanRingInt);
var mod = /* #__PURE__ */ Data_EuclideanRing.mod(Data_EuclideanRing.euclideanRingInt);
var toGrayscaleArray = function (buffer) {
    var pixelCount = buffer.width * buffer.height | 0;
    var indices = Data_Array.range(0)(pixelCount - 1 | 0);
    return map(function (i) {
        var idx = i * 4 | 0;
        var r = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx));
        var g = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 1 | 0));
        var b = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 2 | 0));
        return (Data_Int.toNumber(r) * 0.299 + Data_Int.toNumber(g) * 0.587 + Data_Int.toNumber(b) * 0.114) / 255.0;
    })(indices);
};
var toGrayscale = function (pixel) {
    return Data_Int.round(Data_Int.toNumber(pixel.r) * 0.299 + Data_Int.toNumber(pixel.g) * 0.587 + Data_Int.toNumber(pixel.b) * 0.114);
};
var edgesToRGBA = function (edges) {
    return Data_Array.foldl(function (acc) {
        return function (edge) {
            var val = Data_Int.round(edge * 255.0);
            var clamped = max(0)(min(255)(val));
            return append(acc)([ clamped, clamped, clamped, 255 ]);
        };
    })([  ])(edges);
};
var computeSobelAt = function (grayscale) {
    return function (w) {
        return function (idx) {
            var getPixel = function (i) {
                return Data_Maybe.fromMaybe(0.0)(Data_Array.index(grayscale)(i));
            };
            var gx = -getPixel((idx - w | 0) - 1 | 0) + getPixel((idx - w | 0) + 1 | 0) + -2.0 * getPixel(idx - 1 | 0) + 2.0 * getPixel(idx + 1 | 0) + -getPixel((idx + w | 0) - 1 | 0) + getPixel((idx + w | 0) + 1 | 0);
            var gy = -getPixel((idx - w | 0) - 1 | 0) + -2.0 * getPixel(idx - w | 0) + -getPixel((idx - w | 0) + 1 | 0) + getPixel((idx + w | 0) - 1 | 0) + 2.0 * getPixel(idx + w | 0) + getPixel((idx + w | 0) + 1 | 0);
            var magnitude = $$Math.sqrt(gx * gx + gy * gy) * 2.0;
            return min1(1.0)(magnitude);
        };
    };
};
var computeSobelEdges = function (grayscale) {
    return function (w) {
        return function (h) {
            var indices = Data_Array.range(0)((w * h | 0) - 1 | 0);
            return map(function (idx) {
                var y = div1(idx)(w);
                var x = mod(idx)(w);
                var $20 = x <= 0 || (x >= (w - 1 | 0) || (y <= 0 || y >= (h - 1 | 0)));
                if ($20) {
                    return 0.0;
                };
                return computeSobelAt(grayscale)(w)(idx);
            })(indices);
        };
    };
};
var computeBoxBlurPixel = function (buffer) {
    return function (x) {
        return function (y) {
            return function (kernel) {
                var kyRange = Data_Array.range(-kernel | 0)(kernel);
                var kxRange = Data_Array.range(-kernel | 0)(kernel);
                var sums = Data_Array.foldl(function (acc) {
                    return function (ky) {
                        return Data_Array.foldl(function (acc$prime) {
                            return function (kx) {
                                var idx = (((y + ky | 0) * buffer.width | 0) + (x + kx | 0) | 0) * 4 | 0;
                                var r = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx));
                                var g = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 1 | 0));
                                var b = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 2 | 0));
                                return {
                                    r: acc$prime.r + r | 0,
                                    g: acc$prime.g + g | 0,
                                    b: acc$prime.b + b | 0
                                };
                            };
                        })(acc)(kxRange);
                    };
                })({
                    r: 0,
                    g: 0,
                    b: 0
                })(kyRange);
                var kernelSize = ((2 * kernel | 0) + 1 | 0) * ((2 * kernel | 0) + 1 | 0) | 0;
                return {
                    r: div1(sums.r)(kernelSize),
                    g: div1(sums.g)(kernelSize),
                    b: div1(sums.b)(kernelSize),
                    a: 255
                };
            };
        };
    };
};
var boxBlur = function (buffer) {
    return function (kernel) {
        var indices = Data_Array.range(0)((buffer.width * buffer.height | 0) - 1 | 0);
        var newData = Data_Array.foldl(function (acc) {
            return function (i) {
                var y = div1(i)(buffer.width);
                var x = mod(i)(buffer.width);
                var pixel = (function () {
                    var $21 = x < kernel || (x >= (buffer.width - kernel | 0) || (y < kernel || y >= (buffer.height - kernel | 0)));
                    if ($21) {
                        var idx = i * 4 | 0;
                        var r = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx));
                        var g = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 1 | 0));
                        var b = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 2 | 0));
                        return {
                            r: r,
                            g: g,
                            b: b,
                            a: 255
                        };
                    };
                    return computeBoxBlurPixel(buffer)(x)(y)(kernel);
                })();
                return append(acc)([ pixel.r, pixel.g, pixel.b, pixel.a ]);
            };
        })([  ])(indices);
        return {
            data: newData,
            width: buffer.width,
            height: buffer.height
        };
    };
};
var applyLineart = function (buffer) {
    var pixelCount = buffer.width * buffer.height | 0;
    var indices = Data_Array.range(0)(pixelCount - 1 | 0);
    var newData = Data_Array.foldl(function (acc) {
        return function (i) {
            var idx = i * 4 | 0;
            var r = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx));
            var g = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 1 | 0));
            var b = Data_Maybe.fromMaybe(0)(Data_Array.index(buffer.data)(idx + 2 | 0));
            var gray = Data_Int.toNumber(r) * 0.299 + Data_Int.toNumber(g) * 0.587 + Data_Int.toNumber(b) * 0.114;
            var val = (function () {
                var $22 = gray > 128.0;
                if ($22) {
                    return 255;
                };
                return 0;
            })();
            return append(acc)([ val, val, val, 255 ]);
        };
    })([  ])(indices);
    return {
        data: newData,
        width: buffer.width,
        height: buffer.height
    };
};
var applyEdgeDetection = function (buffer) {
    var grayscale = toGrayscaleArray(buffer);
    var edges = computeSobelEdges(grayscale)(buffer.width)(buffer.height);
    var newData = edgesToRGBA(edges);
    return {
        data: newData,
        width: buffer.width,
        height: buffer.height
    };
};
var applySoftEdge = function (buffer) {
    var edgeBuffer = applyEdgeDetection(buffer);
    return boxBlur(edgeBuffer)(2);
};
var applyControlPreprocessing = function (controlType) {
    return function (buffer) {
        if (controlType instanceof Lattice_Services_Export_ExportPipeline_Types.ControlCanny) {
            return applyEdgeDetection(buffer);
        };
        if (controlType instanceof Lattice_Services_Export_ExportPipeline_Types.ControlLineart) {
            return applyLineart(buffer);
        };
        if (controlType instanceof Lattice_Services_Export_ExportPipeline_Types.ControlSoftEdge) {
            return applySoftEdge(buffer);
        };
        if (controlType instanceof Lattice_Services_Export_ExportPipeline_Types.ControlDepth) {
            return buffer;
        };
        if (controlType instanceof Lattice_Services_Export_ExportPipeline_Types.ControlNormal) {
            return buffer;
        };
        throw new Error("Failed pattern match at Lattice.Services.Export.ExportPipeline.ControlPreprocessing (line 52, column 3 - line 57, column 28): " + [ controlType.constructor.name ]);
    };
};
export {
    applyControlPreprocessing,
    applyEdgeDetection,
    applyLineart,
    applySoftEdge,
    toGrayscale,
    boxBlur
};
//# sourceMappingURL=index.js.map
