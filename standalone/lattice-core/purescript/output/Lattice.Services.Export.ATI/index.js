// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordInt);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var serializePoint = function (pt) {
    return "{\"x\":" + (show(pt.x) + (",\"y\":" + (show(pt.y) + "}")));
};
var serializeTrack = function (points) {
    return "[" + (Data_String_Common.joinWith(",")(map(serializePoint)(points)) + "]");
};
var serializeATITracks = function (tracks) {
    return "[" + (Data_String_Common.joinWith(",")(map(serializeTrack)(tracks)) + "]");
};
var getVisibility = function (visibility) {
    return function (trackIdx) {
        return function (frameIdx) {
            if (visibility instanceof Data_Maybe.Nothing) {
                return true;
            };
            if (visibility instanceof Data_Maybe.Just) {
                var v = Data_Array.index(visibility.value0)(trackIdx);
                if (v instanceof Data_Maybe.Nothing) {
                    return true;
                };
                if (v instanceof Data_Maybe.Just) {
                    var v1 = Data_Array.index(v.value0)(frameIdx);
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return true;
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        return v1.value0;
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 258, column 11 - line 260, column 24): " + [ v1.constructor.name ]);
                };
                throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 255, column 7 - line 260, column 24): " + [ v.constructor.name ]);
            };
            throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 252, column 3 - line 260, column 24): " + [ visibility.constructor.name ]);
        };
    };
};
var createATITrajectory = function (points) {
    return function (width) {
        return function (height) {
            return function (fps) {
                var tracks = map(map(function (pt) {
                    return [ pt.x, pt.y ];
                }))(points);
                var numPoints = Data_Array.length(points);
                var numFrames = (function () {
                    var v = Data_Array.head(points);
                    if (v instanceof Data_Maybe.Just) {
                        return Data_Array.length(v.value0);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return 0;
                    };
                    throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 336, column 17 - line 338, column 19): " + [ v.constructor.name ]);
                })();
                return {
                    tracks: tracks,
                    width: width,
                    height: height,
                    frameCount: numFrames
                };
            };
        };
    };
};
var countOutOfBounds = function (tracks) {
    return function (width) {
        return function (height) {
            var widthNum = Data_Int.toNumber(width);
            var heightNum = Data_Int.toNumber(height);
            return foldl(function (acc) {
                return function (track) {
                    return foldl(function (count) {
                        return function (frame) {
                            var y = Data_Maybe.fromMaybe(0.0)(Data_Array.index(frame)(1));
                            var x = Data_Maybe.fromMaybe(0.0)(Data_Array.index(frame)(0));
                            var isOut = x < 0.0 || (x > widthNum || (y < 0.0 || y > heightNum));
                            if (isOut) {
                                return count + 1 | 0;
                            };
                            return count;
                        };
                    })(acc)(track);
                };
            })(0)(tracks);
        };
    };
};
var atiFixedFrames = 121;
var normalizeTrack = function (halfWidth) {
    return function (halfHeight) {
        return function (shortEdge) {
            return function (numFrames) {
                return function (visibility) {
                    return function (trackIdx) {
                        return function (track) {
                            return map(function (f) {
                                var v = (function () {
                                    var $38 = f < numFrames && f < Data_Array.length(track);
                                    if ($38) {
                                        var v1 = Data_Array.index(track)(f);
                                        if (v1 instanceof Data_Maybe.Just) {
                                            var v2 = getVisibility(visibility)(trackIdx)(f);
                                            var py = Data_Maybe.fromMaybe(halfHeight)(Data_Array.index(v1.value0)(1));
                                            var px = Data_Maybe.fromMaybe(halfWidth)(Data_Array.index(v1.value0)(0));
                                            return {
                                                x: px,
                                                y: py,
                                                vis: v2
                                            };
                                        };
                                        if (v1 instanceof Data_Maybe.Nothing) {
                                            return {
                                                x: halfWidth,
                                                y: halfHeight,
                                                vis: false
                                            };
                                        };
                                        throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 209, column 11 - line 218, column 58): " + [ v1.constructor.name ]);
                                    };
                                    var $41 = Data_Array.length(track) > 0;
                                    if ($41) {
                                        var lastIdx = min(numFrames - 1 | 0)(Data_Array.length(track) - 1 | 0);
                                        var v1 = Data_Array.index(track)(lastIdx);
                                        if (v1 instanceof Data_Maybe.Just) {
                                            var v2 = getVisibility(visibility)(trackIdx)(lastIdx);
                                            var py = Data_Maybe.fromMaybe(halfHeight)(Data_Array.index(v1.value0)(1));
                                            var px = Data_Maybe.fromMaybe(halfWidth)(Data_Array.index(v1.value0)(0));
                                            return {
                                                x: px,
                                                y: py,
                                                vis: v2
                                            };
                                        };
                                        if (v1 instanceof Data_Maybe.Nothing) {
                                            return {
                                                x: halfWidth,
                                                y: halfHeight,
                                                vis: false
                                            };
                                        };
                                        throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 223, column 13 - line 232, column 60): " + [ v1.constructor.name ]);
                                    };
                                    return {
                                        x: halfWidth,
                                        y: halfHeight,
                                        vis: false
                                    };
                                })();
                                var visFloat = (function () {
                                    if (v.vis) {
                                        return 1.0;
                                    };
                                    return 0.0;
                                })();
                                var centeredY = v.y - halfHeight;
                                var normY = (function () {
                                    var $46 = shortEdge > 0.0;
                                    if ($46) {
                                        return (centeredY / shortEdge) * 2.0;
                                    };
                                    return 0.0;
                                })();
                                var centeredX = v.x - halfWidth;
                                var normX = (function () {
                                    var $47 = shortEdge > 0.0;
                                    if ($47) {
                                        return (centeredX / shortEdge) * 2.0;
                                    };
                                    return 0.0;
                                })();
                                return {
                                    x: normX,
                                    y: normY,
                                    visible: visFloat
                                };
                            })(Data_Array.range(0)(atiFixedFrames - 1 | 0));
                        };
                    };
                };
            };
        };
    };
};
var exportAsNormalizedATI = function (trajectory) {
    return function (visibility) {
        var shortEdge = min(trajectory.width)(trajectory.height);
        var shortEdgeNum = Data_Int.toNumber(shortEdge);
        var halfWidth = Data_Int.toNumber(trajectory.width) / 2.0;
        var halfHeight = Data_Int.toNumber(trajectory.height) / 2.0;
        var normalizedTracks = Data_Array.mapWithIndex(normalizeTrack(halfWidth)(halfHeight)(shortEdgeNum)(trajectory.frameCount)(visibility))(trajectory.tracks);
        var halfFrames = Data_Int.toNumber(atiFixedFrames) / 2.0;
        var timeRange = map(function (f) {
            return (Data_Int.toNumber(f) - halfFrames) / halfFrames;
        })(Data_Array.range(0)(atiFixedFrames - 1 | 0));
        return {
            tracks: normalizedTracks,
            timeRange: timeRange,
            metadata: {
                width: trajectory.width,
                height: trajectory.height,
                shortEdge: shortEdge,
                numTracks: Data_Array.length(trajectory.tracks)
            }
        };
    };
};
var validateForATI = function (trajectory) {
    var outOfBoundsCount = countOutOfBounds(trajectory.tracks)(trajectory.width)(trajectory.height);
    var numPoints = Data_Array.length(trajectory.tracks);
    var frameWarning = (function () {
        var $57 = trajectory.frameCount > atiFixedFrames;
        if ($57) {
            return new Data_Maybe.Just("Trajectory has " + (show1(trajectory.frameCount) + (" frames but ATI uses " + (show1(atiFixedFrames) + (". Frames beyond " + (show1(atiFixedFrames) + " will be truncated."))))));
        };
        var $58 = trajectory.frameCount < atiFixedFrames;
        if ($58) {
            return new Data_Maybe.Just("Trajectory has " + (show1(trajectory.frameCount) + (" frames but ATI expects " + (show1(atiFixedFrames) + (". Last frame will be held to pad the remaining " + (show1(atiFixedFrames - trajectory.frameCount | 0) + " frames."))))));
        };
        return Data_Maybe.Nothing.value;
    })();
    var errors = Data_Array.catMaybes([ (function () {
        var $59 = numPoints === 0;
        if ($59) {
            return new Data_Maybe.Just("No tracks provided");
        };
        return Data_Maybe.Nothing.value;
    })(), (function () {
        var $60 = trajectory.width <= 0 || trajectory.height <= 0;
        if ($60) {
            return new Data_Maybe.Just("Invalid dimensions: " + (show1(trajectory.width) + ("x" + show1(trajectory.height))));
        };
        return Data_Maybe.Nothing.value;
    })() ]);
    var boundsWarning = (function () {
        var $61 = outOfBoundsCount > 0;
        if ($61) {
            return new Data_Maybe.Just(show1(outOfBoundsCount) + (" track points are outside the frame bounds (" + (show1(trajectory.width) + ("x" + (show1(trajectory.height) + "). These will be normalized but may produce unexpected results.")))));
        };
        return Data_Maybe.Nothing.value;
    })();
    var warnings = Data_Array.catMaybes([ frameWarning, boundsWarning ]);
    return {
        valid: Data_Array.length(errors) === 0,
        warnings: warnings,
        errors: errors
    };
};
var arrayToPoint = function (arr) {
    var v = Data_Array.index(arr)(1);
    var v1 = Data_Array.index(arr)(0);
    if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
        return {
            x: v1.value0,
            y: v.value0
        };
    };
    return {
        x: 0.0,
        y: 0.0
    };
};
var convertTrack = function (numFrames) {
    return function (track) {
        return map(function (f) {
            var $70 = f < numFrames && f < Data_Array.length(track);
            if ($70) {
                var v = Data_Array.index(track)(f);
                if (v instanceof Data_Maybe.Just) {
                    return arrayToPoint(v.value0);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return {
                        x: 0.0,
                        y: 0.0
                    };
                };
                throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 120, column 7 - line 122, column 38): " + [ v.constructor.name ]);
            };
            var $73 = Data_Array.length(track) > 0;
            if ($73) {
                var v = Data_Array.last(track);
                if (v instanceof Data_Maybe.Just) {
                    return arrayToPoint(v.value0);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return {
                        x: 0.0,
                        y: 0.0
                    };
                };
                throw new Error("Failed pattern match at Lattice.Services.Export.ATI (line 125, column 7 - line 127, column 38): " + [ v.constructor.name ]);
            };
            return {
                x: 0.0,
                y: 0.0
            };
        })(Data_Array.range(0)(atiFixedFrames - 1 | 0));
    };
};
var exportATITrackCoordsJSON = function (trajectory) {
    var atiTracks = map(convertTrack(trajectory.frameCount))(trajectory.tracks);
    return serializeATITracks(atiTracks);
};
var exportATIPackage = function (trajectory) {
    return {
        tracks: exportATITrackCoordsJSON(trajectory),
        width: trajectory.width,
        height: trajectory.height,
        numTracks: Data_Array.length(trajectory.tracks),
        originalFrames: trajectory.frameCount
    };
};
export {
    atiFixedFrames,
    exportATITrackCoordsJSON,
    exportATIPackage,
    exportAsNormalizedATI,
    validateForATI,
    createATITrajectory
};
//# sourceMappingURL=index.js.map
