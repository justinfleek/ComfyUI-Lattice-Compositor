// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Lattice_Services_RenderQueue_Database from "../Lattice.Services.RenderQueue.Database/index.js";
import * as Lattice_Services_RenderQueue_Types from "../Lattice.Services.RenderQueue.Types/index.js";
var bind1 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff);
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var when = /* #__PURE__ */ Control_Applicative.when(Effect_Aff.applicativeAff);
var eq = /* #__PURE__ */ Data_Eq.eq(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqString));
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var eq1 = /* #__PURE__ */ Data_Eq.eq(Lattice_Services_RenderQueue_Types.eqRenderJobStatus);
var fromFoldable = /* #__PURE__ */ Data_Array.fromFoldable(Data_List_Types.foldableList);
var comparing = /* #__PURE__ */ Data_Ord.comparing(Data_Ord.ordInt);
var notifyProgressInternal = function (mgr) {
    return function (jobId) {
        return function (progress) {
            return function __do() {
                var maybeCb = Effect_Ref.read(mgr.onProgressCb)();
                if (maybeCb instanceof Data_Maybe.Just) {
                    return maybeCb.value0(jobId)(progress)();
                };
                if (maybeCb instanceof Data_Maybe.Nothing) {
                    return Data_Unit.unit;
                };
                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 178, column 3 - line 180, column 25): " + [ maybeCb.constructor.name ]);
            };
        };
    };
};
var getFramesInternal = function (mgr) {
    return function (jobId) {
        return bind1(liftEffect(Effect_Ref.read(mgr.db)))(function (maybeDb) {
            if (maybeDb instanceof Data_Maybe.Just) {
                return Lattice_Services_RenderQueue_Database.getFrames(maybeDb.value0)(jobId);
            };
            if (maybeDb instanceof Data_Maybe.Nothing) {
                return pure1([  ]);
            };
            throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 170, column 3 - line 172, column 23): " + [ maybeDb.constructor.name ]);
        });
    };
};
var startJob = function (mgr) {
    return function (job) {
        return function (timestamp) {
            return bind1(liftEffect(Effect_Ref.read(mgr.frameRenderer)))(function (maybeRenderer) {
                if (maybeRenderer instanceof Data_Maybe.Nothing) {
                    return pure1(Data_Unit.unit);
                };
                if (maybeRenderer instanceof Data_Maybe.Just) {
                    return discard(liftEffect(Effect_Ref.modify_(function (s) {
                        return {
                            isPaused: s.isPaused,
                            isRunning: s.isRunning,
                            jobs: s.jobs,
                            activeJobId: new Data_Maybe.Just(job.id),
                            startTime: timestamp,
                            framesRenderedThisSession: 0
                        };
                    })(mgr.state)))(function () {
                        var startedJob = {
                            checkpointFrame: job.checkpointFrame,
                            completedAt: job.completedAt,
                            compositionId: job.compositionId,
                            createdAt: job.createdAt,
                            endFrame: job.endFrame,
                            format: job.format,
                            fps: job.fps,
                            height: job.height,
                            id: job.id,
                            name: job.name,
                            priority: job.priority,
                            quality: job.quality,
                            startFrame: job.startFrame,
                            width: job.width,
                            progress: {
                                currentFrame: job.progress.currentFrame,
                                elapsedTime: job.progress.elapsedTime,
                                error: job.progress.error,
                                estimatedTimeRemaining: job.progress.estimatedTimeRemaining,
                                framesPerSecond: job.progress.framesPerSecond,
                                percentage: job.progress.percentage,
                                totalFrames: job.progress.totalFrames,
                                status: Lattice_Services_RenderQueue_Types.StatusRendering.value
                            },
                            startedAt: (function () {
                                if (job.startedAt instanceof Data_Maybe.Just) {
                                    return new Data_Maybe.Just(job.startedAt.value0);
                                };
                                if (job.startedAt instanceof Data_Maybe.Nothing) {
                                    return new Data_Maybe.Just(timestamp);
                                };
                                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 83, column 27 - line 85, column 42): " + [ job.startedAt.constructor.name ]);
                            })()
                        };
                        return discard(liftEffect(Effect_Ref.modify_(function (s) {
                            return {
                                activeJobId: s.activeJobId,
                                framesRenderedThisSession: s.framesRenderedThisSession,
                                isPaused: s.isPaused,
                                isRunning: s.isRunning,
                                startTime: s.startTime,
                                jobs: insert(job.id)(startedJob)(s.jobs)
                            };
                        })(mgr.state)))(function () {
                            return renderLoop(mgr)(job.id)(maybeRenderer.value0)(timestamp);
                        });
                    });
                };
                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 70, column 3 - line 91, column 47): " + [ maybeRenderer.constructor.name ]);
            });
        };
    };
};
var renderLoop = function (mgr) {
    return function (jobId) {
        return function (renderer) {
            return function (currentTime) {
                return bind1(liftEffect(Effect_Ref.read(mgr.state)))(function (state) {
                    return when(state.isRunning && (!state.isPaused && eq(state.activeJobId)(new Data_Maybe.Just(jobId))))((function () {
                        var v = lookup(jobId)(state.jobs);
                        if (v instanceof Data_Maybe.Nothing) {
                            return pure1(Data_Unit.unit);
                        };
                        if (v instanceof Data_Maybe.Just) {
                            var $48 = v.value0.progress.currentFrame > v.value0.endFrame;
                            if ($48) {
                                var completedJob = {
                                    checkpointFrame: v.value0.checkpointFrame,
                                    compositionId: v.value0.compositionId,
                                    createdAt: v.value0.createdAt,
                                    endFrame: v.value0.endFrame,
                                    format: v.value0.format,
                                    fps: v.value0.fps,
                                    height: v.value0.height,
                                    id: v.value0.id,
                                    name: v.value0.name,
                                    priority: v.value0.priority,
                                    quality: v.value0.quality,
                                    startFrame: v.value0.startFrame,
                                    startedAt: v.value0.startedAt,
                                    width: v.value0.width,
                                    progress: {
                                        currentFrame: v.value0.progress.currentFrame,
                                        elapsedTime: v.value0.progress.elapsedTime,
                                        error: v.value0.progress.error,
                                        estimatedTimeRemaining: v.value0.progress.estimatedTimeRemaining,
                                        framesPerSecond: v.value0.progress.framesPerSecond,
                                        percentage: v.value0.progress.percentage,
                                        totalFrames: v.value0.progress.totalFrames,
                                        status: Lattice_Services_RenderQueue_Types.StatusCompleted.value
                                    },
                                    completedAt: new Data_Maybe.Just(currentTime)
                                };
                                return discard(liftEffect(Effect_Ref.modify_(function (s) {
                                    return {
                                        framesRenderedThisSession: s.framesRenderedThisSession,
                                        isPaused: s.isPaused,
                                        isRunning: s.isRunning,
                                        startTime: s.startTime,
                                        jobs: insert(jobId)(completedJob)(s.jobs),
                                        activeJobId: Data_Maybe.Nothing.value
                                    };
                                })(mgr.state)))(function () {
                                    return bind1(liftEffect(Effect_Ref.read(mgr.db)))(function (maybeDb) {
                                        return discard((function () {
                                            if (maybeDb instanceof Data_Maybe.Just) {
                                                return Lattice_Services_RenderQueue_Database.saveJob(maybeDb.value0)(completedJob);
                                            };
                                            if (maybeDb instanceof Data_Maybe.Nothing) {
                                                return pure1(Data_Unit.unit);
                                            };
                                            throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 122, column 13 - line 124, column 35): " + [ maybeDb.constructor.name ]);
                                        })())(function () {
                                            return bind1(getFramesInternal(mgr)(jobId))(function (frames) {
                                                return bind1(liftEffect(Effect_Ref.read(mgr.onJobCompleteCb)))(function (maybeCb) {
                                                    return discard((function () {
                                                        if (maybeCb instanceof Data_Maybe.Just) {
                                                            return liftEffect(maybeCb.value0(jobId)(frames));
                                                        };
                                                        if (maybeCb instanceof Data_Maybe.Nothing) {
                                                            return pure1(Data_Unit.unit);
                                                        };
                                                        throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 129, column 13 - line 131, column 35): " + [ maybeCb.constructor.name ]);
                                                    })())(function () {
                                                        return processNextJob(mgr)(currentTime);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            };
                            return bind1(renderer(v.value0.compositionId)(v.value0.progress.currentFrame)(v.value0.width)(v.value0.height))(function (frameData) {
                                var totalFrames$prime = (v.value0.endFrame - v.value0.startFrame | 0) + 1 | 0;
                                var newFrame = v.value0.progress.currentFrame + 1 | 0;
                                var framesComplete = newFrame - v.value0.startFrame | 0;
                                var pct = (function () {
                                    var $53 = totalFrames$prime > 0;
                                    if ($53) {
                                        return Data_Int.floor((Data_Int.toNumber(framesComplete) / Data_Int.toNumber(totalFrames$prime)) * 100.0);
                                    };
                                    return 0;
                                })();
                                var updatedProgress = {
                                    elapsedTime: v.value0.progress.elapsedTime,
                                    error: v.value0.progress.error,
                                    estimatedTimeRemaining: v.value0.progress.estimatedTimeRemaining,
                                    framesPerSecond: v.value0.progress.framesPerSecond,
                                    status: v.value0.progress.status,
                                    currentFrame: newFrame,
                                    totalFrames: totalFrames$prime,
                                    percentage: pct
                                };
                                var updatedJob = {
                                    checkpointFrame: v.value0.checkpointFrame,
                                    completedAt: v.value0.completedAt,
                                    compositionId: v.value0.compositionId,
                                    createdAt: v.value0.createdAt,
                                    endFrame: v.value0.endFrame,
                                    format: v.value0.format,
                                    fps: v.value0.fps,
                                    height: v.value0.height,
                                    id: v.value0.id,
                                    name: v.value0.name,
                                    priority: v.value0.priority,
                                    quality: v.value0.quality,
                                    startFrame: v.value0.startFrame,
                                    startedAt: v.value0.startedAt,
                                    width: v.value0.width,
                                    progress: updatedProgress
                                };
                                return discard(liftEffect(Effect_Ref.modify_(function (s) {
                                    return {
                                        activeJobId: s.activeJobId,
                                        isPaused: s.isPaused,
                                        isRunning: s.isRunning,
                                        startTime: s.startTime,
                                        jobs: insert(jobId)(updatedJob)(s.jobs),
                                        framesRenderedThisSession: s.framesRenderedThisSession + 1 | 0
                                    };
                                })(mgr.state)))(function () {
                                    return discard(liftEffect(notifyProgressInternal(mgr)(jobId)(updatedProgress)))(function () {
                                        return renderLoop(mgr)(jobId)(renderer)(currentTime);
                                    });
                                });
                            });
                        };
                        throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 102, column 5 - line 164, column 54): " + [ v.constructor.name ]);
                    })());
                });
            };
        };
    };
};
var processNextJob = function (mgr) {
    return function (currentTime) {
        var isPendingOrPaused = function (job) {
            return eq1(job.progress.status)(Lattice_Services_RenderQueue_Types.StatusPending.value) || eq1(job.progress.status)(Lattice_Services_RenderQueue_Types.StatusPaused.value);
        };
        return bind1(liftEffect(Effect_Ref.read(mgr.state)))(function (state) {
            return when(state.isRunning && (!state.isPaused && Data_Maybe.isNothing(state.activeJobId)))((function () {
                var jobs = fromFoldable(Data_Map_Internal.values(state.jobs));
                var pendingJobs = Data_Array.filter(isPendingOrPaused)(jobs);
                var sortedJobs = Data_Array.sortBy(comparing(function (v) {
                    return v.priority;
                }))(pendingJobs);
                var v = Data_Array.head(sortedJobs);
                if (v instanceof Data_Maybe.Nothing) {
                    return discard(liftEffect(Effect_Ref.modify_(function (s) {
                        return {
                            activeJobId: s.activeJobId,
                            framesRenderedThisSession: s.framesRenderedThisSession,
                            isPaused: s.isPaused,
                            jobs: s.jobs,
                            startTime: s.startTime,
                            isRunning: false
                        };
                    })(mgr.state)))(function () {
                        return discard(liftEffect(Effect_Ref.write(Data_Maybe.Nothing.value)(mgr.autoSaveTimer)))(function () {
                            return bind1(liftEffect(Effect_Ref.read(mgr.onQueueEmptyCb)))(function (maybeCb) {
                                if (maybeCb instanceof Data_Maybe.Just) {
                                    return liftEffect(maybeCb.value0);
                                };
                                if (maybeCb instanceof Data_Maybe.Nothing) {
                                    return pure1(Data_Unit.unit);
                                };
                                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 54, column 9 - line 56, column 31): " + [ maybeCb.constructor.name ]);
                            });
                        });
                    });
                };
                if (v instanceof Data_Maybe.Just) {
                    return startJob(mgr)(v.value0)(currentTime);
                };
                throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 48, column 5 - line 58, column 37): " + [ v.constructor.name ]);
            })());
        });
    };
};
var autoSaveCallback = function (mgr) {
    return Effect_Aff.launchAff_(bind1(liftEffect(Effect_Ref.read(mgr.state)))(function (state) {
        if (state.activeJobId instanceof Data_Maybe.Nothing) {
            return pure1(Data_Unit.unit);
        };
        if (state.activeJobId instanceof Data_Maybe.Just) {
            var v = lookup(state.activeJobId.value0)(state.jobs);
            if (v instanceof Data_Maybe.Nothing) {
                return pure1(Data_Unit.unit);
            };
            if (v instanceof Data_Maybe.Just) {
                var checkpointedJob = {
                    completedAt: v.value0.completedAt,
                    compositionId: v.value0.compositionId,
                    createdAt: v.value0.createdAt,
                    endFrame: v.value0.endFrame,
                    format: v.value0.format,
                    fps: v.value0.fps,
                    height: v.value0.height,
                    id: v.value0.id,
                    name: v.value0.name,
                    priority: v.value0.priority,
                    progress: v.value0.progress,
                    quality: v.value0.quality,
                    startFrame: v.value0.startFrame,
                    startedAt: v.value0.startedAt,
                    width: v.value0.width,
                    checkpointFrame: new Data_Maybe.Just(v.value0.progress.currentFrame)
                };
                return bind1(liftEffect(Effect_Ref.read(mgr.db)))(function (maybeDb) {
                    if (maybeDb instanceof Data_Maybe.Just) {
                        return Lattice_Services_RenderQueue_Database.saveJob(maybeDb.value0)(checkpointedJob);
                    };
                    if (maybeDb instanceof Data_Maybe.Nothing) {
                        return pure1(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 195, column 9 - line 197, column 31): " + [ maybeDb.constructor.name ]);
                });
            };
            throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 190, column 19 - line 197, column 31): " + [ v.constructor.name ]);
        };
        throw new Error("Failed pattern match at Lattice.Services.RenderQueue.Manager.Rendering (line 188, column 3 - line 197, column 31): " + [ state.activeJobId.constructor.name ]);
    }));
};
export {
    processNextJob,
    autoSaveCallback
};
//# sourceMappingURL=index.js.map
