# Straylight Protocol Enforcement - MANDATORY

## Description
üö® CRITICAL: Enforces Straylight Protocol rules for Nix, Bash, and Haskell code. ALL code MUST pass validation before being written. This rule is NON-NEGOTIABLE and ENFORCED on EVERY message.

## Globs
**/*.nix, **/*.hs, **/*.sh, **/*.bash, straylight-core/**/*

## Rules

### Before Writing Code
1. Read relevant RFCs:
   - Nix: `straylight-core/docs/rfc/straylight-001-standard-nix.md`
   - Bash: `straylight-core/docs/rfc/straylight-006-safe-bash.md`
   - Scripts: `straylight-core/docs/skills/straylight-script/SKILL.md`

### Nix Rules
- Use lisp-case: `my-thing` not `myThing`
- No `with lib;` ‚Üí use `inherit (lib) x y;`
- No `rec {` in derivations ‚Üí use `finalAttrs:`
- No heredocs (`''...''`) ‚Üí use `writeText` or file imports
- No `if/then/else` in module config ‚Üí use `mkIf`
- No import from derivation (IFD) ‚Üí restructure
- No per-flake nixpkgs config ‚Üí use centralized straylight-naught config
- No camelCase in `straylight.*` namespace ‚Üí use lisp-case
- Packages MUST have `meta` with `description`, `license`
- Modules MUST have `_class` attribute

### PureScript Rules
- ‚ùå `undefined` ‚Üí ERROR (STRAYLIGHT-007) - use Maybe/Option
- ‚ùå `null` ‚Üí ERROR (STRAYLIGHT-007) - use Maybe/Option
- ‚ùå `unsafeCoerce` ‚Üí ERROR (STRAYLIGHT-007) - use proper type conversions
- ‚ùå `unsafePartial` ‚Üí ERROR (STRAYLIGHT-007) - handle all cases explicitly
- ‚ùå `unsafePerformEffect` ‚Üí ERROR (STRAYLIGHT-007) - use Effect/Either properly
- ‚úÖ Scripts must `import Straylight.Script` (STRAYLIGHT-004)

### Lean4 Rules
- ‚ùå `sorry` ‚Üí complete the proof
- ‚ùå `axiom` ‚Üí use theorem with proof
- ‚ùå `admit` ‚Üí complete the proof
- ‚ùå `unsafe` ‚Üí use safe alternatives

### File Size Rules
- ‚ùå Files >500 lines ‚Üí split into smaller modules
- This is CRITICAL for LLM readability

### Literate Programming Rules (STRAYLIGHT-011)
- ‚úÖ Use `.lit`, `.mdx`, `.lit.hs`, `.lit.cpp`, `.lit.purs` extensions
- ‚úÖ Every code block MUST have:
  - `@target`: cpp23, tailwind4, daisyui, radix, vue, or react
  - `@name`: Unique chunk identifier
  - `@description`: Human-readable description
- ‚ùå Code blocks without annotations ‚Üí ERROR (STRAYLIGHT-011-E001)
- ‚ùå Invalid @target values ‚Üí ERROR (STRAYLIGHT-011-E005)
- ‚ùå Duplicate chunk names ‚Üí ERROR (STRAYLIGHT-011-E002)
- ‚ùå Undefined chunk references ‚Üí ERROR (STRAYLIGHT-011-E003)

### C++23 Rules
- ‚ùå `nullptr` without explicit handling ‚Üí ERROR (STRAYLIGHT-011-E006)
- ‚ùå Raw `new` / `delete` ‚Üí ERROR (STRAYLIGHT-011-E007)
- ‚úÖ Use smart pointers (`std::unique_ptr`, `std::shared_ptr`)
- ‚úÖ Use `std::optional` for nullable values

### Bash Rules
- ONLY `exec "$@"` allowed
- NO if/case/for/while ‚Üí write Haskell script
- NO variables ‚Üí write Haskell script

### Haskell Rules
- Scripts MUST `import Straylight.Script`
- Use typed tool wrappers from `Straylight.Script.Tools.*`

### Database Rules (Co-Effect Standards)
- ‚úÖ All database operations must satisfy co-effect equations:
  - **Idempotency**: `f(f(x)) = f(x)` - Operations are idempotent
  - **Monotonicity**: `S(x) <= x` - Security level can only increase
  - **Provenance**: All mutations logged - Append-only event log
  - **Associativity**: `(E1 . E2) . E3 = E1 . (E2 . E3)` - Operations compose cleanly
- ‚úÖ Queries ALWAYS return a value (never None) - use ReactiveCell pattern
- ‚úÖ Missing entities auto-create with zero values
- ‚úÖ All mutations trace through co-effect equations
- ‚úÖ Zero-value semantics: Every type has canonical zero value
- See `ARCHITECTURE_IMPLEMENTATION.md` section 2 for details

### Database Access Pattern (Cell Answer)
- ‚úÖ Use ReactiveCell pattern: `cell = ReactiveCell(db, "table", "id")`
- ‚úÖ `await cell.get()` ALWAYS returns value (creates zero if missing)
- ‚úÖ Never return `None` from database queries
- ‚úÖ When a cell in the database is called, it should query back automatically
- ‚úÖ Zero-value semantics: Every type has canonical zero (Text="", Int=0, List=[], etc.)
- See `toolbox/core/db/reactive_cell.py` for implementation

### Type System Standards (System F/Omega)
- ‚úÖ Explicit error throwing - Never return `null` or `undefined`
- ‚úÖ Total functions - Handle all inputs, terminate on all inputs
- ‚úÖ Proof comments required for critical operations:
  - System F/Omega proof comments
  - Type proof comments
  - Mathematical proof comments
- ‚úÖ Rich error messages - Include context, file names, exact values, actionable info
- ‚úÖ No lazy fixes - Zero shortcuts, zero simple fixes
- ‚úÖ No partial functions - All cases must be handled explicitly
- See `LATTICE/docs/QUICK_START_FOR_NEW_CHAT.md` section "System F/Omega" for pattern

### Agent Training Pattern (Engram)
- ‚úÖ Use engram pattern for O(1) lookup agent training data
- ‚úÖ Location: `toolbox/core/memory/engram.py`
- ‚úÖ Pattern: Fast memory retrieval for agent context
- ‚úÖ O(1) lookup performance for agent training examples
- See `ARCHITECTURE_IMPLEMENTATION.md` for architecture details

### File Locations
- Packages: `straylight-core/nix/packages/{name}.hs`
- Scripts: `straylight-core/nix/scripts/{name}.hs`
- Tool wrappers: `straylight-core/nix/scripts/Straylight/Script/Tools/{Name}.hs`

### Validation
ALWAYS validate code before writing. Use MCP tool `straylight_validate` or run `nix run .#lint`.
