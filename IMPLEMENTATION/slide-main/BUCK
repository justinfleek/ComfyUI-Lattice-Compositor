# Generated from BUILD.dhall
# Generated from BUILD.dhall
# 
# Library paths for tokenizers-cpp come from .buckconfig.local [slide] section
# which is auto-generated by `nix develop`
# The haskell_ffi_binary rule reads these paths via read_root_config()
#
# Benchmarks: buck2 run //:bench
# Run specific: buck2 run //:bench -- encode decode
# Throughput burst: buck2 run //:bench -- throughput
# Markov SSE: buck2 run //:markov

load("@toolchains//:haskell.bzl", "haskell_binary", "haskell_ffi_binary", "haskell_ffi_test")
haskell_ffi_binary(
    name = "slide",
    hs_srcs = ["src/Slide/Chunk.hs", "src/Slide/Configuration.hs", "src/Slide/HotTable.hs", "src/Slide/Model.hs", "src/Slide/Parse.hs", "src/Slide/Provider.hs", "src/Slide/Provider/HTTP2.hs", "src/Slide/Provider/OpenAI.hs", "src/Slide/Provider/OpenRouter.hs", "src/Slide/Provider/Vertex/Anthropic.hs", "src/Slide/Tokenizer.hs", "src/Slide/Tokenizer/FFI.hs", "src/Slide/Wire/Decode.hs", "src/Slide/Wire/Encode.hs", "src/Slide/Wire/Frame.hs", "src/Slide/Wire/Types.hs", "src/Slide/Wire/Varint.hs", "app/Main.hs"],
    cxx_srcs = ["cbits/tokenizers_c.cpp"],
    packages = ["base", "aeson", "async", "blake3", "bytestring", "case-insensitive", "containers", "crypton", "data-default-class", "dhall", "http2", "http-semantics", "http-types", "katip", "megaparsec", "memory", "network", "optparse-applicative", "prometheus-client", "prometheus-metrics-ghc", "random", "text", "time", "time-manager", "tls", "vector", "wai", "warp", "zeromq4-haskell"],
    language_extensions = ["BangPatterns", "CApiFFI", "DerivingStrategies", "ForeignFunctionInterface", "LambdaCase", "NumericUnderscores", "OverloadedStrings", "PatternSynonyms", "StrictData", "PackageImports"],
    ghc_options = ["-O2", "-threaded", "-rtsopts", "-with-rtsopts=-N -A64m -I0", "-isrc"],
    extra_libs = ["tokenizers_cpp", "tokenizers_c", "sentencepiece"],
    include_dirs = ["cbits"],
    visibility = ["PUBLIC"],
)

haskell_ffi_test(
    name = "slide-test",
    hs_srcs = ["src/Slide/Chunk.hs", "src/Slide/Configuration.hs", "src/Slide/HotTable.hs", "src/Slide/Model.hs", "src/Slide/Parse.hs", "src/Slide/Provider.hs", "src/Slide/Provider/HTTP2.hs", "src/Slide/Provider/OpenAI.hs", "src/Slide/Provider/OpenRouter.hs", "src/Slide/Provider/Vertex/Anthropic.hs", "src/Slide/Tokenizer.hs", "src/Slide/Tokenizer/FFI.hs", "src/Slide/Wire/Decode.hs", "src/Slide/Wire/Encode.hs", "src/Slide/Wire/Frame.hs", "src/Slide/Wire/Types.hs", "src/Slide/Wire/Varint.hs", "test/Main.hs", "test/ChunkSpec.hs", "test/ConfigurationSpec.hs", "test/DecodeSpec.hs", "test/EncodeSpec.hs", "test/FrameSpec.hs", "test/HotTableSpec.hs", "test/ModelSpec.hs", "test/ParseSpec.hs", "test/RoundtripSpec.hs", "test/StressSpec.hs", "test/TokenizerFFISpec.hs", "test/ToolCallSpec.hs", "test/TypesSpec.hs", "test/VarintSpec.hs"],
    cxx_srcs = ["cbits/tokenizers_c.cpp"],
    packages = ["base", "aeson", "async", "blake3", "bytestring", "case-insensitive", "containers", "crypton", "data-default-class", "dhall", "http2", "http-semantics", "http-types", "katip", "megaparsec", "memory", "network", "optparse-applicative", "prometheus-client", "prometheus-metrics-ghc", "random", "text", "time", "time-manager", "tls", "vector", "wai", "warp", "zeromq4-haskell", "hspec", "QuickCheck", "temporary"],
    language_extensions = ["BangPatterns", "CApiFFI", "DerivingStrategies", "ForeignFunctionInterface", "LambdaCase", "NumericUnderscores", "OverloadedStrings", "PatternSynonyms", "StrictData", "PackageImports", "ScopedTypeVariables"],
    ghc_options = ["-O0", "-threaded", "-rtsopts", "-with-rtsopts=-N", "-isrc", "-itest"],
    extra_libs = ["tokenizers_cpp", "tokenizers_c", "sentencepiece"],
    include_dirs = ["cbits"],
    visibility = ["PUBLIC"],
)

haskell_ffi_binary(
    name = "bench",
    hs_srcs = ["src/Slide/Chunk.hs", "src/Slide/Configuration.hs", "src/Slide/HotTable.hs", "src/Slide/Model.hs", "src/Slide/Parse.hs", "src/Slide/Provider.hs", "src/Slide/Provider/HTTP2.hs", "src/Slide/Provider/OpenAI.hs", "src/Slide/Provider/OpenRouter.hs", "src/Slide/Provider/Vertex/Anthropic.hs", "src/Slide/Tokenizer.hs", "src/Slide/Tokenizer/FFI.hs", "src/Slide/Wire/Decode.hs", "src/Slide/Wire/Encode.hs", "src/Slide/Wire/Frame.hs", "src/Slide/Wire/Types.hs", "src/Slide/Wire/Varint.hs", "bench/Main.hs"],
    cxx_srcs = ["cbits/tokenizers_c.cpp"],
    packages = ["base", "aeson", "async", "blake3", "bytestring", "case-insensitive", "containers", "crypton", "data-default-class", "dhall", "http2", "http-semantics", "http-types", "katip", "megaparsec", "memory", "network", "optparse-applicative", "prometheus-client", "prometheus-metrics-ghc", "random", "text", "time", "time-manager", "tls", "vector", "wai", "warp", "zeromq4-haskell", "clock", "deepseq"],
    language_extensions = ["BangPatterns", "CApiFFI", "DerivingStrategies", "ForeignFunctionInterface", "LambdaCase", "NumericUnderscores", "OverloadedStrings", "PatternSynonyms", "StrictData", "PackageImports"],
    ghc_options = ["-O2", "-threaded", "-rtsopts", "-with-rtsopts=-N -A64m -I0", "-isrc"],
    extra_libs = ["tokenizers_cpp", "tokenizers_c", "sentencepiece"],
    include_dirs = ["cbits"],
    visibility = ["PUBLIC"],
)

haskell_ffi_binary(
    name = "markov",
    hs_srcs = ["test/MarkovSSE.hs", "src/Slide/HotTable.hs", "src/Slide/Tokenizer.hs", "src/Slide/Tokenizer/FFI.hs", "src/Slide/Wire/Frame.hs", "src/Slide/Wire/Types.hs", "src/Slide/Wire/Varint.hs"],
    cxx_srcs = ["cbits/tokenizers_c.cpp"],
    packages = ["base", "aeson", "bytestring", "containers", "optparse-applicative", "random", "text", "vector", "zeromq4-haskell"],
    language_extensions = ["BangPatterns", "CApiFFI", "DerivingStrategies", "ForeignFunctionInterface", "LambdaCase", "NumericUnderscores", "OverloadedStrings", "PatternSynonyms", "StrictData", "PackageImports"],
    ghc_options = ["-O2", "-threaded", "-rtsopts", "-with-rtsopts=-N", "-isrc", "-main-is", "MarkovSSE"],
    extra_libs = ["tokenizers_cpp", "tokenizers_c", "sentencepiece"],
    include_dirs = ["cbits"],
    visibility = ["PUBLIC"],
)
