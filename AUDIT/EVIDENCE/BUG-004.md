# BUG-004: Division by Zero in interpolateAtTime()

## Summary
The `interpolateAtTime()` function performs a division operation to calculate the interpolation factor `t` without validating that the divisor is non-zero. When `after.frame === before.frame`, this results in division by zero.

## Severity: MEDIUM

## Location
- File: /ui/src/services/expressions/expressionHelpers.ts
- Lines: 107
- Function: interpolateAtTime

## The Bug
The function calculates the interpolation factor using:
```
t = (frame - before.frame) / (after.frame - before.frame)
```

When two keyframes exist at the same frame (which could happen due to data corruption or edge cases), the denominator becomes zero.

## Code Evidence
```typescript
// Line 107
const t = (frame - before.frame) / (after.frame - before.frame);
```

## Impact
- Returns NaN which propagates through animation values
- Could occur when keyframes are very close together due to floating point precision
- Animation becomes corrupted with no error message

## Suggested Fix
```typescript
const denominator = after.frame - before.frame;
if (denominator === 0) return before.value;
const t = (frame - before.frame) / denominator;
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (Line 107):
const t = (frame - before.frame) / (after.frame - before.frame);

// AFTER (Line 107-109):
const frameDelta = after.frame - before.frame;
if (!Number.isFinite(frameDelta) || frameDelta === 0) return before.value;
const t = (frame - before.frame) / frameDelta;
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| before.frame=10, after.frame=10 | NaN (div/0) | before.value ✓ |
| before.frame=NaN | NaN propagates | before.value ✓ |
| after.frame=Infinity | Infinity | before.value ✓ |
| before.frame=0, after.frame=30, frame=15 | 0.5 | 0.5 ✓ |

### Pattern Used
SYSTEMIC-003: Division by zero - inline validation with `Number.isFinite()` check
