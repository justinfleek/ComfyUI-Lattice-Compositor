# BUG-172: AudioLayer.updateGain()/updatePan() NaN Bypass

## Summary
updateGain() and updatePan() use Math.max/min to clamp values, but NaN bypasses these guards. NaN values are passed to Web Audio API nodes, causing undefined audio behavior.

## Severity: LOW

## Location
- File: /ui/src/engine/layers/AudioLayer.ts
- Lines: 323-336 (updateGain), 341-351 (updatePan)
- Functions: updateGain(), updatePan()

## Crash Path Trace
```
Function: updateGain(levelDb: number)

Line 328:
  const clampedDb = Math.max(-60, Math.min(12, levelDb));
  - levelDb=NaN → Math.min(12, NaN) = NaN
  - Math.max(-60, NaN) = NaN (SYSTEMIC-005)

Line 329:
  const linearGain = clampedDb <= -60 ? 0 : Math.pow(10, clampedDb / 20);
  - clampedDb=NaN: NaN <= -60 is false
  - Math.pow(10, NaN / 20) = Math.pow(10, NaN) = NaN

Line 332-335:
  this.playbackNodes.gainNode.gain.setValueAtTime(linearGain, ...);
  - linearGain=NaN → Web Audio API receives NaN
  - Audio behavior undefined (may produce noise, silence, or errors)

---

Function: updatePan(pan: number)

Line 345:
  const clampedPan = Math.max(-1, Math.min(1, pan));
  - pan=NaN → Math.max(-1, NaN) = NaN (SYSTEMIC-005)

Line 347-350:
  this.playbackNodes.panNode.pan.setValueAtTime(clampedPan, ...);
  - clampedPan=NaN → Web Audio API receives NaN
  - Stereo panning behavior undefined

Result: SILENT CORRUPTION (SYSTEMIC-005) - Web Audio receives NaN values
```

## Code Evidence
```typescript
// Lines 323-336
updateGain(levelDb: number): void {
  if (!this.playbackNodes) return;

  // Clamp to reasonable range: -60dB to +12dB
  const clampedDb = Math.max(-60, Math.min(12, levelDb));  // NaN bypasses
  const linearGain = clampedDb <= -60 ? 0 : Math.pow(10, clampedDb / 20);  // NaN propagates

  this.playbackNodes.gainNode.gain.setValueAtTime(
    linearGain,  // NaN passed to Web Audio
    this.playbackNodes.context.currentTime
  );
}

// Lines 341-351
updatePan(pan: number): void {
  if (!this.playbackNodes) return;

  const clampedPan = Math.max(-1, Math.min(1, pan));  // NaN bypasses

  this.playbackNodes.panNode.pan.setValueAtTime(
    clampedPan,  // NaN passed to Web Audio
    this.playbackNodes.context.currentTime
  );
}
```

## Impact
- Expression evaluation can return NaN for level/pan
- NaN bypasses Math.max/min clamps (SYSTEMIC-005)
- Web Audio API receives NaN values
- Audio may become silent, produce noise, or throw errors
- Same pattern as other SYSTEMIC-005 bugs

## Suggested Fix
```typescript
updateGain(levelDb: number): void {
  if (!this.playbackNodes) return;
  if (!Number.isFinite(levelDb)) {
    console.warn(`updateGain: invalid levelDb ${levelDb}`);
    return;
  }
  const clampedDb = Math.max(-60, Math.min(12, levelDb));
  // ...
}

updatePan(pan: number): void {
  if (!this.playbackNodes) return;
  if (!Number.isFinite(pan)) {
    console.warn(`updatePan: invalid pan ${pan}`);
    return;
  }
  const clampedPan = Math.max(-1, Math.min(1, pan));
  // ...
}
```
