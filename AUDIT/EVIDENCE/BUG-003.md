# BUG-003: Division by Zero in timeExpressions.timeRamp()

## Summary
The `timeRamp()` function performs a division operation without validating that the divisor is non-zero. When `endTime === startTime`, this results in division by zero, returning NaN or Infinity.

## Severity: MEDIUM

## Location
- File: /ui/src/services/expressions/expressionEvaluator.ts
- Lines: 31-36
- Function: timeExpressions.timeRamp

## The Bug
The function calculates a linear ramp using the formula:
```
t = (time - startTime) / (endTime - startTime)
```

When `endTime === startTime`, the denominator becomes zero, causing division by zero.

## Code Evidence
```typescript
// Lines 31-36
timeRamp(startTime: number, endTime: number, startValue: number, endValue: number, time: number): number {
  if (time <= startTime) return startValue;
  if (time >= endTime) return endValue;
  const t = (time - startTime) / (endTime - startTime);
  return startValue + (endValue - startValue) * t;
},
```

## Impact
- When startTime === endTime and time is between, division by zero occurs
- Expression returns NaN propagating through animation
- User sees broken time-based animations

## Suggested Fix
```typescript
timeRamp(startTime: number, endTime: number, startValue: number, endValue: number, time: number): number {
  if (time <= startTime) return startValue;
  if (time >= endTime) return endValue;
  if (endTime === startTime) return startValue; // Guard against division by zero
  const t = (time - startTime) / (endTime - startTime);
  return startValue + (endValue - startValue) * t;
},
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (Line 31-36):
timeRamp(startTime: number, endTime: number, startValue: number, endValue: number, time: number): number {
  if (time <= startTime) return startValue;
  if (time >= endTime) return endValue;
  const t = (time - startTime) / (endTime - startTime);
  return startValue + (endValue - startValue) * t;
},

// AFTER (Line 31-38):
timeRamp(startTime: number, endTime: number, startValue: number, endValue: number, time: number): number {
  if (time <= startTime) return startValue;
  if (time >= endTime) return endValue;
  const duration = endTime - startTime;
  if (!Number.isFinite(duration) || duration === 0) return startValue;
  const t = (time - startTime) / duration;
  return startValue + (endValue - startValue) * t;
},
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| startTime=0, endTime=0, time=0.5 | NaN (div/0) | startValue ✓ |
| startTime=NaN | NaN propagates | startValue ✓ |
| time=NaN (bypasses <= and >= guards) | NaN (div/0) | startValue ✓ |
| Valid ramp (0 to 10, time=5) | 0.5 interpolation | 0.5 interpolation ✓ |

### Pattern Used
SYSTEMIC-003: Division by zero - inline validation with `Number.isFinite()` check
