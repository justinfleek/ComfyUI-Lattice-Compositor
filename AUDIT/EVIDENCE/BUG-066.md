# BUG-066: Infinite Loop in Async Readback When maxParticles is Infinity

## Summary
Same vulnerability as SYSTEMIC-006. The async WebGPU readback callback iterates `for (let i = 0; i < this.config.maxParticles; i++)`. If maxParticles is Infinity, this loop runs forever, freezing the browser.

## Severity: LOW

## Location
- File: /ui/src/engine/particles/ParticleGPUPhysics.ts
- Line: 456
- Function: updateWebGPU (async callback)

## The Bug
```typescript
// Lines 450-473 - async callback from readParticles
this.webgpuCompute.readParticles(this.config.maxParticles).then((data) => {
  const targetBuffer = this.currentBuffer === 'A' ? particleBufferA : particleBufferB;
  targetBuffer.set(data);

  // Process deaths
  let activeCount = 0;
  for (let i = 0; i < this.config.maxParticles; i++) {  // Line 456 - Infinite if maxParticles = Infinity
    const offset = i * PARTICLE_STRIDE;
    const age = targetBuffer[offset + 6];
    const lifetime = targetBuffer[offset + 7];

    if (lifetime > 0 && age < lifetime) {
      activeCount++;
    } else if (lifetime > 0 && age >= lifetime) {
      if (!freeIndices.includes(i)) {
        freeIndices.push(i);
        onDeath(i);
      }
    }
  }
  // ...
});
```

## Proof of Failure
```typescript
const physics = new ParticleGPUPhysics({
  maxParticles: Infinity,
  bounds: { min: [-100, -100, -100], max: [100, 100, 100] }
});

await physics.initialize(renderer, bufferA, bufferB);

// Update will trigger readback on frame 10
physics.update(0.016, { simulationTime: 0, frameCount: 10 }, bufferA, bufferB, forceFields, [], () => {});

// The async callback eventually runs and loops forever at line 456
// Browser tab freezes
```

## Related - SYSTEMIC-006
- BUG-059: SpatialHashGrid.rebuild()
- BUG-061: ParticleConnectionSystem.update()
- BUG-062: ParticleTrailSystem.update()
- BUG-064: ParticleCollisionSystem.applyBoundaryCollisions/applyParticleCollisions
- BUG-066: ParticleGPUPhysics async readback callback (this bug)

## Impact
- Browser freeze during async GPU readback
- Low severity: Requires specific bad input (maxParticles = Infinity)

## Suggested Fix
```typescript
constructor(config: GPUPhysicsConfig) {
  // Validate maxParticles
  if (!Number.isFinite(config.maxParticles) || config.maxParticles < 0) {
    console.warn('ParticleGPUPhysics: Invalid maxParticles, using 10000');
    config.maxParticles = 10000;
  }
  this.config = {
    maxParticles: Math.min(config.maxParticles, 1000000), // Also cap at reasonable max
    // ...
  };
}
```
