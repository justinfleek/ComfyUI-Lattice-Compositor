# BUG-017: Special Characters in Text Cause Code Injection/Syntax Error

## Summary
The `evaluateTextAnimatorExpression()` function builds code by string interpolation with only double-quote escaping. Special characters like newlines and backslashes in `ctx.char` break the generated JavaScript, causing syntax errors or potential code injection.

## Severity: MEDIUM

## Location
- File: /ui/src/services/expressions/textAnimator.ts
- Lines: 93
- Function: evaluateTextAnimatorExpression

## The Bug
```typescript
// Line 93
const char = "${ctx.char.replace(/"/g, '\\"')}";
```

Only double quotes are escaped. Other special characters pass through:

### Backslash breaks string
```typescript
// ctx.char = '\\' (backslash)
// Generated code:
const char = "\";  // Backslash escapes the quote!
// SyntaxError: Unterminated string constant
```

### Newline breaks string
```typescript
// ctx.char = '\n' (newline)
// Generated code:
const char = "
";  // Literal newline inside string
// SyntaxError: Unterminated string constant
```

## Proof of Failure
```typescript
const ctx = createTextAnimatorContext(baseCtx, "hello\\world", 5, 1);
// ctx.char = '\\'

evaluateTextAnimatorExpression("return char", ctx, evaluateCustomExpression);
// Throws: SyntaxError: Unterminated string constant
```

## Impact
- Syntax errors crash expression evaluation
- Certain text content breaks animations
- Medium severity because common text can contain backslashes (file paths, escapes)

## Suggested Fix
Use JSON.stringify for proper escaping:
```typescript
const extendedCode = `
    const textIndex = ${ctx.textIndex};
    const textTotal = ${ctx.textTotal};
    const selectorValue = ${ctx.selectorValue};
    const char = ${JSON.stringify(ctx.char)};  // Properly escapes ALL special chars
    const wordIndex = ${ctx.wordIndex || 0};
    const lineIndex = ${ctx.lineIndex || 0};
    const charInWord = ${ctx.charInWord || 0};
    const charInLine = ${ctx.charInLine || 0};
    ${code}
`;
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (line 93):
const char = "${ctx.char.replace(/"/g, '\\"')}";

// AFTER (line 94):
const char = ${JSON.stringify(ctx.char)};
```

### Verification
| Input char | Before | After |
|------------|--------|-------|
| `\\` (backslash) | SyntaxError | `"\\\\"` → works ✓ |
| `\n` (newline) | SyntaxError | `"\\n"` → works ✓ |
| `"` (quote) | `"\""` → works | `"\""` → works ✓ |
| `hello` | `"hello"` → works | `"hello"` → works ✓ |
| `\t\r\n` | SyntaxError | `"\\t\\r\\n"` → works ✓ |

### Pattern Used
String escaping - use JSON.stringify for dynamic string literals in generated code
