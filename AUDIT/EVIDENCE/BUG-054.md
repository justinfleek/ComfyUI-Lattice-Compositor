# BUG-054: Animation Continues After Camera Disposal (Memory Leak)

## Summary
The `setViewPreset()` and `loadBookmark()` methods use `requestAnimationFrame` for smooth transitions. If the CameraController is disposed during animation, the callbacks continue executing with stale references, causing memory leaks and potential errors.

## Severity: LOW

## Location
- File: /ui/src/engine/core/CameraController.ts
- Lines: 821-834, 978-999
- Functions: setViewPreset (animate=true), loadBookmark (animate=true)

## The Bug
```typescript
// setViewPreset with animate=true - Lines 821-834
setViewPreset(preset: keyof typeof CameraController.VIEW_PRESETS, animate = false): void {
  // ...
  if (animate) {
    const animateView = (currentTime: number) => {
      // References this.spherical, this.camera - captured in closure
      this.spherical.theta = startTheta + (targetTheta - startTheta) * eased;
      this.spherical.phi = startPhi + (targetPhi - startPhi) * eased;
      this.updateCameraFromSpherical();

      if (t < 1) {
        requestAnimationFrame(animateView);  // No way to cancel this
      }
    };
    requestAnimationFrame(animateView);
  }
}

// loadBookmark with animate=true - Lines 978-999
loadBookmark(name: string, animate = false): boolean {
  // ...
  if (animate) {
    const animateBookmark = (currentTime: number) => {
      // Same pattern - no cancellation mechanism
      this.camera.position.lerpVectors(startPos, bookmark.position, eased);
      // ...
      if (t < 1) {
        requestAnimationFrame(animateBookmark);  // No way to cancel
      }
    };
    requestAnimationFrame(animateBookmark);
  }
}
```

## Proof of Failure
```typescript
const camera = new CameraController(1920, 1080);

// Start a 300ms animation
camera.setViewPreset('perspective', true);

// Immediately destroy camera (user switches views quickly)
// Note: CameraController has no dispose() method!
camera = null;

// The animateView closure still holds references to:
// - this.spherical
// - this.camera
// - this.updateCameraFromSpherical
// These objects cannot be garbage collected until animation completes

// For 300ms, stale callbacks execute on destroyed object
// If Three.js camera was disposed, updateProjectionMatrix() may error
```

## Two Issues
1. **No cancellation mechanism**: Cannot stop animations in progress
2. **No dispose() method**: CameraController lacks cleanup for pending animations

## Impact
- Memory leak: Camera and related objects held for animation duration
- Potential errors: Operations on disposed Three.js objects
- Wasted CPU: Animation loop runs on invisible/destroyed camera

## Suggested Fix
```typescript
class CameraController {
  private animationFrameId: number | null = null;

  setViewPreset(preset: string, animate = false): void {
    // Cancel any existing animation
    if (this.animationFrameId !== null) {
      cancelAnimationFrame(this.animationFrameId);
      this.animationFrameId = null;
    }

    if (animate) {
      const animateView = (currentTime: number) => {
        // ... animation code ...
        if (t < 1) {
          this.animationFrameId = requestAnimationFrame(animateView);
        } else {
          this.animationFrameId = null;
        }
      };
      this.animationFrameId = requestAnimationFrame(animateView);
    }
  }

  dispose(): void {
    if (this.animationFrameId !== null) {
      cancelAnimationFrame(this.animationFrameId);
      this.animationFrameId = null;
    }
    // Dispose cameraControls
    this.disableOrbitControls();
  }
}
```
