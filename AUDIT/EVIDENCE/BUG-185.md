# BUG-185: Division by fps Without Validation in createThisCompObject()

## Summary
createThisCompObject() calculates frameDuration as 1/fps without validating fps, causing Infinity or NaN to be exposed to user expressions.

## Severity: MEDIUM

## Location
- File: ui/src/services/expressions/expressionEvaluator.ts
- Lines: 339-342
- Function: createThisCompObject()

## The Bug
```typescript
function createThisCompObject(ctx: ExpressionContext) {
  return {
    duration: ctx.duration,
    frameDuration: 1 / ctx.fps,  // No validation!
    width: ctx.compWidth ?? 1920,
    // ...
  };
}
```

**Crash Path with fps=0:**
1. `1 / 0` = Infinity
2. User expression accesses `thisComp.frameDuration`
3. Gets Infinity
4. Any calculation with Infinity likely produces unexpected results

**Crash Path with fps=NaN:**
1. `1 / NaN` = NaN
2. User expression accesses `thisComp.frameDuration`
3. Gets NaN
4. Corrupts any calculation using it

**Crash Path with fps=undefined:**
1. `1 / undefined` = NaN (undefined coerces to NaN in division)
2. Same NaN propagation

## Code Evidence
```typescript
// Lines 339-344
function createThisCompObject(ctx: ExpressionContext) {
  return {
    duration: ctx.duration,
    frameDuration: 1 / ctx.fps,  // Bug: no validation
    width: ctx.compWidth ?? 1920,
    height: ctx.compHeight ?? 1080,
    // ...
  };
}
```

## Impact
- User expressions using `thisComp.frameDuration` get corrupted values
- Common pattern: `time / thisComp.frameDuration` to get frame number
- If fps=0, this returns Infinity; if fps=NaN, returns NaN
- Expressions break silently with no error message

## Usage Context
This function creates the `thisComp` object available to user expressions:
```javascript
// User expression might write:
const currentFrame = time / thisComp.frameDuration;
const progress = time / thisComp.duration;
```

If fps=0, `currentFrame` becomes Infinity, breaking frame-based calculations.

## Test Cases
```javascript
// With ctx.fps = 0:
createThisCompObject({fps: 0}).frameDuration  // Returns Infinity

// With ctx.fps = NaN:
createThisCompObject({fps: NaN}).frameDuration  // Returns NaN

// With ctx.fps = undefined:
createThisCompObject({fps: undefined}).frameDuration  // Returns NaN
```

## Suggested Fix
```typescript
function createThisCompObject(ctx: ExpressionContext) {
  // Validate fps - default to 30 if invalid
  const fps = (Number.isFinite(ctx.fps) && ctx.fps > 0) ? ctx.fps : 30;

  return {
    duration: Number.isFinite(ctx.duration) ? ctx.duration : 0,
    frameDuration: 1 / fps,  // Now safe
    width: ctx.compWidth ?? 1920,
    height: ctx.compHeight ?? 1080,
    // ...
  };
}
```

## Related
- ctx.duration should also be validated (not shown in this bug)
- Similar issue may exist in createThisLayerObject() for inPoint/outPoint
