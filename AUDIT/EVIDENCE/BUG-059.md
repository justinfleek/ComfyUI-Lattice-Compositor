# BUG-059: Infinite Loop When maxParticles is Infinity

## Summary
The SpatialHashGrid rebuild() loop uses maxParticles as its bound. If maxParticles is Infinity (from calculation error or unbounded config), the loop runs forever, freezing the browser/process.

## Severity: LOW

## Location
- File: /ui/src/engine/particles/SpatialHashGrid.ts
- Line: 59
- Function: rebuild

## The Bug
```typescript
// Line 55-82
rebuild(particleBuffer: Float32Array): void {
  this.cells.clear();
  this.particleCells.clear();

  // Line 59: If maxParticles = Infinity, this loops forever
  for (let i = 0; i < this.maxParticles; i++) {
    const offset = i * PARTICLE_STRIDE;
    const lifetime = particleBuffer[offset + 7];
    // ...
  }
}
```

## Proof of Failure
```typescript
// Calculation that produces Infinity
const userParticleCount = 1000;
const multiplier = Infinity; // From division by zero elsewhere
const maxParticles = userParticleCount * multiplier; // Infinity

const grid = new SpatialHashGrid({
  maxParticles: maxParticles, // Infinity
  cellSize: 50
});

// This never returns - infinite loop
grid.rebuild(particleBuffer);

// Browser tab hangs, requires force-close
```

## How maxParticles Could Become Infinity
1. Division by zero in upstream calculation: `count = x / 0`
2. Multiplication overflow: `1e308 * 2 = Infinity`
3. JSON parse of "Infinity" string in some parsers
4. Malicious project file with maxParticles: Infinity

## Secondary Issue: setCellSize(NaN)
Line 187: `Math.max(1, NaN)` returns NaN, not 1.
```typescript
setCellSize(size: number): void {
  this.cellSize = Math.max(1, size); // Math.max(1, NaN) = NaN
}
```
This allows cellSize to become NaN, causing all cell keys to be "NaN,NaN,NaN".

## Impact
- Primary: Denial of service via infinite loop
- Browser tab becomes unresponsive
- User must force-close tab, potentially losing work
- Low severity: Requires specific bad input, not user-triggerable through normal UI

## Suggested Fix
```typescript
constructor(config: SpatialHashConfig) {
  // Validate maxParticles
  if (!Number.isFinite(config.maxParticles) || config.maxParticles < 0) {
    console.warn('SpatialHashGrid: Invalid maxParticles, using 10000');
    this.maxParticles = 10000;
  } else {
    this.maxParticles = config.maxParticles;
  }
  this.cellSize = Math.max(1, config.cellSize) || 50; // Also protect cellSize
}

setCellSize(size: number): void {
  // Protect against NaN
  this.cellSize = Number.isFinite(size) ? Math.max(1, size) : this.cellSize;
}
```
