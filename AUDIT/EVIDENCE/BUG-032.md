# BUG-032: createAmplitudeProperty NaN Amplitudes Create NaN Keyframes

## Summary
The `createAmplitudeProperty` function maps amplitude values to keyframes without validating for NaN. When the input array contains NaN values, the resulting keyframes have NaN values that propagate through animation calculations.

## Severity: MEDIUM

## Location
- File: /ui/src/stores/actions/audioActions.ts
- Lines: 601-604
- Function: `createAmplitudeProperty`

## The Bug
Line 604 multiplies amplitude by scale without checking if amplitude is NaN.

## Code Evidence
```typescript
// Lines 594-619
function createAmplitudeProperty(
  name: string,
  amplitudes: number[],  // May contain NaN values
  scale: number
): AnimatableProperty<number> {
  const id = `prop_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;

  const keyframes: Keyframe<number>[] = amplitudes.map((amp, frame) => ({
    id: `kf_${id}_${frame}`,
    frame,
    value: amp * scale,  // NaN * scale = NaN
    interpolation: 'linear' as const,
    // ...
  }));

  return {
    // ...
    keyframes  // Contains NaN values
  };
}
```

## Crash Path Trace
```
1. Audio buffer has silent sections or corrupt data
2. extractChannelAmplitudes() produces NaN in array (e.g., sqrt of negative)
3. applySmoothing() propagates NaN through all subsequent values
4. createAmplitudeProperty([0.5, NaN, NaN, NaN, 0.3], 100) called
5. Line 604: amp=NaN, value = NaN * 100 = NaN
6. Keyframes array: [{value: 50}, {value: NaN}, {value: NaN}, ...]
7. Expressions read keyframe value: returns NaN
8. Animation calculation: position = [100, 200] + NaN * [10, 20] = [NaN, NaN]
9. Layer renders at position (NaN, NaN) -> disappears or corrupts
```

## NaN Propagation in applySmoothing
```typescript
// Line 581-589
function applySmoothing(values: number[], factor: number): number[] {
  const smoothed: number[] = [values[0]];
  for (let i = 1; i < values.length; i++) {
    smoothed[i] = factor * smoothed[i - 1] + (1 - factor) * values[i];
    // If values[i] is NaN: smoothed[i] = X + (1 - factor) * NaN = NaN
    // Then ALL subsequent smoothed values are NaN!
  }
  return smoothed;
}
```

## Impact
- NaN keyframe values corrupt animation calculations
- Layers disappear or render incorrectly
- Silent corruption - no error displayed
- Difficult to diagnose root cause

## Suggested Fix
```typescript
const keyframes: Keyframe<number>[] = amplitudes.map((amp, frame) => ({
  id: `kf_${id}_${frame}`,
  frame,
  // BUG-032 FIX: Sanitize NaN values
  value: Number.isFinite(amp) ? amp * scale : 0,
  interpolation: 'linear' as const,
  // ...
}));
```
