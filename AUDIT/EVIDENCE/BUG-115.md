# BUG-115: TextLayer.applyOpacity() NaN Bypass

## Summary
The `applyOpacity(opacity)` method uses `Math.max(0, Math.min(100, opacity))` to clamp the opacity value. However, NaN bypasses this check because `Math.min(100, NaN)` returns NaN, and `Math.max(0, NaN)` also returns NaN. NaN opacity is then passed to Troika text meshes.

## Severity: LOW

## Location
- File: /ui/src/engine/layers/TextLayer.ts
- Lines: 1374-1386
- Function: applyOpacity

## The Bug
```typescript
// Lines 1374-1386
protected override applyOpacity(opacity: number): void {
  const normalizedOpacity = Math.max(0, Math.min(100, opacity)) / 100;
  //                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  // NaN passes through! Math.max(0, Math.min(100, NaN)) = NaN

  // Apply to main text mesh using Troika's fillOpacity
  this.textMesh.fillOpacity = normalizedOpacity;  // NaN
  this.textMesh.outlineOpacity = normalizedOpacity;  // NaN

  // Apply to character meshes if in per-character mode
  for (const charMesh of this.characterMeshes) {
    charMesh.fillOpacity = normalizedOpacity;  // NaN
    charMesh.outlineOpacity = normalizedOpacity;  // NaN
  }
}
```

## Proof of Failure
```typescript
const textLayer = new TextLayer(layerData, resources);

// NaN comparison behavior:
console.log(Math.min(100, NaN));  // NaN - NOT 100!
console.log(Math.max(0, NaN));   // NaN - NOT 0!
console.log(Math.max(0, Math.min(100, NaN)));  // NaN

// Attack: opacity = NaN (from bad animation interpolation)
textLayer.applyOpacity(NaN);
// normalizedOpacity = NaN / 100 = NaN
// this.textMesh.fillOpacity = NaN
// Troika behavior with NaN opacity: undefined
// Text may be invisible or render incorrectly

// Could happen from:
// - Corrupt keyframe data
// - Animation expression returning NaN
// - Audio-reactive mapping producing NaN
```

## Impact
- Text becomes invisible or renders incorrectly with NaN opacity
- Troika behavior with NaN fillOpacity is undefined
- Low severity: Requires NaN input, most callers provide valid values
- Same pattern as BUG-092 (BaseLayer.applyOpacity)

## Related
- BUG-092: BaseLayer.applyOpacity NaN propagation (same pattern)
- BUG-108: SplineLayer Math.min/max NaN bypass
- SYSTEMIC-005: NaN bypass via comparison operators
- 14A: Numeric inputs - NaN testing

## Suggested Fix
```typescript
protected override applyOpacity(opacity: number): void {
  // Guard against NaN
  if (!Number.isFinite(opacity)) {
    opacity = 100;  // Default to fully opaque
  }

  const normalizedOpacity = Math.max(0, Math.min(100, opacity)) / 100;

  this.textMesh.fillOpacity = normalizedOpacity;
  this.textMesh.outlineOpacity = normalizedOpacity;

  for (const charMesh of this.characterMeshes) {
    charMesh.fillOpacity = normalizedOpacity;
    charMesh.outlineOpacity = normalizedOpacity;
  }
}
```
