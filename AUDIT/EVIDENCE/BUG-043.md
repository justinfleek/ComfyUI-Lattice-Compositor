# BUG-043: NaN/Infinity Parameter Values Stored Without Validation

## Summary
The `updateEffectParameter()` function accepts `value: any` and stores it directly without validation. NaN or Infinity values are stored in effect parameters and later corrupt rendering when effect renderers use them for calculations (blur radius, color values, etc.).

## Severity: LOW

## Location
- File: /ui/src/stores/actions/effectActions.ts
- Lines: 70, 78
- Function: updateEffectParameter

## The Bug
```typescript
export function updateEffectParameter(
  store: EffectStore,
  layerId: string,
  effectId: string,
  paramKey: string,
  value: any  // Line 70 - No validation, accepts anything
): void {
  const layer = store.getActiveCompLayers().find(l => l.id === layerId);
  if (!layer || !layer.effects) return;

  const effect = layer.effects.find(e => e.id === effectId);
  if (!effect || !effect.parameters[paramKey]) return;

  effect.parameters[paramKey].value = value;  // Line 78 - NaN/Infinity stored!
  store.project.meta.modified = new Date().toISOString();
  store.pushHistory();
}
```

## Parameters Affected
All numeric effect parameters can be corrupted:
- Blur: `blurriness`, `radius` → used in MUL_TABLE lookup (BUG-023)
- Color: `brightness`, `contrast`, `gamma` → division operations
- Distort: `amount`, `wavelength` → transform calculations
- Stylize: `glitchAmount`, `tracking` → loop bounds (BUG-033)
- Any effect with numeric parameters

## Proof of Failure
```typescript
// Expression returns NaN (e.g., 0/0 or Math.sqrt(-1))
const expressionResult = evaluateExpression("0/0");  // NaN

// Update effect parameter with NaN
updateEffectParameter(store, layerId, effectId, 'blurriness', expressionResult);
// parameter.value = NaN (stored!)

// Later, in blurRenderer.ts (line 802):
const blurriness = params.blurriness ?? 0;  // NaN ?? 0 = NaN (nullish doesn't catch NaN)
const mul = MUL_TABLE[Math.round(blurriness)];  // MUL_TABLE[NaN] = undefined
// Result: Corrupted blur output (BUG-023 triggered from here)

// Or with Infinity in stylizeRenderer.ts (line 193):
const numBlocks = Math.floor(glitchAmount * 3);  // Math.floor(Infinity * 3) = Infinity
for (let i = 0; i < numBlocks; i++) { ... }  // INFINITE LOOP (BUG-033 triggered from here)
```

## Chain of Corruption
1. Expression or API call produces NaN/Infinity
2. NaN/Infinity stored in parameter via `updateEffectParameter()`
3. Effect renderer reads parameter
4. Renderer performs invalid operation:
   - Table lookup with NaN → undefined
   - Loop with Infinity → infinite loop
   - Division/multiplication → NaN propagation
5. User sees corrupted/broken effect or frozen UI

## Impact
- Effect renders incorrectly or not at all
- Potential infinite loop (if value used as loop bound)
- No error thrown - silent visual corruption
- Low severity because NaN values require upstream expression bug
- Same pattern as BUG-041 (depthflow config)

## Suggested Fix
Validate numeric values before assignment:
```typescript
export function updateEffectParameter(
  store: EffectStore,
  layerId: string,
  effectId: string,
  paramKey: string,
  value: any
): void {
  // ... layer/effect lookup ...

  // Validate numeric values
  if (typeof value === 'number' && !Number.isFinite(value)) {
    console.warn(`Invalid ${paramKey} value: ${value}, ignoring`);
    return;
  }

  effect.parameters[paramKey].value = value;
  // ...
}
```

Or validate at the type level (preferred - see BUG-019):
```typescript
type ValidNumber = number & { __brand: 'ValidNumber' };
function validateNumber(n: number): ValidNumber | null {
  return Number.isFinite(n) ? n as ValidNumber : null;
}
```
