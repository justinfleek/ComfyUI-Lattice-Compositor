# BUG-001: Division by Zero in mathExpressions.map()

## Summary
The `map()` function in mathExpressions performs a division operation without validating that the divisor is non-zero. When `inMax === inMin`, this results in division by zero, returning NaN or Infinity.

## Severity: MEDIUM

## Location
- File: /ui/src/services/expressions/expressionEvaluator.ts
- Lines: 80-81
- Function: mathExpressions.map

## The Bug
The function calculates a mapping between input and output ranges using the formula:
```
(value - inMin) / (inMax - inMin)
```

When `inMax === inMin`, the denominator becomes zero, causing division by zero.

## Code Evidence
```typescript
// Lines 80-81
map(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number {
  return outMin + (outMax - outMin) * ((value - inMin) / (inMax - inMin));
},
```

## Impact
- Expression returns NaN or Infinity instead of a sensible value
- Animation values become corrupted
- May propagate NaN throughout the render pipeline
- User sees broken animations with no clear error message

## Suggested Fix
```typescript
map(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number {
  if (inMax === inMin) return outMin; // or (outMin + outMax) / 2
  return outMin + (outMax - outMin) * ((value - inMin) / (inMax - inMin));
},
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (Line 80-81):
map(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number {
  return outMin + (outMax - outMin) * ((value - inMin) / (inMax - inMin));
},

// AFTER (Line 80-84):
map(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number {
  const range = inMax - inMin;
  if (!Number.isFinite(range) || range === 0) return outMin;
  return outMin + (outMax - outMin) * ((value - inMin) / range);
},
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| inMin=0, inMax=0 (range=0) | NaN (div/0) | outMin ✓ |
| inMin=NaN | NaN propagates | outMin ✓ |
| inMax=Infinity | Infinity | outMin ✓ |
| inMin=0, inMax=100 (valid) | correct mapping | correct mapping ✓ |

### Pattern Used
SYSTEMIC-003: Division by zero - inline validation with `Number.isFinite()` check
