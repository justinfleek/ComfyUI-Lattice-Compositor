# BUG-020: Division by Zero in Audio Visualizer When Start Equals End Point

## Summary
The `renderAudioSpectrum()` and `renderAudioWaveform()` functions calculate perpendicular vectors by dividing by the length between start and end points. When start and end points are identical, length is 0, causing division by zero and NaN propagation through all drawing operations.

## Severity: MEDIUM

## Location
- File: /ui/src/services/effects/audioVisualizer.ts
- Lines: 127-128 (spectrum), 332-333 (waveform)
- Functions: renderAudioSpectrum, renderAudioWaveform

## The Bug
```typescript
// Lines 124-128 (renderAudioSpectrum)
const dx = endPointX - startPointX;
const dy = endPointY - startPointY;
const length = Math.sqrt(dx * dx + dy * dy);
const perpX = -dy / length;  // If length=0: -0/0 = NaN
const perpY = dx / length;   // If length=0: 0/0 = NaN

// Same pattern at lines 329-333 (renderAudioWaveform)
```

## Proof of Failure
```typescript
const params = {
  startPointX: 100,
  startPointY: 100,
  endPointX: 100,    // Same as start!
  endPointY: 100,    // Same as start!
  frequencyBands: 64,
  // ...
};

renderAudioSpectrum(input, params, 0);
// length = sqrt(0 + 0) = 0
// perpX = -0 / 0 = NaN
// perpY = 0 / 0 = NaN
// All ctx.fillRect/lineTo calls receive NaN coordinates
// Canvas draws nothing or corrupted output
```

## Impact
- Visual output completely broken when points overlap
- NaN propagates to all drawing coordinates
- No error thrown - silent visual corruption
- Could happen if user drags end point to start position

## Suggested Fix
```typescript
const length = Math.sqrt(dx * dx + dy * dy);
if (length === 0) {
  // Can't draw along a zero-length line
  return { canvas, ctx };
}
const perpX = -dy / length;
const perpY = dx / length;
```

---

## Fix Applied
**Date:** 2025-12-28
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (renderAudioSpectrum lines 126-128):
const length = Math.sqrt(dx * dx + dy * dy);
const perpX = -dy / length;  // NaN if length=0
const perpY = dx / length;   // NaN if length=0

// AFTER (lines 126-134):
const length = Math.sqrt(dx * dx + dy * dy);

// BUG-020: Guard against zero-length line (start === end point)
if (length === 0) {
  return { canvas, ctx };
}

const perpX = -dy / length;
const perpY = dx / length;

// Same fix applied to renderAudioWaveform (lines 337-345)
```

### Verification
| Scenario | Before | After |
|----------|--------|-------|
| start=(100,100), end=(100,100) | NaN in all coordinates | Early return, input unchanged ✓ |
| start=(0,0), end=(100,100) | Normal rendering | Normal rendering ✓ |
| start=(0,360), end=(1920,360) | Normal rendering | Normal rendering ✓ |

### Pattern Used
Zero-length vector guard - check length before division to avoid NaN propagation
