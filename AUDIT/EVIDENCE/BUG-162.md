# BUG-162: NormalLayer.onUpdate() and onEvaluateFrame() NaN Propagation

## Summary
onUpdate() uses Object.assign to merge data without validation. onEvaluateFrame() passes these values to shader uniforms without checking for NaN. Vector3.normalize() on NaN components produces NaN, corrupting shader lighting.

## Severity: LOW

## Location
- File: /ui/src/engine/layers/NormalLayer.ts
- Lines: 178-184 (onUpdate), 169-175 (onEvaluateFrame)
- Functions: onUpdate(), onEvaluateFrame()

## Crash Path Trace
```
Function: onUpdate(properties: Partial<Layer>)

Line 182: Object.assign(this.normalData, data);
  - data = { lightDirection: { x: NaN, y: NaN, z: NaN } }
  - NaN values merged into this.normalData

Function: onEvaluateFrame(frame: number)

Line 169-174:
  if (this.normalData.lightDirection) {
    this.material.uniforms.lightDirection.value.set(
      this.normalData.lightDirection.x,  // NaN
      this.normalData.lightDirection.y,  // NaN
      this.normalData.lightDirection.z   // NaN
    ).normalize();  // normalize() on NaN vector = NaN
  }

Test cases:
  - lightDirection.x=NaN → Vector3.set(NaN, y, z).normalize() → all components NaN
  - lightDirection={x:0, y:0, z:0} → normalize() produces NaN (zero-length vector)
  - lightIntensity=NaN → uniform lightIntensity = NaN → shader lighting fails

Result: SILENT CORRUPTION - shader uniforms contain NaN, lighting broken
```

## Code Evidence
```typescript
// Lines 178-184
protected onUpdate(properties: Partial<Layer>): void {
  const data = properties.data as Partial<NormalLayerData> | undefined;

  if (data) {
    Object.assign(this.normalData, data);  // No validation - NaN propagates
  }
}

// Lines 169-175
if (this.normalData.lightDirection) {
  this.material.uniforms.lightDirection.value.set(
    this.normalData.lightDirection.x,  // No validation
    this.normalData.lightDirection.y,  // No validation
    this.normalData.lightDirection.z   // No validation
  ).normalize();  // NaN vector → NaN result
}
```

## Impact
- NaN light direction causes shader lighting to fail
- Zero-length light direction (0,0,0) normalizes to NaN
- Normal map visualization becomes black/corrupt
- Same Object.assign pattern as other layer bugs (SYSTEMIC-005)

## Suggested Fix
```typescript
if (this.normalData.lightDirection) {
  const x = this.normalData.lightDirection.x;
  const y = this.normalData.lightDirection.y;
  const z = this.normalData.lightDirection.z;

  if (Number.isFinite(x) && Number.isFinite(y) && Number.isFinite(z)) {
    const length = Math.sqrt(x*x + y*y + z*z);
    if (length > 0.0001) {  // Avoid zero-length vector
      this.material.uniforms.lightDirection.value.set(x, y, z).normalize();
    }
  }
}
```
