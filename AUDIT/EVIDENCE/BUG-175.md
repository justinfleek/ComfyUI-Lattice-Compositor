# BUG-175: EffectLayer.onApplyEvaluatedState() NaN Opacity Propagation

## Summary
onApplyEvaluatedState() assigns opacity from the evaluated state to material.opacity without validation. When expressions return NaN for opacity, the Three.js material receives NaN opacity, producing undefined rendering behavior.

## Severity: LOW

## Location
- File: /ui/src/engine/layers/EffectLayer.ts
- Lines: 205-210
- Function: onApplyEvaluatedState()

## Crash Path Trace
```
Function: onApplyEvaluatedState(state: EvaluatedLayer)

Line 207: if (state.opacity !== undefined && this.material) {
  → state.opacity=NaN: NaN !== undefined is TRUE (proceeds)

Line 208: this.material.opacity = state.opacity / 100;
  → NaN / 100 = NaN
  → this.material.opacity = NaN

Three.js behavior with NaN opacity:
  - Material rendering becomes undefined
  - May render fully transparent, fully opaque, or corrupted
  - GPU-dependent behavior

Result: SILENT CORRUPTION (SYSTEMIC-005) - effect layer rendering undefined
```

## Code Evidence
```typescript
// Lines 205-210
protected override onApplyEvaluatedState(state: import('../MotionEngine').EvaluatedLayer): void {
  // Apply opacity to material (opacity is on EvaluatedLayer, not transform)
  if (state.opacity !== undefined && this.material) {
    this.material.opacity = state.opacity / 100;  // NaN / 100 = NaN
    this.material.needsUpdate = true;
  }
  // ...
}
```

## Impact
- Expression evaluation can return NaN for opacity
- NaN stored without validation
- Effect layer renders with undefined opacity
- Low severity as it affects visual appearance only, no crash

## Suggested Fix
```typescript
protected override onApplyEvaluatedState(state: EvaluatedLayer): void {
  if (state.opacity !== undefined && this.material) {
    if (!Number.isFinite(state.opacity)) {
      console.warn(`EffectLayer ${this.id}: invalid opacity ${state.opacity}`);
      return;
    }
    this.material.opacity = state.opacity / 100;
    this.material.needsUpdate = true;
  }
  // ...
}
```
