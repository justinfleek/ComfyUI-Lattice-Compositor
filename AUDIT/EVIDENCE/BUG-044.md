# BUG-044: NaN Frame Bypasses Keyframe Equality Check

## Summary
The `addKeyframe()` function uses `k.frame === frame` to find existing keyframes, but `NaN === NaN` is false in JavaScript. NaN frames never match, always get pushed, and accumulate indefinitely. Additionally, `sort((a, b) => a.frame - b.frame)` with NaN frames produces undefined ordering.

## Severity: LOW

## Location
- File: /ui/src/stores/actions/keyframeActions.ts
- Lines: 128, 134
- Function: addKeyframe

## The Bug
```typescript
export function addKeyframe<T>(
  store: KeyframeStore,
  layerId: string,
  propertyPath: string,
  value: T,
  atFrame?: number
): Keyframe<T> | null {
  const comp = store.getActiveComp();
  const frame = atFrame ?? (comp?.currentFrame ?? 0);  // If currentFrame is NaN, frame = NaN

  // ...

  // Line 128 - NaN comparison always fails
  const existingIndex = property.keyframes.findIndex(k => k.frame === frame);
  // NaN === NaN is FALSE in JavaScript
  // existingIndex will always be -1 for NaN frames

  if (existingIndex >= 0) {
    property.keyframes[existingIndex] = keyframe;  // Never executes for NaN
  } else {
    property.keyframes.push(keyframe);  // NaN keyframes always pushed
    property.keyframes.sort((a, b) => a.frame - b.frame);  // Line 134
    // NaN - NaN = NaN, sort comparator returns NaN = undefined ordering
  }
}
```

## Proof of Failure
```typescript
// Add keyframe at frame NaN
addKeyframe(store, layerId, 'position', {x: 100, y: 100}, NaN);
// existingIndex = -1 (NaN === NaN is false)
// Keyframe pushed with frame = NaN

// Add another keyframe at frame NaN
addKeyframe(store, layerId, 'position', {x: 200, y: 200}, NaN);
// existingIndex = -1 again (NaN === NaN still false)
// Second NaN keyframe pushed - now array has TWO NaN keyframes

// After multiple calls:
// property.keyframes = [
//   { frame: 0, ... },
//   { frame: NaN, ... },  // Can't be found or removed
//   { frame: NaN, ... },  // Duplicate
//   { frame: NaN, ... },  // Accumulates
//   { frame: 30, ... }
// ]

// Sort with NaN:
// 0 - NaN = NaN → comparator returns NaN → undefined order
// Result: Array order is implementation-dependent, may be wrong
```

## Same Pattern As
- BUG-036: NaN keyframe accumulation in cameraActions.ts

## Impact
- NaN keyframes accumulate indefinitely (memory growth)
- NaN keyframes cannot be found, updated, or removed
- Sort produces undefined ordering when NaN frames present
- Interpolation fails with NaN keyframes
- Low severity because NaN frame requires upstream bug

## Suggested Fix
Validate frame before using:
```typescript
export function addKeyframe<T>(
  store: KeyframeStore,
  layerId: string,
  propertyPath: string,
  value: T,
  atFrame?: number
): Keyframe<T> | null {
  const comp = store.getActiveComp();
  const frame = atFrame ?? (comp?.currentFrame ?? 0);

  // Validate frame
  if (!Number.isFinite(frame)) {
    storeLogger.warn('addKeyframe: Invalid frame number', frame);
    return null;
  }

  // ... rest of function
}
```
