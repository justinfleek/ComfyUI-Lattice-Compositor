# BUG-016: NaN Propagation with Negative Gravity in bounce()

## Summary
The `bounce()` function uses `Math.sqrt(2 * bounceHeight / gravity)` without validating that gravity is positive. Negative gravity produces NaN via square root of negative number, which propagates through all calculations.

## Severity: LOW

## Location
- File: /ui/src/services/expressions/motionExpressions.ts
- Lines: 117, 127
- Function: bounce

## The Bug
```typescript
// Line 117
const bounceDuration = Math.sqrt(2 * bounceHeight / gravity);
// If gravity = -4000: Math.sqrt(2 * 1 / -4000) = Math.sqrt(-0.0005) = NaN
```

The while loop condition (line 116) doesn't catch NaN:
```typescript
while (bounceTime > 0 && totalBounces < maxBounces) {
  const bounceDuration = Math.sqrt(2 * bounceHeight / gravity);  // NaN
  if (bounceTime < bounceDuration * 2) {  // NaN comparison is FALSE
    break;  // Never breaks!
  }
  bounceTime -= bounceDuration * 2;  // NaN
  // Loop continues with NaN until maxBounces=10
}
```

## Proof of Failure
```typescript
const ctx = {
  time: 2,
  fps: 30,
  keyframes: [{ frame: 0, value: 100 }, { frame: 30, value: 200 }],
  value: 200,
  velocity: 0
};

const result = bounce(ctx, 0.7, -4000);  // Negative gravity
console.log(result);  // NaN
```

## Impact
- Returns NaN instead of number
- Animation values become corrupted
- NaN propagates to downstream calculations
- Low severity because negative gravity is unusual input

## Suggested Fix
```typescript
if (gravity <= 0) {
  console.warn('[Expressions] bounce() requires positive gravity');
  return value;
}
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// ADDED after line 86 (after const { time, keyframes, value } = ctx):
// Guard against invalid gravity (BUG-016: sqrt of negative)
if (!Number.isFinite(gravity) || gravity <= 0) {
  console.warn('[Expressions] bounce() requires positive gravity');
  return value;
}
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| gravity=-4000 | NaN (sqrt of negative) | value + warning ✓ |
| gravity=0 | Infinity (div/0) | value + warning ✓ |
| gravity=NaN | NaN propagates | value + warning ✓ |
| gravity=4000 (valid) | Normal bounce | Normal bounce ✓ |

### Pattern Used
Math domain error - validate inputs before operations with domain restrictions (sqrt)
