# BUG-007: Division by Zero in posterizeTime()

## Summary
The `posterizeTime()` function divides by `framesPerSecond` without checking if it's zero, which would cause a division by zero error.

## Severity: LOW

## Location
- File: /ui/src/services/expressions/audioExpressions.ts
- Lines: 107
- Function: posterizeTime

## The Bug
The function calculates the interval between samples as `1 / framesPerSecond`. If the user passes 0 as the framesPerSecond parameter, this causes division by zero, returning Infinity.

## Code Evidence
```typescript
// Lines 106-107
export function posterizeTime(ctx: ExpressionContext, framesPerSecond: number): number {
  const { time } = ctx;

  // Calculate the interval between samples
  const interval = 1 / framesPerSecond;  // Division by zero if framesPerSecond === 0
  ...
}
```

## Impact
- Returns Infinity when framesPerSecond is 0
- Subsequent calculations with Infinity produce unexpected results
- Animation values become corrupted
- Low severity because user must explicitly pass 0

## Suggested Fix
```typescript
export function posterizeTime(ctx: ExpressionContext, framesPerSecond: number): number {
  const { time } = ctx;

  if (framesPerSecond <= 0) return time; // Guard against invalid input

  const interval = 1 / framesPerSecond;
  ...
}
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (Lines 100-113):
export function posterizeTime(
  ctx: ExpressionContext,
  framesPerSecond: number
): number {
  const { time } = ctx;
  const interval = 1 / framesPerSecond;
  const quantizedTime = Math.floor(time / interval) * interval;
  return quantizedTime;
}

// AFTER (Lines 100-118):
export function posterizeTime(
  ctx: ExpressionContext,
  framesPerSecond: number
): number {
  const { time } = ctx;

  // Guard against invalid framesPerSecond (BUG-007: division by zero)
  if (!Number.isFinite(framesPerSecond) || framesPerSecond <= 0) {
    return time; // Passthrough: return original time unchanged
  }

  const interval = 1 / framesPerSecond;
  const quantizedTime = Math.floor(time / interval) * interval;
  return quantizedTime;
}
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| framesPerSecond=0 | NaN (Infinity math) | time ✓ |
| framesPerSecond=-5 | NaN (negative interval) | time ✓ |
| framesPerSecond=NaN | NaN propagates | time ✓ |
| framesPerSecond=Infinity | 0 (collapses) | time ✓ |
| framesPerSecond=12 (valid) | Quantized time | Quantized time ✓ |

### Pattern Used
SYSTEMIC-003: Division by zero - guard with `Number.isFinite()` and `<= 0` check
