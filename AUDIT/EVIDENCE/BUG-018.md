# BUG-018: vectorClamp Silently Clamps to 0 for Missing Max Values

## Summary
The `vectorClamp()` function uses `|| 0` for missing array elements in `min` and `max` arrays. When `max` array is shorter than `vec`, missing max values default to 0, causing values to be clamped to 0 instead of passing through.

## Severity: MEDIUM

## Location
- File: /ui/src/services/expressions/vectorMath.ts
- Lines: 145-150
- Function: vectorClamp

## The Bug
```typescript
export function vectorClamp(vec: number[], min: number | number[], max: number | number[]): number[] {
  return vec.map((v, i) => {
    const minVal = Array.isArray(min) ? (min[i] || 0) : min;
    const maxVal = Array.isArray(max) ? (max[i] || 0) : max;  // || 0 is WRONG for max!
    return Math.max(minVal, Math.min(maxVal, v));
  });
}
```

When `max` is an array shorter than `vec`, `max[i]` returns `undefined`, and `undefined || 0` becomes `0`.

## Proof of Failure
```typescript
const result = vectorClamp([5, 6, 7], 0, [10]);
// Expected: [5, 6, 7] (values within 0-10, so unchanged)
// Actual: [5, 0, 0]

// Trace:
// i=0: min=0, max=10, clamp(5) = 5 ✓
// i=1: min=0, max=(undefined||0)=0, clamp(6 to 0-0) = 0 ✗
// i=2: min=0, max=(undefined||0)=0, clamp(7 to 0-0) = 0 ✗
```

## Impact
- Values silently clamped to 0 instead of intended maximum
- Breaks animations/positions when clamp arrays don't match vector length
- Medium severity because it's silent data corruption

## Suggested Fix
For max values, default to Infinity (no upper bound) instead of 0:
```typescript
const maxVal = Array.isArray(max) ? (max[i] ?? Infinity) : max;
```

Or use nullish coalescing with a sensible default:
```typescript
const minVal = Array.isArray(min) ? (min[i] ?? -Infinity) : min;
const maxVal = Array.isArray(max) ? (max[i] ?? Infinity) : max;
```

---

## Fix Applied
**Date:** 2025-12-27
**Fixed by:** Claude (Forensic Audit)

### Code Change
```typescript
// BEFORE (lines 145-150):
export function vectorClamp(vec: number[], min: number | number[], max: number | number[]): number[] {
  return vec.map((v, i) => {
    const minVal = Array.isArray(min) ? (min[i] || 0) : min;
    const maxVal = Array.isArray(max) ? (max[i] || 0) : max;
    return Math.max(minVal, Math.min(maxVal, v));
  });
}

// AFTER (lines 144-152):
export function vectorClamp(vec: number[], min: number | number[], max: number | number[]): number[] {
  // BUG-018: Use ?? with Infinity defaults for missing array elements
  // || 0 was wrong - caused values to be clamped to 0 instead of passing through
  return vec.map((v, i) => {
    const minVal = Array.isArray(min) ? (min[i] ?? -Infinity) : min;
    const maxVal = Array.isArray(max) ? (max[i] ?? Infinity) : max;
    return Math.max(minVal, Math.min(maxVal, v));
  });
}
```

### Verification
| Input | Before | After |
|-------|--------|-------|
| `vectorClamp([5,6,7], 0, [10])` | `[5, 0, 0]` (max defaults to 0) | `[5, 6, 7]` (max defaults to Infinity) ✓ |
| `vectorClamp([5,6,7], [0], 10)` | `[5, 6, 7]` (min 0 OK) | `[5, 6, 7]` ✓ |
| `vectorClamp([-1,5,100], [], [10])` | `[0, 0, 0]` (min/max 0) | `[-1, 5, 10]` (unconstrained min, clamped max) ✓ |
| `vectorClamp([5,6,7], 0, 10)` | `[5, 6, 7]` (scalars OK) | `[5, 6, 7]` ✓ |

### Pattern Used
Nullish coalescing with semantically correct defaults - `?? -Infinity` for min (no lower bound), `?? Infinity` for max (no upper bound)
