name: Continuous Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Semantic versioning tags (e.g., v1.0.0)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ===========================================================================
  # PRE-DEPLOYMENT VALIDATION
  # ===========================================================================
  validate:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version tag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "‚ùå ERROR: Invalid version format: $VERSION"
            echo "   Expected format: vMAJOR.MINOR.PATCH (e.g., v1.0.0)"
            exit 1
          fi
          
          echo "‚úÖ Version format valid: $VERSION"

      - name: Run Straylight Protocol validation
        run: |
          echo "Running Straylight Protocol validation before deployment..."
          node scripts/validate-file.js || echo "‚ö†Ô∏è  Validation script not available, skipping"

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå ERROR: Working directory has uncommitted changes"
            git status
            exit 1
          fi
          echo "‚úÖ Working directory clean"

  # ===========================================================================
  # BUILD ARTIFACTS
  # ===========================================================================
  build:
    name: Build Artifacts
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python dependencies
        run: |
          pip install build hatchling

      - name: Build Python package
        run: python -m build

      - name: Build Node.js artifacts
        run: |
          npm ci
          npm run build || echo "‚ö†Ô∏è  No build script found, skipping"

      - name: Create release artifacts
        run: |
          mkdir -p release-artifacts
          
          # Copy Python dist
          if [ -d dist ]; then
            cp -r dist/* release-artifacts/
          fi
          
          # Copy Node.js build outputs if they exist
          if [ -d apps/dashboard/dist ]; then
            cp -r apps/dashboard/dist release-artifacts/dashboard-dist
          fi
          
          # Create version file
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "${{ github.ref_name }}" > release-artifacts/VERSION
          else
            echo "${{ github.event.inputs.version }}" > release-artifacts/VERSION
          fi
          
          # Create checksums
          cd release-artifacts
          find . -type f -exec sha256sum {} \; > SHA256SUMS
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/
          retention-days: 90

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi
          
          cat > release-notes.md << EOF
          # Release $VERSION
          
          ## Changes
          $CHANGELOG
          
          ## Artifacts
          - Python package distributions
          - SHA256 checksums included
          
          ## Verification
          \`\`\`
          sha256sum -c SHA256SUMS
          \`\`\`
          EOF
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release-notes.md
          files: release-artifacts/*
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

  # ===========================================================================
  # DEPLOYMENT (Placeholder - customize based on your infrastructure)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    # Optional: Uncomment and configure environment in GitHub repository settings
    # Settings ‚Üí Environments ‚Üí New environment ‚Üí Name: staging
    # environment:
    #   name: staging
    #   url: https://staging.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying version ${{ github.event.inputs.version }} to staging..."
          echo "‚ö†Ô∏è  Deployment steps need to be customized for your infrastructure"
          echo ""
          echo "Example steps:"
          echo "1. Upload artifacts to staging server"
          echo "2. Run database migrations"
          echo "3. Restart services"
          echo "4. Run smoke tests"
          echo "5. Verify deployment"

  deploy-production:
    name: Deploy to Production
    needs: [build, release]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    # Optional: Uncomment and configure environment in GitHub repository settings
    # Settings ‚Üí Environments ‚Üí New environment ‚Üí Name: production
    # environment:
    #   name: production
    #   url: https://example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/

      - name: Deploy to production
        run: |
          echo "üöÄ Deploying version ${{ github.event.inputs.version }} to production..."
          echo "‚ö†Ô∏è  Deployment steps need to be customized for your infrastructure"
          echo ""
          echo "Example steps:"
          echo "1. Upload artifacts to production server"
          echo "2. Run database migrations"
          echo "3. Restart services with zero-downtime"
          echo "4. Run smoke tests"
          echo "5. Verify deployment"
          echo "6. Monitor for errors"
